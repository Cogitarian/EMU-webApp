ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emulvcApp",["ui","ui.bootstrap","ngRoute"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]);var fileType={WAV:1,TEXTGRID:2,FMS:3,F0:4};angular.module("emulvcApp").service("ConfigProviderService",["$rootScope","$http",function(a,b){var c={};return c.vals={},c.httpGetConfig=function(){b.get("configFiles/defaultConfig.json").success(function(b){c.vals=b,a.$broadcast("configLoaded",b)})},c}]);var MainCtrl=angular.module("emulvcApp").controller("MainCtrl",["$scope","$modal","$log","$compile","$timeout","$window","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.cps=k,a.history=h,a.fontImage=l,a.lastkeycode="N/A",a.uttList=[],a.showDropZone=!0,a.curUserName="",a.curUtt={},a.modifiedCurSSFF=!1,a.modifiedMetaData=!1,a.lastclickedutt=null,a.shortcut=null,a.windowWidth=f.outerWidth,angular.element(f).bind("resize",function(){a.refreshTimeline(),$("#HandletiersCtrl").scope().deleteEditArea(),a.windowWidth=f.outerWidth,a.$apply("windowWidth")}),angular.element(f).bind("keyup",function(a){a.keyCode==k.vals.keyMappings.shift&&h.history(),a.keyCode==k.vals.keyMappings.alt&&h.history()}),k.httpGetConfig(),a.history.init(),$(".TimelineCtrl").ownResize(".resizer"),a.$on("configLoaded",function(){a.handleConfigLoaded()}),a.$on("connectedToWSserver",function(){a.showDropZone=!1,i.wsH.getProtocol().then(function(b){"emuLVC-websocket-protocol"===b.protocol&&"0.0.1"===b.version&&(i.wsH.getConfigFile().then(function(a){k.vals=a}),k.vals.main.develMode?a.$broadcast("newUserLoggedOn","user1"):i.wsH.getDoUserManagement().then(function(b){"YES"===b&&a.openModal("views/login.html","dialog",!0)}))})}),a.$on("fileLoaded",function(b,c,d){switch(c){case fileType.WAV:a.uttList[0].name=d.name.substr(0,d.name.lastIndexOf(".")),i.httpGetUtterence(a.uttList[0],"testData/"+a.uttList[0]+"/");break;case fileType.TEXTGRID:}console.log("data"),console.log(d)}),a.$on("newlyLoadedUttList",function(b,c){a.uttList=c,i.httpGetUtterence(a.uttList[0]),a.curUtt=a.uttList[0],g.getsubmenuOpen()||a.openSubmenu()}),a.$on("newUserLoggedOn",function(b,c){a.curUserName=c,i.wsH.getUsrUttList(c).then(function(b){i.wsH.getUtt(a.curUserName,b[0]),a.curUtt=b[0],g.getsubmenuOpen()||a.openSubmenu(),a.uttList=b})}),a.$on("saveSSFFb4load",function(){console.log("saving utt"),i.wsH.saveSSFFfile(a.curUserName,m.data[0]),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),i.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.$on("discardSSFFb4load",function(){console.log("discarding ssff changes"),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),i.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.$on("newlyLoadedAudioFile",function(b,c,d){g.curViewPort.sS=0,g.curViewPort.eS=c.Data.length,g.curViewPort.bufferLength=c.Data.length,g.setscrollOpen(0),j.wavJSO=c,a.baseName=d.substr(0,d.lastIndexOf("."))}),a.handleConfigLoaded=function(){g.getsubmenuOpen()||a.openSubmenu(),a.shortcut=Object.create(k.vals.keyMappings);for(var b in a.shortcut)a.shortcut[b]=32===a.shortcut[b]?"SPACE":8===a.shortcut[b]?"BACKSPACE":9===a.shortcut[b]?"TAB":13===a.shortcut[b]?"ENTER":27===a.shortcut[b]?"ESC":String.fromCharCode(a.shortcut[b]);k.vals.main.develMode&&(console.log("DEVEL"),i.wsH.initConnect(k.vals.main.wsServerUrl)),g.setspectroSettings(k.vals.spectrogramSettings.N,k.vals.spectrogramSettings.rangeFrom,k.vals.spectrogramSettings.rangeTo,k.vals.spectrogramSettings.dynamicRange,k.vals.spectrogramSettings.window),$(".TimelineCtrl").css("height",k.vals.colors.timelineHeight),$(".HandletiersCtrl").css("padding-top",$(".TimelineCtrl").height()+2*$(".menu").height()+"px"),k.vals.restrictions.sortLabels&&$("#allowSortable").sortable("enable"),$("#"+k.vals.signalsCanvasConfig.order[1]).insertBefore("#"+k.vals.signalsCanvasConfig.order[0]),$("#"+k.vals.signalsCanvasConfig.order[0]).insertBefore("#"+k.vals.signalsCanvasConfig.order[1])},a.renameTier=function(){void 0!==g.getcurClickTierName()?a.openModal("views/renameTier.html","dialog",!0):a.openModal("views/error.html","dialog","Rename Error",!1,"Please choose a Tier first !")},a.downloadTextGrid=function(){console.log(i.toTextGrid())},a.refreshTimeline=function(){a.$broadcast("refreshTimeline")},a.refreshScope=function(){a.$digest()},a.menuUttClick=function(b){a.modifiedCurSSFF?(a.lastclickedutt=b,a.openModal("views/saveChanges.html","dialog","Changes not Saved Warning",!0,"Changes made to: "+b.name+". Do you wish to save them?")):(a.$broadcast("loadingNewUtt"),console.log(b),i.wsH.getUtt(a.curUserName,b),a.curUtt=b)},a.menuUttSave=function(){i.wsH.saveSSFFfile(a.curUserName,m.data[0]),a.modifiedCurSSFF=!1},a.dragStart=function(){g.setdragBarActive(!0)},a.dragEnd=function(){g.setdragBarActive(!1)},a.openModal=function(a,c,d,e,f){var h=!0;d&&(h="static"),g.setmodalOpen(!0);b.open({backdrop:h,keyboard:!0,backdropClick:!0,templateUrl:a,windowClass:c,controller:"ModalInstanceCtrl",resolve:{modalContent:function(){return f},modalTitle:function(){return e},windowLength:function(){return g.spectroSettings.windowLength},rangeFrom:function(){return g.spectroSettings.rangeFrom},rangeTo:function(){return g.spectroSettings.rangeTo},dynamicRange:function(){return g.spectroSettings.dynamicRange},window:function(){return g.spectroSettings.window},keyZoomIn:function(){return String.fromCharCode(k.vals.keyMappings.zoomIn)},keyZoomOut:function(){return String.fromCharCode(k.vals.keyMappings.zoomOut)},keyZoomAll:function(){return String.fromCharCode(k.vals.keyMappings.zoomAll)},keyZoomSel:function(){return String.fromCharCode(k.vals.keyMappings.zoomSel)},shiftViewPortLeft:function(){return String.fromCharCode(k.vals.keyMappings.shiftViewPortLeft)},shiftViewPortRight:function(){return String.fromCharCode(k.vals.keyMappings.shiftViewPortRight)},currentTier:function(){return""!==g.getcurClickTierName()?g.getcurClickTierName():"error"}}})},a.changingMetaData=function(){a.modifiedMetaData=!0},a.changingSSFFdata=function(){a.modifiedCurSSFF=!0},a.uttIsDisabled=function(b){return b.name===a.curUtt.name?!1:!0},a.getUttColor=function(b){var c;return c=a.modifiedCurSSFF?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curUtt.name?c:void 0},a.getMetaBtnColor=function(){if(a.modifiedMetaData)var b={color:"red"};else var b={color:"rgb(128,230,25)"};return b},a.cursorInTextField=function(){g.focusInTextField=!0},a.cursorOutOfTextField=function(){g.focusInTextField=!1},a.openSubmenu=function(){g.getsubmenuOpen()?(g.setsubmenuOpen(!1),$("#menuLeft").removeClass("cbp-spmenu-open"),$("#TimelineCtrl").removeClass("cbp-spmenu-push-toright").addClass("cbp-spmenu-push-toleft"),$("#HandletiersCtrl").removeClass("cbp-spmenu-push-toright").addClass("cbp-spmenu-push-toleft"),$("#menu").removeClass("cbp-spmenu-push-toright"),$("#menu-bottom").removeClass("cbp-spmenu-push-toright")):(g.setsubmenuOpen(!0),$("#menuLeft").addClass("cbp-spmenu-open"),$("#TimelineCtrl").removeClass("cbp-spmenu-push-toleft").addClass("cbp-spmenu-push-toright"),$("#HandletiersCtrl").removeClass("cbp-spmenu-push-toleft").addClass("cbp-spmenu-push-toright"),$("#menu").addClass("cbp-spmenu-push-toright"),$("#menu-bottom").addClass("cbp-spmenu-push-toright"));e(a.refreshTimeline,350)},a.saveMetaData=function(){i.wsH.saveUsrUttList(a.curUserName,a.uttList),a.modifiedMetaData=!1},a.openFile=function(){alert("code to open file")},a.setlastkeycode=function(b){a.lastkeycode=b},a.cmd_zoomAll=function(){g.setViewPort(0,g.curViewPort.bufferLength)},a.cmd_zoomSel=function(){g.setViewPort(g.curViewPort.selectS,g.curViewPort.selectE)},a.cmd_zoomIn=function(){g.zoomViewPort(!0)},a.cmd_zoomOut=function(){g.zoomViewPort(!1)},a.cmd_zoomLeft=function(){g.shiftViewPort(!1)},a.cmd_zoomRight=function(){g.shiftViewPort(!0)},a.cmd_playView=function(){j.playFromTo(g.curViewPort.sS,g.curViewPort.eS),g.animatePlayHead(g.curViewPort.sS,g.curViewPort.eS)},a.cmd_playSel=function(){j.playFromTo(g.curViewPort.selectS,g.curViewPort.selectE),g.animatePlayHead(g.curViewPort.selectS,g.curViewPort.selectE)},a.cmd_playAll=function(){j.playFromTo(0,j.wavJSO.Data.length),g.animatePlayHead(0,j.wavJSO.Data.length)}}]),FileCtrl=angular.module("emulvcApp").controller("FileCtrl",["$rootScope","$scope","viewState","Iohandlerservice","Soundhandlerservice","ConfigProviderService",function(a,b,c,d,e,f){function g(a){a.stopPropagation(),a.preventDefault(),b.$apply(function(){b.dropText=j,b.dropClass=""})}function h(b,c){if(c=c||"",b.isFile)b.file(function(b){var c=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();"WAV"==c&&a.$broadcast("fileLoaded",fileType.WAV,b),"TEXTGRID"==c&&a.$broadcast("fileLoaded",fileType.TEXTGRID,b)});else if(b.isDirectory){var d=b.createReader();d.readEntries(function(a){for(var d=0;d<a.length;d++)h(a[d],c+b.name+"/")})}}var i=document.getElementById("dropbox"),j="Drop your files here",k="File is not allowed",l="Parsing started";b.$on("configLoaded",function(){"server"==f.vals.main.mode&&(b.dropClass="hidden")}),b.dropText=j,i.addEventListener("dragenter",g,!1),i.addEventListener("dragleave",g,!1),i.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault();var c=a.dataTransfer&&a.dataTransfer.types&&a.dataTransfer.types.indexOf("Files")>=0;b.$apply(function(){b.dropText=c?j:k,b.dropClass=c?"over":"not-available"})},!1),i.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),b.$apply(function(){b.dropText=l,b.dropClass=""});for(var c=a.dataTransfer.items,d=0;d<c.length;d++){var e=c[d].webkitGetAsEntry();e&&h(e)}},!1)}]);angular.module("emulvcApp").directive("tier",function(){return{templateUrl:"views/tier.html",restrict:"E",link:function(a,b){function c(b,c,d){if(!$.isEmptyObject(b)&&!$.isEmptyObject(c)&&!$.isEmptyObject(d)){var f=e[0].getContext("2d");f.clearRect(0,0,e[0].width,e[0].height);var g,h,i,j;g=c.getSampleDist(e[0].width),j=a.fontImage.getTextImageTwoLines(f,b.TierName,"("+b.type+")",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor,!1),f.drawImage(j,0,0,j.width,j.height,5,0,j.width,j.height);var k=c.getcurMouseSegmentId(),l=(c.getselected(),-1);if("seg"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var m=b.events;m.forEach(function(b){if(++l,b.startSample>c.curViewPort.sS&&b.startSample<c.curViewPort.eS||b.startSample+b.sampleDur>c.curViewPort.sS&&b.startSample+b.sampleDur<c.curViewPort.eS||b.startSample<c.curViewPort.sS&&b.startSample+b.sampleDur>c.curViewPort.eS){h=c.getPos(e[0].width,b.startSample),i=c.getPos(e[0].width,b.startSample+b.sampleDur+1),f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(h,0,2,e[0].height/2),f.fillStyle=d.vals.colors.endBoundaryColor,f.fillRect(i,e[0].height/2,2,e[0].height),j=a.fontImage.getTextImage(f,b.label,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor);var g=a.fontImage.getLastImageWidth(),k=h+(i-h)/2-g/2;i-h>g&&f.drawImage(j,0,0,j.width,j.height,k,e[0].height/2-d.vals.font.fontPxSize,j.width,j.height);var m=a.fontImage.getTextImage(f,b.startSample,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),n=a.fontImage.getLastImageWidth(),o=h+(i-h)/2-n/2,p=a.fontImage.getTextImage(f,"dur: "+b.sampleDur,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),q=a.fontImage.getLastImageWidth();f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(h,e[0].height/4),f.lineTo(o+n/2,e[0].height/4),f.lineTo(o+n/2,e[0].height/4+10),f.stroke(),f.strokeStyle=d.vals.colors.endBoundaryColor,f.beginPath(),f.moveTo(i,e[0].height/4*3),f.lineTo(o+n/2,e[0].height/4*3),f.lineTo(o+n/2,e[0].height/4*3-10),f.stroke(),g>=i-h&&(f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(o+n/2,e[0].height/4+10),f.lineTo(o+n/2,e[0].height/4+30),f.stroke()),i-h>n&&f.drawImage(m,0,0,j.width,j.height,h+3,0,j.width,j.height),i-h>q&&f.drawImage(p,0,0,j.width,j.height,i-q,e[0].height/4*3-5,j.width,j.height)}})}else if("point"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var n,o;for(var p in b.events){var q=b.events[p];q.startSample>c.curViewPort.sS&&q.startSample<c.curViewPort.eS&&(n=Math.round(c.getPos(e[0].width,q.startSample)+g/2),b.TierName===c.curMouseMoveTierName&&k===c.curMouseMoveSegmentName?console.log("this is the selected boundary"):(f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(n,0,1,e[0].height/2-e[0].height/10),f.fillRect(n,e[0].height/2+e[0].height/10,1,e[0].height/2-e[0].height/10),o=f.measureText(b.events[p].label).width,f.fillStyle=d.vals.colors.labelColor,f.fillText(b.events[p].label,n-o/2+1,e[0].height/2)),f.fillStyle=d.vals.colors.startBoundaryColor,o=f.measureText(q.startSample).width,f.fillText(q.startSample,n+5,e[0].height/8))}}}}function d(a,b,c){var d=e[1].getContext("2d");d.clearRect(0,0,e[1].width,e[1].height),a.TierName===b.curClickTierName&&(d.fillStyle=c.vals.colors.selectedTierColor,d.fillRect(0,0,e[0].width,e[0].height));var f,g,h,i,j;f=b.getPos(e[1].width,b.curViewPort.selectS),g=b.getPos(e[1].width,b.curViewPort.selectE),h=b.getSampleDist(e[1].width),f===g?(i="seg"===b.curMouseMoveTierType?0:h/2,d.fillStyle=c.vals.colors.selectedBorderColor,d.fillRect(f+i,0,1,e[0].height)):(d.fillStyle=c.vals.colors.selectedAreaColor,d.fillRect(f,0,g-f,e[0].height),d.strokeStyle=c.vals.colors.selectedBorderColor,d.beginPath(),d.moveTo(f,0),d.lineTo(f,e[0].height),d.moveTo(g,0),d.lineTo(g,e[0].height),d.closePath(),d.stroke());var k=b.getcurMouseSegmentId(),l=b.getselected(),m=b.getcurClickTierName();""!==m&&a.TierName===m&&l.forEach(function(h){j=a.events[h],f=Math.round(b.getPos(e[0].width,j.startSample)),g=Math.round(b.getPos(e[0].width,j.startSample+j.sampleDur+1)),d.fillStyle=c.vals.colors.selectedSegmentColor,d.fillRect(f,0,g-f,e[0].height),d.fillStyle=c.vals.colors.startBoundaryColor}),j=a.events[k],void 0!==j&&void 0!==k&&a.TierName===b.getcurMouseTierName()&&(f=Math.round(b.getPos(e[1].width,j.startSample)),g=Math.round(b.getPos(e[1].width,j.startSample+j.sampleDur+1)),d.fillStyle=c.vals.colors.selectedBoundaryColor,d.fillRect(f,0,3,e[1].height),d.fillStyle=c.vals.colors.startBoundaryColor)}var e=b.find("canvas");a.$watch("tierDetails.data",function(){c(a.tier,a.vs,a.config)},!0),a.$watch("vs",function(){c(a.tier,a.vs,a.config),d(a.tier,a.vs,a.config)},!0),b.bind("mouseleave",function(){a.vs.setcurMouseSegmentId(void 0),d(a.tier,a.vs,a.config)}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.tier)||$.isEmptyObject(a.vs)||c(a.tier,a.vs,a.config)}),a.updateView=function(){c(a.tier,a.vs,a.config)}}}}),angular.module("emulvcApp").directive("osci",function(){return{templateUrl:"views/osci.html",restrict:"E",link:function(a,b){function c(a,b){var c=a.vs,d=i.getContext("2d");d.clearRect(0,0,h.width,h.height);var e=c.getPos(i.width,c.playHeadAnimationInfos.sS),g=c.getPos(i.width,c.playHeadAnimationInfos.curS);d.fillStyle=a.config.vals.colors.selectedAreaColor,d.fillRect(e,0,g-e,h.height),f(a,b,!1)}function d(a,b,c){return a.measureText(b).width*c}function e(a,b,c,e){return b.toString().length>c.toString().length?d(a,b,e):d(a,c,e)}function f(a,b,c){var f=a.vs,g=i.getContext("2d");c&&g.clearRect(0,0,i.width,i.height),g.strokeStyle=b.vals.colors.labelColor,g.fillStyle=b.vals.colors.labelColor,g.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,g.beginPath(),g.moveTo(0,0),g.lineTo(5,5),g.moveTo(i.width,0),g.lineTo(i.width-5,5),g.closePath(),g.stroke();{var h,j,k,l=g.canvas.width/g.canvas.offsetWidth;g.canvas.height/g.canvas.offsetHeight}if(f.curViewPort){h=f.round(f.curViewPort.sS/a.shs.wavJSO.SampleRate,6),j=f.round(f.curViewPort.eS/a.shs.wavJSO.SampleRate,6),k=a.fontImage.getTextImageTwoLines(g,f.curViewPort.sS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(k,0,0,k.width,k.height,5,0,k.width,k.height);var m=e(g,f.curViewPort.eS,j,l);k=a.fontImage.getTextImageTwoLines(g,f.curViewPort.eS,j,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(k,0,0,k.width,k.height,i.width-m-5,0,k.width,k.height)}if(-1!==f.curViewPort.selectS&&-1!==f.curViewPort.selectE){var n,o=f.getPos(i.width,f.curViewPort.selectS),p=f.getPos(i.width,f.curViewPort.selectE),q=f.getSampleDist(i.width);if(f.curViewPort.selectS===f.curViewPort.selectE)n="seg"===f.curMouseMoveTierType?0:q/2,g.fillStyle=b.vals.colors.selectedBorderColor,g.fillRect(o+n,0,1,i.height),k=a.fontImage.getTextImageTwoLines(g,f.round(f.curViewPort.selectS/a.shs.wavJSO.SampleRate+1/a.shs.wavJSO.SampleRate/2,6),f.curViewPort.selectS,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(k,0,0,k.width,k.height,o+n+5,0,k.width,k.height);else{g.fillStyle=b.vals.colors.selectedAreaColor,g.fillRect(o,0,p-o,i.height),g.strokeStyle=b.vals.colors.selectedBorderColor,g.beginPath(),g.moveTo(o,0),g.lineTo(o,i.height),g.moveTo(p,0),g.lineTo(p,i.height),g.closePath(),g.stroke(),g.fillStyle=b.vals.colors.labelColor;var m=e(g,f.curViewPort.selectS,f.round(f.curViewPort.selectS/a.shs.wavJSO.SampleRate,6),l);if(k=a.fontImage.getTextImageTwoLines(g,f.curViewPort.selectS,f.round(f.curViewPort.selectS/a.shs.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(k,0,0,k.width,k.height,o-m-5,0,k.width,k.height),k=a.fontImage.getTextImageTwoLines(g,f.curViewPort.selectE,f.round(f.curViewPort.selectE/a.shs.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(k,0,0,k.width,k.height,p+5,0,k.width,k.height),m=d(g,f.round((f.curViewPort.selectE-f.curViewPort.selectS)/a.shs.wavJSO.SampleRate,6),l),p-o>m){var r=f.curViewPort.selectE-f.curViewPort.selectS-1,s=f.round((f.curViewPort.selectE-f.curViewPort.selectS)/a.shs.wavJSO.SampleRate,6),m=e(g,r,s,l);k=a.fontImage.getTextImageTwoLines(g,r,s,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(k,0,0,k.width,k.height,o+(p-o)/2-m/2,0,k.width,k.height)}}}}var g=b.find("canvas").length,h=b.find("canvas")[0],i=b.find("canvas")[g-1];a.$watch("vs.playHeadAnimationInfos",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c(a,a.config)},!0),a.$on("refreshTimeline",function(){f(a,a.config,!0)}),a.$watch("vs.curViewPort",function(b,c){if(!$.isEmptyObject(a.shs)&&!$.isEmptyObject(a.shs.wavJSO)){if(c.sS!=b.sS||c.sE!=b.sE||-1==b.selectS){var d=a.dhs.calculatePeaks(a.vs,h,a.shs.wavJSO.Data);a.dhs.osciPeaks=d,a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,h,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config)}f(a,a.config,!0)}},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0==a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1==a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2==a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"})),f(a,a.config,!0)}},!0)}}}),angular.module("emulvcApp").directive("preview",function(){return{templateUrl:"views/preview.html",restrict:"E",link:function(a,b){function c(){if(f)d(a.vs,e,a.config,g);else{{a.dhs.calculatePeaks(a.vs,e,a.shs.wavJSO.Data)}a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,e,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config),g.src=e.toDataURL("image/png"),f=!0,d(a.vs,e,a.config,g)}}function d(b,c,d,e){{var f=c.getContext("2d"),g=new Image,h=c.width/a.shs.wavJSO.Data.length*b.curViewPort.sS,i=c.width/a.shs.wavJSO.Data.length*b.curViewPort.eS;b.getSampleDist(c.width)}g.onload=function(){f.clearRect(0,0,c.width,c.height),f.drawImage(g,0,0),f.fillStyle=d.vals.colors.selectedAreaColor,f.fillRect(h,0,i-h,c.height),f.strokeStyle=d.vals.colors.selectedBorderColor,f.beginPath(),f.moveTo(h,0),f.lineTo(h,c.height),f.moveTo(i,0),f.lineTo(i,c.height),f.closePath(),f.stroke()},g.src=e.src}var e=b.find("canvas")[0],f=(b[0].id,!1),g=new Image;a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$on("cleanPreview",function(){f=!1})}}}),angular.module("emulvcApp").directive("spectro",function(){return{templateUrl:"views/spectro.html",restrict:"E",link:function(a,b){function c(){u=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width),v=f(a.vs.curViewPort.sS,a.vs.curViewPort.eS,u),null!=v?(s.clearRect(0,0,p.width,p.height),h(v),g()):k(a.vs,a.shs.wavJSO.Data)}function d(){z=null,A=0,z=new Array}function e(a,b,c,d){z[A]=new Array,z[A][0]=a,z[A][1]=b,z[A][2]=c,z[A][3]=d,++A}function f(a,b,c){for(var d=0;d<z.length;++d)if(z[d][0]==a&&z[d][1]==b&&z[d][2]==c)return d;return null}function g(){var b,c=a.vs.getPos(o.width,a.vs.curViewPort.selectS),d=a.vs.getPos(o.width,a.vs.curViewPort.selectE),e=a.vs.getSampleDist(o.width);a.vs.curViewPort.selectS==a.vs.curViewPort.selectE?(b="seg"==a.vs.curMouseMoveTierType?0:e/2,s.fillStyle=a.config.vals.colors.selectedBorderColor,s.fillRect(c+b,0,1,o.height)):(s.fillStyle=a.config.vals.colors.selectedAreaColor,s.fillRect(c,0,d-c,o.height),s.strokeStyle=a.config.vals.colors.selectedBorderColor,s.beginPath(),s.moveTo(c,0),s.lineTo(c,o.height),s.moveTo(d,0),s.lineTo(d,o.height),s.closePath(),s.stroke(),s.fillStyle=o.labelColor)}function h(a){var b=new Image;b.onload=function(){r.drawImage(b,0,0)},b.src=z[a][3]}function i(){r.fillStyle="#222",r.fillRect(0,0,o.width,o.height),r.font=a.config.vals.font.fontPxSize+"px "+a.config.vals.font.fontType,r.fillStyle="#333",r.fillText("loading...",10,25),null!=y&&(y.terminate(),y=null)}function j(){var b=new Image;u=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width),y.addEventListener("message",function(c){var d=c.data.img;b.onload=function(){r.drawImage(b,0,0,o.width,o.height,0,0,o.width,o.height),e(a.vs.curViewPort.sS,a.vs.curViewPort.eS,u,o.toDataURL("image/png")),g()},b.src=d})}function k(a,b){i(),s.clearRect(0,0,p.width,p.height),g(),l(a,b)}function l(b,c){t=Math.round((b.curViewPort.eS-b.curViewPort.sS)/o.width),y=new Worker(x);var d=c.subarray(b.curViewPort.sS,b.curViewPort.eS+3*b.spectroSettings.windowLength),e=new Float32Array(d);j(),y.postMessage({cmd:"config",N:b.spectroSettings.windowLength}),y.postMessage({cmd:"config",alpha:q}),y.postMessage({cmd:"config",freq:b.spectroSettings.rangeTo}),y.postMessage({cmd:"config",freq_low:b.spectroSettings.rangeFrom}),y.postMessage({cmd:"config",start:Math.round(b.curViewPort.sS)}),y.postMessage({cmd:"config",end:Math.round(b.curViewPort.eS)}),y.postMessage({cmd:"config",myStep:t}),y.postMessage({cmd:"config",window:b.spectroSettings.window}),y.postMessage({cmd:"config",cacheSide:0}),y.postMessage({cmd:"config",width:o.width}),y.postMessage({cmd:"config",height:o.height}),y.postMessage({cmd:"config",cacheWidth:0}),y.postMessage({cmd:"config",dynRangeInDB:b.spectroSettings.dynamicRange}),y.postMessage({cmd:"config",pixelRatio:w}),y.postMessage({cmd:"config",sampleRate:a.shs.wavJSO.SampleRate}),y.postMessage({cmd:"config",streamChannels:a.shs.wavJSO.NumChannels}),y.postMessage({cmd:"pcm",stream:e}),y.postMessage({cmd:"render"})}function m(b,c,d,e,f){if(d.vals.restrictions.drawCrossHairs){s.clearRect(0,0,c.width,c.height),s.strokeStyle=d.vals.colors.crossHairsColor,s.fillStyle=d.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&s.setLineDash([2]);var h=e.getX(f),i=e.getY(f);s.beginPath(),s.moveTo(0,i),s.lineTo(5,i+5),s.moveTo(0,i),s.lineTo(c.width,i),s.lineTo(c.width-5,i+5),s.moveTo(h,0),s.lineTo(h,c.height),s.stroke(),s.font=d.vals.font.fontPxSize+"px "+d.vals.font.fontType;var j=b.round(b.spectroSettings.rangeTo-i/c.height*b.spectroSettings.rangeTo,2),k=s.measureText(j+" Hz").width,l=Math.round(b.curViewPort.sS+h/c.width*(b.curViewPort.eS-b.curViewPort.sS)),m=b.round(b.getViewPortStartTime()+h/c.width*(b.getViewPortEndTime()-b.getViewPortStartTime()),6),n=a.fontImage.getTextImage(r,j+" Hz",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!0),o=a.fontImage.getTextImageTwoLines(r,l,m,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!1);s.drawImage(n,0,0,n.width,n.height,5,i,n.width,n.height),s.drawImage(n,0,0,n.width,n.height,c.width-5-k*(r.canvas.width/r.canvas.offsetWidth),i,n.width,n.height),s.drawImage(o,0,0,o.width,o.height,h+5,0,o.width,o.height),"Google Inc."===navigator.vendor&&s.setLineDash([0]),g()}}var n=b.find("canvas").length,o=b.find("canvas")[0],p=b.find("canvas")[n-1],q=(b[0].id,.16),r=o.getContext("2d"),s=p.getContext("2d"),t=0;window.URL=window.URL||window.webkitURL;var u,v,w=window.devicePixelRatio||1,x="scripts/workers/spectroWorker.js",y=new Worker(x),z=null,A=0;d(),b.bind("mousemove",function(b){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||m(a.vs,p,a.config,a.dhs,b)}),b.bind("mouseleave",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(s.clearRect(0,0,p.width,p.height),g())}),a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$on("newlyLoadedAudioFile",function(){console.log("clearing spectro image cache..."),d()}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()}),a.$watch("vs.spectroSettings",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(j(),d(),k(a.vs,a.shs.wavJSO.Data))},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0==a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1==a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2==a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"}))}},!0)}}});var HandletiersCtrl=angular.module("emulvcApp").controller("HandletiersCtrl",["$scope","$http","$injector","viewState","HistoryService","ConfigProviderService","Soundhandlerservice","Tierdataservice","fontScaleService",function(a,b,c,d,e,f,g,h,i){a.vs=d,a.fontImage=i,a.shs=g,a.config=f,a.testValue="",a.message="",a.myHistory=[],a.myHistoryCounter=0,a.tierDetails=h,a.sortableOptions={update:function(a,b){f.vals.restrictions.sortLabels||b.item.parent().sortable("cancel")},start:function(){a.deleteEditArea()},create:function(){$("#allowSortable").sortable("disable")},axis:"y",placeholder:"tierPlaceholder"},a.$on("newlyLoadedLabelJson",function(b,c){$.isEmptyObject(a.tierDetails.data)?a.tierDetails.data=c:(c.tiers.forEach(function(b){a.tierDetails.data.tiers.push(b)}),c.fileInfos.forEach(function(b){a.tierDetails.data.fileInfos.push(b)})),a.sortTiers()}),a.$on("loadingNewUtt",function(){a.tierDetails.data={}}),a.sortTiers=function(){var b,c=[],d=[];f.vals,f.vals.labelCanvasConfig.order.forEach(function(e){b=e.split(".")[1],a.tierDetails.data.tiers.forEach(function(e,f){e.TierName.split("_")[1]===b&&(c.push(e),d.push(a.tierDetails.data.fileInfos[f]))})}),a.tierDetails.data.tiers=c,a.tierDetails.data.fileInfos=d},a.updateAllLabels=function(){""!==a.testValue&&angular.forEach(a.tierDetails.data.events,function(b){b.label=a.testValue})},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.getTierLength=function(){return a.tierDetails.data.tiers.length},a.getTier=function(b){var c=void 0;return angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName==b&&(c=a)}),c},a.renameLabel=function(){d.isEditing()?(a.rename(d.getcurClickTierName(),d.getlastID(),$("."+d.getlasteditArea()).val()),d.deleteEditArea(),d.focusInTextField=!1):0==d.countSelected()?alert("please select a segement first!"):(d.setEditing(!0),d.openEditArea())},a.deleteEditArea=function(){d.deleteEditArea()},a.selectTier=function(b){d.isEditing()&&(a.renameLabel(),d.deleteEditArea());var c=d.getcurClickTierName();if(void 0===c)d.setcurClickTierName($("li").children()[0].id);else if(b){var e=$("li."+c).next().children()[0];void 0==e?d.setcurClickTierName($("li").children()[0].id):d.setcurClickTierName(e.id)}else{var e=$("li."+c).prev().children()[0];void 0==e?d.setcurClickTierName($("li").children()[0].id):d.setcurClickTierName(e.id)}},a.tabNext=function(){d.isEditing()&&(a.renameLabel(),d.deleteEditArea());var b=parseInt(d.getselected()[0],10);b<d.getTierLength()-1?++b:b=0,d.setlasteditArea("_"+b),d.setcurClickSegment(a.tierDetails.data.tiers[d.getselected()].events[b],b)},a.tabPrev=function(){d.isEditing()&&(a.renameLabel(),d.deleteEditArea());var b=parseInt(d.getselected()[0],10);b>0?--b:b=d.getTierLength()-1,d.setlasteditArea("_"+b),d.setcurClickSegment(a.tierDetails.data.tiers[d.getselected()].events[b],b)},a.rename=function(b,c,d){angular.forEach(a.tierDetails.data.tiers,function(a){var f=0;a.TierName==b&&angular.forEach(a.events,function(a){c==f&&(a.label=d,e.history()),++f})})},a.deleteTier=function(b){var c=0;angular.forEach(a.tierDetails.data.tiers,function(d){d.TierName==b&&a.tierDetails.data.tiers.splice(c,1),++c}),e.history()},a.renameTier=function(b){var c=!1;angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName==b&&(c=!0)}),c?a.openModal("views/error.html","dialog","Rename Error","This Tiername already exists ! Please choose another name !"):(angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName==d.getcurClickTierName()&&(a.TierName=b)}),e.history())},a.deleteSegments=function(){var b=d.getselected(),c=(b.length-1,d.getcurClickTierName());angular.forEach(a.tierDetails.data.tiers,function(a){if(a.TierName==c){for(var e in b){var f=b[e];length=a.events[f].sampleDur,a.events[f-1].sampleDur+=length/2,a.events[f+1].sampleDur+=length/2,a.events[f+1].startSample-=length/2,a.events.splice(f,1)}d.setcurClickSegment(a.events[b[0]-1],b[0]-1)}}),e.history()},a.getNearest=function(b,c){var d=parseInt(a.vs.curViewPort.sS,10)+b,e=0,f=0;return angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(f=d-a.startSample>=a.sampleDur/2?e+1:e),++e}),f},a.getEventId=function(b,c){var d=parseInt(a.vs.curViewPort.sS,10)+b,e=0,f=0;return angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(f=e),++e}),f},a.getEvent=function(b,c){var d=parseInt(a.vs.curViewPort.sS,10)+b,e=null;return angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(e=a)}),e},a.moveBorder=function(a,b){if(null!=b&&b.TierName==d.getcurMouseTierName()){var c=d.getcurMouseSegmentId();c>=1&&b.events[c-1].sampleDur+a>=1&&b.events[c].sampleDur-a>=1&&(b.events[c-1].sampleDur+=a,b.events[c].startSample+=a,b.events[c].sampleDur-=a)}},a.moveSegment=function(a,b){if(null!=b&&b.TierName==d.getcurClickTierName()){var c=d.getselected().sort();if(b.events[c[0]-1].sampleDur+a>=1&&b.events[c[c.length-1]+1].sampleDur-a>=1){b.events[c[0]-1].sampleDur+=a;for(var e=0;e<c.length;e++)b.events[c[e]].startSample+=a;b.events[c[c.length-1]+1].startSample+=a,b.events[c[c.length-1]+1].sampleDur-=a}}}}]),TimelineCtrl=angular.module("emulvcApp").controller("TimelineCtrl",["$scope","$http","$compile","viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService","Ssffdataservice",function(a,b,c,d,e,f,g,h){a.vs=d,a.shs=e,a.cps=g.vals.colors,a.config=g,a.dhs=f,a.ssffds=h,a.showSSFFOsci=!1,a.showSSFFSpectro=!1,a.$on("newlyLoadedSSFFfile",function(b,c){a.ssffds.data=[],a.ssffds.data.push(c);
for(var d in g.vals.signalsCanvasConfig.assign)"fms:fm"===g.vals.signalsCanvasConfig.assign[d]&&("osci"===d&&(a.showSSFFOsci=!0),"spec"===d&&(a.showSSFFSpectro=!0))}),a.$on("loadingNewUtt",function(){a.ssffds.data=[]}),a.resizeSpectro=function(){0==d.getscrollOpen()?d.setscrollOpen(1):d.setscrollOpen(0)},a.resizeOsci=function(){0==d.getscrollOpen()?d.setscrollOpen(2):d.setscrollOpen(0)}}]),MainCtrl=angular.module("emulvcApp").controller("ModalInstanceCtrl",["$rootScope","$scope","$modalInstance","modalTitle","modalContent","windowLength","rangeFrom","rangeTo","dynamicRange","window","currentTier","viewState","keyZoomIn","keyZoomOut","keyZoomAll","keyZoomSel","shiftViewPortLeft","shiftViewPortRight",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){b.modalContent=e,b.modalTitle=d,b.windowLength=f,b.rangeFrom=g,b.rangeTo=h,b.dynamicRange=i,b.window=j,b.currentTier=k,b.keyZoomIn=m,b.keyZoomOut=n,b.keyZoomAll=o,b.keyZoomSel=p,b.shiftViewPortLeft=q,b.shiftViewPortRight=r,b.ok=function(){l.setmodalOpen(!1),c.dismiss("cancel")},b.cancel=function(){l.setmodalOpen(!1),c.dismiss("cancel")},b.deleteSegment=function(){$("#HandletiersCtrl").scope().deleteSegments(),c.dismiss("ok")},b.cursorInTextField=function(){l.focusInTextField=!0},b.cursorOutOfTextField=function(){l.focusInTextField=!1},b.selected=function(a){return a==l.spectroSettings.window?!0:!1},b.test=function(){alert("hier")},b.deleteTier=function(a){$("#HandletiersCtrl").scope().deleteTier(a),c.dismiss("ok")},b.renameTier=function(){$("#HandletiersCtrl").scope().renameTier($("#newName").val()),c.dismiss("ok")},b.saveSpectroSettings=function(){var a=$("#windowLength").val(),b=$("#rangeFrom").val(),d=$("#rangeTo").val(),e=$("#dynamicRange").val(),f=$("#windowFunction").val();l.setspectroSettings(a,b,d,e,f),l.setmodalOpen(!1),c.dismiss("ok")},b.saveSSFF=function(){a.$broadcast("saveSSFFb4load"),l.setmodalOpen(!1),c.dismiss("ok")},b.discardSSFF=function(){a.$broadcast("discardSSFFb4load"),l.setmodalOpen(!1),c.dismiss("ok")}}]);angular.module("emulvcApp").factory("viewState",["$rootScope","Soundhandlerservice","$window","Tierdataservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,bufferLength:-1},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null},e.selected=[],e.lasteditArea=null,e.editing=!1,e.submenuOpen=!1,e.modalOpen=!1,e.scrollOpen=0,e.curClickTierName=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=void 0,e.start=null,e.loadingUtt=!1,e.curMouseSegmentId=void 0,e.dragBarActive=!1,e.focusInTextField=!1,e.updatePlayHead=function(d){b.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=d);var f=Math.ceil(d-e.start)/1e3*b.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.round(e.playHeadAnimationInfos.sS+f),b.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?a.$apply():(e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.setspectroSettings=function(a,b,c,d,f){e.spectroSettings.windowLength=parseInt(a,10),e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f)},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.selectE&&(this.curViewPort.selectE=b)},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getdragBarActive=function(){return this.dragBarActive},e.setdragBarActive=function(a){this.dragBarActive=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.getmodalOpen=function(){return this.modalOpen},e.setmodalOpen=function(a){this.modalOpen=a},e.getscrollOpen=function(){return this.scrollOpen},e.setscrollOpen=function(a){this.scrollOpen=a},e.setcurClickTierName=function(a){this.curClickTierName=a},e.getcurClickTierName=function(){return this.curClickTierName},e.setcurMouseTierName=function(a){this.curMouseTierName=a},e.getcurMouseTierName=function(){return this.curMouseTierName},e.setcurMouseSegment=function(a){this.curMouseSegment=a},e.getcurMouseSegment=function(){return this.curMouseSegment},e.setcurMouseSegmentId=function(a){this.curMouseSegmentId=a},e.getcurMouseSegmentId=function(){return this.curMouseSegmentId},e.setcurClickSegment=function(a,b){null!==a&&(this.select(a.startSample,a.startSample+a.sampleDur),this.curClickSegments=[],this.curClickSegments.push(a),this.selected=[],this.selected.push(b))},e.selectBoundry=function(){if(void 0!==this.curClickSegments){var a=this.curClickSegments[0].startSample,b=this.curClickSegments[0].startSample+this.curClickSegments[0].sampleDur;this.curClickSegments.forEach(function(c){c.startSample<=a&&(a=c.startSample),c.startSample+c.sampleDur>=b&&(b=c.startSample+c.sampleDur)}),this.select(a,b)}},e.setcurClickSegmentMultiple=function(a,b){var c=!0,d=this;this.selected.forEach(function(e){-1===d.selected.indexOf(b)&&e-1===b&&(d.selected.push(b),d.curClickSegments.push(a),c=!1),-1===d.selected.indexOf(b)&&e+1===b&&(d.selected.push(b),d.curClickSegments.push(a),c=!1)}),c&&(this.curClickSegments=[],this.curClickSegments.push(a),this.selected=[],this.selected.push(b)),this.selectBoundry()},e.getselected=function(){return this.selected},e.getcurClickSegments=function(){return this.curClickSegments},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.setlasteditArea=function(a){this.lasteditArea=a},e.getlastID=function(){return this.lasteditArea.substr(1)},e.getlasteditArea=function(){return this.lasteditArea},e.deleteEditArea=function(){null!==this.getlasteditArea()&&$("."+this.getlasteditArea()).remove(),this.editing=!1},e.countSelected=function(){return this.selected.length},e.setTierLength=function(a){this.tierLength=a},e.getTierLength=function(){return this.tierLength},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getPCMpp=function(a){var b=parseInt(this.curViewPort.sS,10),c=parseInt(this.curViewPort.eS,10);return(c-b)/a.originalEvent.srcElement.width},e.round=function(a,b){(1>b||b>14)&&alert("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},e.openEditArea=function(){var a=this.getcurClickSegments()[0],b=this.getlastID(),c=$("#"+this.getcurClickTierName()).find("canvas")[0];console.log(this.getcurClickTierName());var d=this.getPos(c.clientWidth,a.startSample)+c.offsetLeft,e=this.getPos(c.clientWidth,a.startSample+a.sampleDur)+c.offsetLeft,f=c.offsetTop,g=c.clientHeight,h=this.createEditArea(this.getcurClickTierName(),d,f,e-d,g,a.label,b);return this.createSelection($("#"+h)[0],0,$("#"+h).val().length),h},e.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},e.createEditArea=function(a,b,c,d,e,f,g){console.log(a);var h="_"+g;return $("#"+a).prepend($("<textarea>").attr({id:h,"class":h+" Label_Edit","ng-model":"message",autofocus:"true"}).css({position:"absolute","z-index":"5",left:b+2+"px",width:d-1+"px",height:e+"px",padding:"0px","vertical-align":"middle"}).text(f)),h},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.setViewPort=function(a,c){var d=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==c&&(this.curViewPort.eS=Math.round(c)),d>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),d<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.sS=d,this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=d,this.curViewPort.eS=e)},e.zoomViewPort=function(a){var b,c,e,f=this.getcurMouseTierName(),g=this.getcurMouseSegmentId();d.data.tiers.forEach(function(a){a.TierName===f&&(e=a)});var h=this.curViewPort.eS-this.curViewPort.sS;if(e&&g){var i=e.events[g].startSample;console.log(i);var j=i-this.curViewPort.sS,k=this.curViewPort.eS-i;a?(b=this.curViewPort.sS+.5*j,c=this.curViewPort.eS-.5*k):(b=this.curViewPort.sS-.5*j,c=this.curViewPort.eS+.5*k)}else a?(b=this.curViewPort.sS+~~(h/4),c=this.curViewPort.eS-~~(h/4)):(b=this.curViewPort.sS-~~(h/4),c=this.curViewPort.eS+~~(h/4));this.setViewPort(b,c)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e}]),angular.module("emulvcApp").directive("trackmouseintier",["ConfigProviderService","viewState","HistoryService",function(a,b){return{restrict:"A",link:function(c,d){function e(a){var e=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),b.deleteEditArea(),j=c.getEvent(q,c.this.tier),k=c.getEventId(q,c.this.tier),l=c.getEvent(q,c.this.tier),m=c.getEventId(q,c.this.tier),b.setlasteditArea("_"+k),b.setcurClickTierName(e),b.setcurClickSegment(j,k),b.setTierLength(c.this.tier.events.length),p=q,c.$apply()}function f(a){var f=d.parent().parent().parent()[0].id;b.getcurClickTierName()!=f&&e(a),q=i(a)*b.getPCMpp(a),b.deleteEditArea(),j=c.getEvent(q,c.this.tier),k=c.getEventId(q,c.this.tier),l=c.getEvent(q,c.this.tier),m=c.getEventId(q,c.this.tier),b.setcurClickTierName(f),b.setcurClickSegmentMultiple(j,k),b.setTierLength(c.this.tier.events.length),p=q,c.$apply()}function g(a){var e=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),j=c.getEvent(q,c.this.tier),k=c.getEventId(q,c.this.tier),b.setcurClickTierName(e),b.setlasteditArea("_"+k),b.setcurClickSegment(j,k),b.setEditing(!0),b.setTierLength(c.this.tier.events.length),b.openEditArea(),c.cursorInTextField(),p=q,c.$apply()}function h(a,e){var f=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),n=c.getEvent(q,c.this.tier),o=c.getNearest(q,c.this.tier),b.setcurMouseTierName(f),e&&(b.setcurMouseSegment(n),b.setcurMouseSegmentId(o)),p=q,c.$apply()}function i(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}{var j,k,l,m,n,o,p,q,r=d[0];r.getContext("2d")}d.bind("click",function(a){h(a,!0),e(a)}),d.bind("contextmenu",function(a){a.preventDefault(),h(a,!0),f(a)}),d.bind("dblclick",function(b){h(b,!0),a.vals.restrictions.editItemName&&g(b)}),d.bind("mousemove",function(d){var e=!0;switch(q=i(d)*b.getPCMpp(d),d.which){case 1:break;case 2:break;case 3:break;default:b.getdragBarActive()===!1&&(a.vals.restrictions.editItemBoundaries&&d.shiftKey&&(b.deleteEditArea(),c.moveBorder(Math.floor(q-p),c.this.tier),p=q,b.selectBoundry(),c.$apply(),e=!1),a.vals.restrictions.editItemSize&&d.altKey&&(b.deleteEditArea(),c.moveSegment(Math.floor(q-p),c.this.tier),p=q,b.selectBoundry(),c.$apply()))}h(d,e)}),d.bind("mousedown",function(a){h(a,!0)}),d.bind("mouseup",function(a){h(a,!0)}),d.bind("mouseout",function(a){h(a,!0)})}}}]),angular.module("emulvcApp").directive("trackmouse",function(){return{restrict:"A",link:function(a,b){function c(b){d=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),d>e?(f=d,a.vs.select(e,f)):(e=d,a.vs.select(e,f)),a.$apply()}var d,e,f;b.bind("mousedown",function(b){e=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),f=e,a.vs.select(e,e),a.$apply()}),b.bind("mousemove",function(b){switch(b.which){case 1:a.vs.getdragBarActive()||c(b)}}),b.bind("mouseup",function(b){a.vs.getdragBarActive()||c(b)})}}}),angular.module("emulvcApp").directive("handleglobalkeystrokes",["viewState","Soundhandlerservice","ConfigProviderService","HistoryService",function(a,b,c,d){return{restrict:"A",link:function(e){$(document).bind("keydown",function(f){var g=f.keyCode?f.keyCode:f.which;e.$apply(function(){if(e.setlastkeycode(g,f.shiftKey),a.focusInTextField)a.isEditing()&&(g===c.vals.keyMappings.enter&&$("#HandletiersCtrl").scope().renameLabel(),g===c.vals.keyMappings.esc&&$("#HandletiersCtrl").scope().deleteEditArea(),13===g&&(f.preventDefault(),f.stopPropagation()));else{if(g===c.vals.keyMappings.shiftViewPortLeft&&a.shiftViewPort(!1),g===c.vals.keyMappings.shiftViewPortRight&&a.shiftViewPort(!0),g===c.vals.keyMappings.zoomOut&&a.zoomViewPort(!1),g===c.vals.keyMappings.zoomSel&&a.setViewPort(a.curViewPort.selectS,a.curViewPort.selectE),g===c.vals.keyMappings.selectFirstContourCorrectionTool&&(a.curCorrectionToolNr=1),g===c.vals.keyMappings.selectSecondContourCorrectionTool&&(a.curCorrectionToolNr=2),g===c.vals.keyMappings.selectThirdContourCorrectionTool&&(a.curCorrectionToolNr=3),g===c.vals.keyMappings.selectFourthContourCorrectionTool&&(a.curCorrectionToolNr=4),g===c.vals.keyMappings.selectNoContourCorrectionTool&&(a.curCorrectionToolNr=void 0),g===c.vals.keyMappings.zoomIn&&a.zoomViewPort(!0),g===c.vals.keyMappings.playEntireFile&&(b.playFromTo(0,b.wavJSO.Data.length),a.animatePlayHead(0,b.wavJSO.Data.length)),g===c.vals.keyMappings.playAllInView&&(b.playFromTo(a.curViewPort.sS,a.curViewPort.eS),a.animatePlayHead(a.curViewPort.sS,a.curViewPort.eS)),g===c.vals.keyMappings.playSelected&&(b.playFromTo(a.curViewPort.selectS,a.curViewPort.selectE),a.animatePlayHead(a.curViewPort.selectS,a.curViewPort.selectE)),g===c.vals.keyMappings.shiftViewPortRight&&a.shiftViewPort(!0),g===c.vals.keyMappings.zoomAll&&a.setViewPort(0,a.curViewPort.bufferLength),g===c.vals.keyMappings.tierUp&&$("#HandletiersCtrl").scope().selectTier(!1),g===c.vals.keyMappings.tierDown&&$("#HandletiersCtrl").scope().selectTier(!0),g===c.vals.keyMappings.openSubmenu&&e.openSubmenu(),g===c.vals.keyMappings.spectroSettings&&e.openModal("views/spectroSettings.html","dialog"),g===c.vals.keyMappings.tab&&(f.shiftKey?$("#HandletiersCtrl").scope().tabPrev():$("#HandletiersCtrl").scope().tabNext()),g===c.vals.keyMappings.history&&d.goBackHistory()===!1&&a.getmodalOpen()===!1&&e.openModal("views/error.html","dialogSmall",!1,"History Error","No more history saved"),g===c.vals.keyMappings.backspace&&c.vals.restrictions.deleteItem){for(var h=a.getcurClickSegments(),i="",j=0;j<h.length;j++)i+=h[j].label+",";i=i.substring(0,i.length-1),e.openModal("views/deleteSegment.html","dialogSmall",!1,"Really Delete",i)}f.metaKey||(f.preventDefault(),f.stopPropagation())}})}),e.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emulvcApp").directive("delete",function(){return{restrict:"A",link:function(a,b){var c=(b[0],a.this.tier.TierName);b.bind("click",function(){a.openModal("views/deleteTier.html","dialogSmall",c,c)})}}}),angular.module("emulvcApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=c.find("canvas"),e=b.parent().children()[0],f=b.parent().children()[2],g=c.find(e),h=c.find(f),i=!0,j="Tier",k="smallTier",l="TierCanvas",m="TierMarkupCanvas",n="smallCanvas";b.bind("click",function(){i?(i=!1,c.parent().parent()[0].className=k+" ng-scope",d[0].className=l+" "+n,d[1].className=m+" "+n,a.config.vals.activeButtons.deleteSingleTier&&g.hide(),a.config.vals.activeButtons.saveSingleTier&&h.hide()):(i=!0,c.parent().parent()[0].className=j+" ng-scope",d[0].className=l,d[1].className=m,a.config.vals.activeButtons.deleteSingleTier&&g.show(),a.config.vals.activeButtons.saveSingleTier&&h.show()),a.updateView()})}}}),angular.module("emulvcApp").directive("previewtrack",function(){return{restrict:"A",link:function(a,b){function c(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var d=-1;b.bind("click",function(b){if(!$.isEmptyObject(a.shs.wavJSO)){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}),b.bind("mousedown",function(b){$.isEmptyObject(a.shs.wavJSO)||(d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width))}),b.bind("mousemove",function(b){switch(event.which){case 1:if(-1!=d){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}}),b.bind("mouseup",function(){d=-1}),b.bind("mouseout",function(){d=-1})}}}),angular.module("emulvcApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o={};return o.wsH=n,o.postSaveSSFF=function(){for(var a=h.jso2ssff(m.data[0]),d="",e=new Uint8Array(a),f=e.byteLength,g=0;f>g;g++)d+=String.fromCharCode(e[g]);var i=window.btoa(d);b({url:"index.html",method:"POST",headers:{"Content-Type":"application/json"},data:{method:"saveSSFFfile",fileURL:m.data[0].fileURL.split(c.absUrl())[1],data:i}})},o.httpGetUttJson=function(c){b.get(c).success(function(b){a.$broadcast("newlyLoadedUttList",b)})},o.httpGetLabelJson=function(c){b.get(c).success(function(b){a.$broadcast("newlyLoadedLabelJson",b)})},o.httpGetTextGrid=function(c){b.get(c).success(function(b){var c=j.toJSO(b);a.$broadcast("newlyLoadedLabelJson",c)})},o.httpGetESPS=function(c){b.get(c).success(function(b){var d=l.toJSO(b,c);a.$broadcast("newlyLoadedLabelJson",d)}).error(function(a,b){console.log("Request failed with status: "+b)})},o.httpGetAudioFile=function(c){b.get(c,{responseType:"arraybuffer"}).success(function(b){var d=i.wav2jso(b);a.$broadcast("newlyLoadedAudioFile",d,c.replace(/^.*[\\\/]/,""))}).error(function(a,b){console.log("Request failed with status: "+b)})},o.findTimeOfMinSample=function(){return 0},o.findTimeOfMaxSample=function(){return f.curViewPort.bufferLength/g.wavJSO.SampleRate},o.httpGetSSFFfile=function(c){b.get(c,{responseType:"arraybuffer"}).success(function(b){var d=h.ssff2jso(b);d.fileURL=document.URL+c,a.$broadcast("newlyLoadedSSFFfile",d,c.replace(/^.*[\\\/]/,""))})},o.httpGetUtterence=function(c){var d;d=o.findFileInUtt(c,k.vals.signalsCanvasConfig.extensions.audio),b.get(d,{responseType:"arraybuffer"}).then(function(a){var b=i.wav2jso(a.data);return b}).then(function(b){f.curViewPort.sS=0,f.curViewPort.eS=b.Data.length,f.curViewPort.bufferLength=b.Data.length,f.setscrollOpen(0),f.resetSelect(),g.wavJSO=b,a.$broadcast("cleanPreview")}).then(function(){k.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){d=o.findFileInUtt(c,a),o.httpGetSSFFfile(d)})}).then(function(){k.vals.labelCanvasConfig.order.forEach(function(a){d=o.findFileInUtt(c,a),o.httpGetESPS(d),console.log(d)})}).then(function(){console.log("history"),e.history()})},o.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},o.toTextGrid=function(a){return j.toTextGrid(a)},o}]),angular.module("emulvcApp").service("Soundhandlerservice",["$document",function(a){var b={};return b.wavJSO={},b.player=a[0].createElement("audio"),b.player.isPlaying=!1,b.setPlayerSrc=function(a){var b=this.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+b},b.resetPlayerSrcFromTo=function(a,b){var c=this.wavJSO.BitsPerSample/8,d=this.wavJSO.origArrBuf.subarray(0,44),e=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*c),f=new DataView(d);f.setUint32(40,(b-a)*c,!0);var g=(f.getUint32(40,!0),e.subarray(a*c,(b-a)*c)),h=new Uint8Array(d.byteLength+g.byteLength);h.set(new Uint8Array(d),0),h.set(new Uint8Array(g),d.byteLength);var i=this.arrayBufferToBase64(h.buffer);this.player.src="data:audio/wav;base64,"+i},b.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},b.player.addEventListener("ended",function(){this.isPlaying=!1},!1),b.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},b}]),angular.module("emulvcApp").directive("drawssff",function(){return{restrict:"A",link:function(a,b){function c(a,b){var c;return a.forEach(function(a){a.Columns.forEach(function(d){d.name==b&&(c=d,c.sampleRate=a.sampleRate,c.startTime=a.startTime)})}),c}function d(a,b,c,d){var e=b.getContext("2d");e.clearRect(0,0,b.width,b.height);var f=c.vals.spectrogramSettings.rangeFrom,g=c.vals.spectrogramSettings.rangeTo,h=a.getViewPortStartTime(),i=a.getViewPortEndTime(),j=Math.round(h*d.sampleRate+d.startTime),k=Math.round(i*d.sampleRate+d.startTime),l=k-j,m=d.values.slice(j,j+l);if(l<b.width&&l>=2){var n,o,p,q,r,s;m.forEach(function(c,l){c.forEach(function(t,u){if(r=j+l,s=1/d.sampleRate*r+d.startTime,n=(s-h)/(i-h)*b.width,o=b.height-(t-f)/(g-f)*b.height,l===a.curPreselColumnSample&&a.curCorrectionToolNr-1===u?(e.strokeStyle="white",e.fillStyle="white"):(e.strokeStyle="hsl("+u*(360/c.length)+",80%, 50%)",e.fillStyle="hsl("+u*(360/c.length)+",80%, 50%)"),e.beginPath(),e.arc(n,o-1,2,0,2*Math.PI,!1),e.closePath(),e.stroke(),e.fill(),0!==l){if(r=j+l-1,s=1/d.sampleRate*r+d.startTime,p=(s-h)/(i-h)*b.width,q=b.height-(m[l-1][u]-f)/(g-f)*b.height,a.curCorrectionToolNr-1===u&&(e.strokeStyle="white",e.fillStyle="white"),e.beginPath(),e.moveTo(p,q),e.lineTo(n,o),e.stroke(),e.fill(),l===m.length-1&&k!==d.values.length-1){var v=d.values[k+1];t=v[u],r=k+1,s=1/d.sampleRate*r+d.startTime;var w=(s-h)/(i-h)*b.width,x=b.height-(t-f)/(g-f)*b.height;e.beginPath(),e.moveTo(n,o),e.lineTo(w,x),e.stroke(),e.fill()}}else if(0!==j){var y=d.values[j-1];t=y[u],r=j-1,s=1/d.sampleRate*r+d.startTime,p=(s-h)/(i-h)*b.width,q=b.height-(t-f)/(g-f)*b.height,a.curCorrectionToolNr-1===u&&(e.strokeStyle="white",e.fillStyle="white"),e.beginPath(),e.moveTo(p,q),e.lineTo(n,o),e.stroke(),e.fill()}})})}else{e.strokeStyle="red";var t,u;2>=l?(t="Zoom out to see contour(s)",u=e.measureText(t).width,e.strokeText(t,b.width/2-u/2,b.height/2)):(t="Zoom in to see contour(s)",u=e.measureText(t).width,e.strokeText(t,b.width/2-u/2,b.height/2))}}var e=b[0];a.$watch("vs.curViewPort",function(b,f){if(!($.isEmptyObject(a.ssffds.data)||0===a.ssffds.data.length||a.vs.loadingUtt||f.sS==b.sS&&f.eS==b.eS)){var g=a.config.vals.signalsCanvasConfig.assign.spec.split(":"),h=g[1],i=c(a.ssffds.data,h);d(a.vs,e,a.config,i)}},!0),a.$watch("vs.curPreselColumnSample",function(){if(!$.isEmptyObject(a.ssffds.data)&&0!==a.ssffds.data.length){var b=a.config.vals.signalsCanvasConfig.assign.spec.split(":"),f=b[1],g=c(a.ssffds.data,f);d(a.vs,e,a.config,g)}},!0),a.$watch("vs.curCorrectionToolNr",function(){if(!$.isEmptyObject(a.ssffds.data)&&0!==a.ssffds.data.length){var b=a.config.vals.signalsCanvasConfig.assign.spec.split(":"),f=b[1],g=c(a.ssffds.data,f);d(a.vs,e,a.config,g)}},!0),a.$watch("ssffds.data",function(){if(!$.isEmptyObject(a.ssffds.data)&&0!==a.ssffds.data.length){var b=a.config.vals.signalsCanvasConfig.assign.spec.split(":"),f=b[1],g=c(a.ssffds.data,f);d(a.vs,e,a.config,g)}},!0)}}}),angular.module("emulvcApp").service("Ssffparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.ssff2jso=function(a){var c=this;b.ssffData.Columns=[];var d=new Uint8Array(a),e=String.fromCharCode.apply(null,d),f=e.split(/^/m);(f[0]!==c.headID||f[1]!==c.machineID)&&alert("no ssff file... or missing fields"),"Record_Freq "!==f[2].split(/[ ,]+/)[0]||"Start_Time "!==f[3].split(/[ ,]+/)[0]?(this.ssffData.sampleRate=parseFloat(f[2].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,"")),this.ssffData.startTime=parseFloat(f[3].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))):alert("no ssff file... or missing fields ");for(var g=4;g<f.length&&("Original_Freq"===f[g].split(/[ ,]+/)[0]&&(this.ssffData.origFreq=parseFloat(f[g].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),f[g]!==this.sepString);g++){var h=f[g].split(/[ ]+/);"Column"===h[0]&&this.ssffData.Columns.push({name:h[1],ssffdatatype:h[2],length:parseInt(h[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[]})}for(var i,j,k,l=f.slice(0,g+1).join("").length;l<=d.length;)for(g=0;g<this.ssffData.Columns.length;g++)"DOUBLE"===this.ssffData.Columns[g].ssffdatatype?(k=8*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Float64Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):"FLOAT"===this.ssffData.Columns[g].ssffdatatype?(k=4*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Float32Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):"SHORT"===this.ssffData.Columns[g].ssffdatatype?(k=2*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Uint16Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):alert("not supported... only doubles, floats, short  column types and for now");return this.ssffData},b.jso2ssff=function(a){var b=this,c=this.headID+this.machineID;c+="Record_Freq "+this.vs.round(a.sampleRate,1)+"\n",c+="Start_Time "+a.startTime+"\n",a.Columns.forEach(function(a){c+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),c+="Original_Freq DOUBLE "+this.vs.round(a.origFreq,1)+"\n",c+=this.sepString;var d,e,f=new Uint8Array(this.stringToUint(c));return d=new Uint16Array(a.Columns[0].length),e=a.Columns[0].values[0],a.Columns[0].values.forEach(function(c,e){a.Columns.forEach(function(a){if("SHORT"!==a.ssffdatatype)return alert("Only SHORT columns supported for now!!!"),void 0;d=new Uint16Array(a.length),a.values[e].forEach(function(a,b){d[b]=a});var c=new Uint8Array(d.buffer);f=b.Uint8Concat(f,c)})}),f.buffer},b.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},b.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},b}]),angular.module("emulvcApp").directive("correctiontool",function(){return{restrict:"A",link:function(a,b){b[0];b.bind("mousemove",function(b){if(void 0!==a.vs.curCorrectionToolNr){var c=a.ssffds.data[0].Columns[0],d=a.vs.getViewPortStartTime(),e=a.vs.getViewPortEndTime(),f=Math.round(d*c.sampleRate+c.startTime),g=Math.round(e*c.sampleRate+c.startTime),h=g-f,i=c.values.slice(f,f+h),j=d+a.dhs.getX(b)/b.originalEvent.srcElement.width*(e-d),k=Math.round((j+c.startTime)*c.sampleRate);a.vs.curPreselColumnSample=k-f-1,b.shiftKey&&(i[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]=a.vs.spectroSettings.rangeTo-a.dhs.getY(b)/b.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo,a.changingSSFFdata()),a.$apply()}})}}}),angular.module("emulvcApp").service("Drawhelperservice",function(){function a(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=a.curViewPort.eS-a.curViewPort.sS,j=a.curCursorPosInPercent*a.bufferLength-a.curViewPort.sS,k=j/i,l=f.width*k,m=1,n=Math.round(c*(f.height/d)),o=b*m,p=Math.round((f.height-n)/2),q=Math.round(e*(f.height/d)),r=(b-1)*m,s=Math.round((f.height-q)/2);l>=o?(h.fillStyle=g.vals.colors.playProgressColor,h.strokeStyle=g.vals.colors.playProgressColor):(h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor),h.beginPath(),h.moveTo(r,s),h.lineTo(o,p),h.stroke()}var b={};return b.osciPeaks=[],b.getX=function(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)},b.getY=function(a){return a.offsetY*(a.originalEvent.srcElement.height/a.originalEvent.srcElement.clientHeight)},b.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=-1/0,o=0,p=0,q=m.length;q>p;p++)m[p]>n&&(n=m[p]),o+=m[p];k+=o/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},b.freshRedrawDrawOsciOnCanvas=function(b,c,d,e,f){var g=c.getContext("2d");if(g.clearRect(0,0,c.width,c.height),d.peaks&&d.samplePerPx>=1)d.peaks.forEach(function(e,g){0!==g&&a(b,g,e,d.maxPeak,d.peaks[g-1],c,f)});else if(d.samplePerPx<1){{var h=1/d.samplePerPx/2;b.curViewPort.sS}g.strokeStyle=f.vals.colors.osciColor,g.fillStyle=f.vals.colors.osciColor;var i;if(0===b.curViewPort.sS){for(g.moveTo(h,(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),i=0;i<d.peaks.length;i++)g.lineTo(i/d.samplePerPx+h,(d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height);for(g.stroke(),i=0;i<d.peaks.length;i++)g.beginPath(),g.arc(i/d.samplePerPx+h,(d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill()}else{for(g.moveTo(-h,c.height-(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),i=1;i<d.peaks.length;i++)g.lineTo(i/d.samplePerPx-h,c.height-((d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height+3));for(g.stroke(),i=1;i<d.peaks.length;i++)g.beginPath(),g.arc(i/d.samplePerPx-h,c.height-(d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill()}}if(g.strokeStyle=f.vals.colors.zeroLineColor,g.fillStyle=f.vals.colors.zeroLineColor,"Google Inc."==navigator.vendor&&g.setLineDash([2]),d.samplePerPx>=1)g.beginPath(),g.moveTo(0,c.height/2),g.lineTo(c.width,c.height/2),g.stroke(),g.fillText("0",5,c.height/2-5,c.width);else{var j=c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height;g.beginPath(),g.moveTo(0,j),g.lineTo(c.width,j),g.stroke(),g.fill(),g.fillText("0",5,c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-5,c.width)}"Google Inc."==navigator.vendor&&g.setLineDash([0])},b}),angular.module("emulvcApp").service("HistoryService",["Ssffdataservice","Tierdataservice",function(a,b){var c={};
return c.myHistory=new Array,c.myHistoryCounter=0,c.session=void 0,c.init=function(){c.history()},c.history=function(){var d=angular.copy({ssff:a.getData(),tier:b.getData()});if(c.myHistoryCounter>0){var e=angular.copy(c.myHistory[c.myHistoryCounter-1]);angular.equals(d,e)===!1&&(c.myHistory[c.myHistoryCounter]=d,++c.myHistoryCounter)}else c.myHistory[c.myHistoryCounter]=d,++c.myHistoryCounter},c.goBackHistory=function(){return c.myHistoryCounter>1?(a.setData(c.myHistory[c.myHistoryCounter-2].ssff),b.setData(c.myHistory[c.myHistoryCounter-2].tier),--c.myHistoryCounter,!0):!1},c}]),angular.module("emulvcApp").service("Wavparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.wav2jso=function(a){{var b,c,d,e={};new Uint8Array(a),new DataView(a)}return b=0,c=a.subarray(b,4),d=new Uint8Array(c),e.ChunkID=String.fromCharCode.apply(null,d),"RIFF"!==e.ChunkID&&alert("Wav read error: ChunkID not RIFF. Got "+e.ChunkID),b=4,c=a.subarray(b,4),d=new Uint32Array(c),e.ChunkSize=d[0],b=8,c=a.subarray(b,4),d=new Uint8Array(c),e.Format=String.fromCharCode.apply(null,d),"WAVE"!==e.Format&&alert("Wav read error: Format not WAVE. Got "+e.Format),b=12,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk1ID=String.fromCharCode.apply(null,d),"fmt "!==e.Subchunk1ID&&alert("Wav read error: Subchunk1ID not fmt. Got "+e.Subchunk1ID),b=16,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk1Size=d[0],16!==e.Subchunk1Size&&alert("Wav read error: Subchunk1Size not 16"),b=20,c=a.subarray(b,2),d=new Uint16Array(c),e.AudioFormat=d[0],1!==e.AudioFormat&&alert("Wav read error: AudioFormat not 1"),b=22,c=a.subarray(b,2),d=new Uint16Array(c),e.NumChannels=d[0],1!==e.NumChannels&&alert("Wav read error: NumChannels not 1"),b=24,c=a.subarray(b,4),d=new Uint32Array(c),e.SampleRate=d[0],b=28,c=a.subarray(b,4),d=new Uint32Array(c),e.ByteRate=d[0],b=32,c=a.subarray(b,2),d=new Uint16Array(c),e.BlockAlign=d[0],b=34,c=a.subarray(b,2),d=new Uint16Array(c),e.BitsPerSample=d[0],16!==e.BitsPerSample&&alert("Wav read error: NumChannels not 1"),b=36,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk2ID=String.fromCharCode.apply(null,d),"data"!==e.Subchunk2ID&&alert("Wav read error: BitsPerSample not 16"),b=40,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk2Size=d[0],b=44,c=a.subarray(b,e.Subchunk2Size),d=new Int16Array(c),e.Data=d,e.origArrBuf=a,e},b.stringToUint=function(){},b.Uint8Concat=function(){},b}]),function(a){function b(a){var b=a.pageY,c=a.pageX,d=a.originalEvent.targetTouches;return d&&(c=d[0].pageX,b=d[0].pageY),{x:c,y:b}}function c(b,c,e){return b.each(function(){var b=a(this),f=c?a(c,this).css("cursor",e):b;f.bind(h,{e:b,k:e},d)})}function d(c){var d=b(c),h=function(a){return parseInt(g.css(a))||!1};return g=c.data.e,k={X:h("left")||0,Y:h("top")||0,H:h("height")||g[0].scrollHeight||0,pX:d.x,pY:d.y,k:c.data.k},a(".container").scope().dragStart(),a(document).bind(i,e).bind(j,f),!1}function e(c){var d=b(c);return g.css({height:Math.max(d.y-k.pY+k.H,0)}),a(".container").scope().refreshTimeline(),a(".HandletiersCtrl").css("padding-top",a(".TimelineCtrl").height()+2*a(".menu").height()+"px"),!1}function f(){a(".container").scope().dragEnd(),a(document).unbind(i,e).unbind(j,f)}var g,h="mousedown touchstart",i="mousemove touchmove",j="mouseup touchend",k={};a.fn.ownResize=function(a){return c(this,a,"ns-resize")}}(jQuery),angular.module("emulvcApp").service("Textgridparserservice",["Soundhandlerservice","viewState",function(a,b){var c={};return c.shs=a,c.l1='File type = "ooTextFile"',c.l2='Object class = "TextGrid"',c.toJSO=function(a){a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g,"");var b,c,d,e,f=a.split("\n"),g=!0,h={origSamplerate:this.shs.wavJSO.SampleRate,fileURI:"",tiers:[]};if(f[0].replace(/\s+/g,"")===this.l1.replace(/\s+/g,"")&&f[1].replace(/\s+/g,"")===this.l2.replace(/\s+/g,"")){for(var i=2;i<f.length;i++){var j=f[i];if("item[]:"!==j){if(!g)if(0===j.indexOf("item[")&&(b='"IntervalTier"'===f[i+1].split(/=/)[1]?"seg":"point",c=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers.push({TierName:c,type:b,events:[]})),h.tiers.length>0&&"seg"===h.tiers[h.tiers.length-1].type&&0===j.indexOf("intervals")&&0!==j.indexOf("intervals:")){var k=Math.ceil(f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate),l=Math.floor(f[i+2].split(/=/)[1]*this.shs.wavJSO.SampleRate);e=f[i+3].split(/=/)[1].replace(/"/g,""),0===k&&(k+=1),h.tiers[h.tiers.length-1].events.push({label:e,startSample:k-1,sampleDur:l-k})}else h.tiers.length>0&&"point"===h.tiers[h.tiers.length-1].type&&0===j.indexOf("points")&&0!==j.indexOf("points:")&&(d=f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate,e=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers[h.tiers.length-1].events.push({label:e,startSample:Math.round(d)}))}else g=!1}return this.testForGapsInLabelJSO(h),h}alert("bad header in TextGrid file!!! The header has to be: ",this.l1,"\n",this.l2)},c.toTextGrid=function(){var b='File type = "ooTextFile"',d='Object class = "TextGrid"',e="",f="\n",g="	";e=e+b+f+d+f+f,e=e+"xmin = "+c.findTimeOfMinSample()+f,e=e+"xmax = "+c.findTimeOfMaxSample()+f,e=e+"tiers? <exists>"+f,e=e+"size = "+$("#HandletiersCtrl").scope().getTierLength()+f,e=e+"item []:"+f;var h=0;return $("#HandletiersCtrl tier").each(function(){var b=$("#HandletiersCtrl").scope().getTier($(this).attr("id"));h+=1,e=e+g+"item ["+h+"]:"+f,"seg"===b.type?e=e+g+g+'class = "IntervalTier"'+f:"point"===b.type&&(e=e+g+g+'class = "TextTier"'+f),e=e+g+g+'name = "'+b.TierName+'"'+f,e=e+g+g+"xmin = "+c.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+c.findTimeOfMaxSample()+f,"seg"===b.type?e=e+g+g+"intervals: size = "+b.events.length+f:"point"===b.type&&(e=e+g+g+"points: size = "+b.events.length+f);for(var d=0;d<b.events.length;d++){var i=d+1;"seg"===b.type?(e=e+g+g+g+"intervals ["+i+"]:"+f,e=0!==b.events[d].startSample?e+g+g+g+g+"xmin = "+(b.events[d].startSample/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmin = 0"+f,e=d<b.events.length-1?e+g+g+g+g+"xmax = "+((b.events[d].startSample+b.events[d].sampleDur+1)/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmax = "+c.findTimeOfMaxSample()+f,e=e+g+g+g+g+'text = "'+b.events[d].label+'"'+f):"point"===b.type&&(e=e+g+g+g+"points["+i+"]:"+f,e=e+g+g+g+g+"time = "+b.events[d].startSample/a.wavJSO.SampleRate+f,e=e+g+g+g+g+'mark = "'+b.events[d].label+'"'+f)}}),e},c.findTimeOfMinSample=function(){return 0},c.findTimeOfMaxSample=function(){return b.curViewPort.bufferLength/a.wavJSO.SampleRate},c.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.tiers.length;c++)if("seg"===a.tiers[c].type)for(var d=0;d<a.tiers[c].events.length-1;d++)a.tiers[c].events[d].startSample+a.tiers[c].events[d].sampleDur+1!==a.tiers[c].events[d+1].startSample&&(b+=1)},c}]),angular.module("emulvcApp").factory("uuid",function(){var a={"new":function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}return a()+a(!0)+a(!0)+a()},empty:function(){return"00000000-0000-0000-0000-000000000000"}};return a}),angular.module("emulvcApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth,i=document.createElement("canvas"),j=i.getContext("2d");return j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,15),a.lastTextWidth=j.measureText(c).width*h,i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth,k=document.createElement("canvas"),l=k.getContext("2d");if(l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,15),l.fillText(d,0,20+e);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,15),l.fillText(d,m-n,20+e)):(l.fillText(c,n-m,15),l.fillText(d,0,20+e))}return k},a}),angular.module("emulvcApp").directive("draggable",["$rootScope","uuid",function(a,b){return{restrict:"A",link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragstart",function(b){b.originalEvent.dataTransfer.setData("text",e),angular.element(d).addClass("dragDragging"),a.$emit("dragStart")}),d.bind("dragend",function(){angular.element(d).removeClass("dragDragging"),a.$emit("dragEnd")})}}}]),angular.module("emulvcApp").directive("dropable",["$rootScope","uuid",function(a,b){return{restrict:"A",scope:{onDrop:"&"},link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move",!1}),d.bind("dragenter",function(a){angular.element(a.target).addClass("dragOver")}),d.bind("dragleave",function(a){angular.element(a.target).removeClass("dragOver")}),d.bind("drop",function(a){a.preventDefault&&a.preventDefault(),a.stopPropogation&&a.stopPropogation();var b=a.originalEvent.dataTransfer.getData("text"),d=document.getElementById(e),f=document.getElementById(b);angular.element(a.target).removeClass("dragTarget"),angular.element(a.target).removeClass("dragOver"),c.drop(f,d)}),a.$on("dragStart",function(){var a=document.getElementById(e);angular.element(a).addClass("dragTarget")}),a.$on("dragEnd",function(){var a=document.getElementById(e);angular.element(a).removeClass("dragTarget"),angular.element(a).removeClass("dragOver")})}}}]),angular.module("emulvcApp").service("Espsparserservice",["Soundhandlerservice",function(a){var b={};return b.toJSO=function(b,c){var d="_"+c.split(".")[c.split(".").length-1];b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/[ \t]+/g," ");for(var e,f=b.split("\n"),g=0;g<f.length;g++)if("#"===f[g]){e=g;break}var h={fileInfos:[{fileURI:"",fileType:"esps",associatedTierNames:[d]}],tiers:[]};h.tiers.push({TierName:d,type:"",events:[]});var i,j=f[e+1].split(/\s+/);if(h.tiers[0].type="H#"!==j[j.length-1]?"point":"seg","point"===h.tiers[0].type)for(g=e+1;g<f.length-1;g++)j=f[g].split(/\s+/),h.tiers[0].events.push({label:j[j.length-1],startSample:Math.round(j[1]*a.wavJSO.SampleRate)});else for(j=f[e+1].split(/\s+/),h.tiers[0].events.push({label:"",startSample:0,sampleDur:Math.round(j[1]*a.wavJSO.SampleRate)}),g=e+2;g<f.length-1;g++)j=f[g].split(/\s+/),i=f[g-1].split(/\s+/),h.tiers[0].events.push({label:j[j.length-1],startSample:Math.round(i[1]*a.wavJSO.SampleRate),sampleDur:Math.round((j[1]-i[1])*a.wavJSO.SampleRate)});return h},b}]),angular.module("emulvcApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState",function(a,b,c,d,e,f){a.username="",a.passcode="",a.loginError="",a.tryLogin=function(){if(a.passcode===d.vals.userManagment.passcode){a.loginError="CORRECT PASSCODE!... getting users utterance list...";{"testData/"+a.username+".json"}e.wsH.getUsrUttList(a.username).then(function(c){"USER NOT FOUND"===c?a.loginError=c:(a.loginError="USER FOUND",b.$broadcast("newUserLoggedOn",a.username),a.cancel())})}else a.loginError="WRONG PASSCODE!"},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1}}]),angular.module("emulvcApp").service("Ssffdataservice",function(){var a={};return a.data=[],a.getData=function(){return a.data},a.setData=function(b){angular.copy(b,a.data)},a}),angular.module("emulvcApp").service("Tierdataservice",function(){var a={};return a.data={},a.getData=function(){return a.data},a.setData=function(b){angular.copy(b,a.data)},a}),angular.module("emulvcApp").service("Websockethandler",["$q","$rootScope","$location","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,c){var d=j.toJSO(c,a);b.$broadcast("newlyLoadedLabelJson",d)}function m(a,c){var d=t(c),f=e.ssff2jso(d);f.fileURL=document.URL+a,b.$broadcast("newlyLoadedSSFFfile",f,a.replace(/^.*[\\\/]/,""))}function n(a){b.$broadcast("connectedToWSserver"),b.$apply(x.resolve(a))}function o(a){r(JSON.parse(a.data))}function p(a){console.log(a),console.log("WEBSOCKET ERROR!!!!!"),b.$apply(x.resolve(a))}function q(b){var c=a.defer(),d=s();return v[d]={time:new Date,cb:c},b.callbackID=d,w.send(JSON.stringify(b)),c.promise}function r(a){var c=a;if(v.hasOwnProperty(c.callbackID)){switch(console.log("resolving callback: "+c.type+" Nr.: "+c.callbackID),c.type){case"getESPSfile":l(c.fileName,c.data);break;case"getSSFFfile":m(c.fileName,c.data)}b.$apply(v[c.callbackID].cb.resolve(c.data)),delete v[c.callbackID]}}function s(){var a=k.new();return console.log(a),a}function t(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d<a.length;++d)c[d]=a.charCodeAt(d);return b}var u={},v={},w={},x={};return u.initConnect=function(b){var c=a.defer();return w=new WebSocket(b),w.onopen=n,w.onmessage=o,w.onerror=p,x=c,c.promise},u.getProtocol=function(){var a={type:"getProtocol"},b=q(a);return b},u.getDoUserManagement=function(){var a={type:"getDoUserManagement"},b=q(a);return b},u.getConfigFile=function(){var a={type:"getConfigFile"},b=q(a);return b},u.getUsrUttList=function(a){var b={type:"getUttList",usrName:a},c=q(b);return c},u.getSSFFfile=function(a){var b={type:"getSSFFfile",fileName:a},c=q(b);return c},u.getESPSfile=function(a){var b={type:"getESPSfile",fileName:a},c=q(b);return c},u.getAudioFile=function(a){var b={type:"getAudioFile",fileName:a},c=q(b);return c},u.saveUsrUttList=function(a,b){var c=angular.toJson(b),d={type:"saveUttList",usrName:a,data:c},e=q(d);return e},u.saveSSFFfile=function(a,b){for(var d=e.jso2ssff(b),f="",g=new Uint8Array(d),h=g.byteLength,i=0;h>i;i++)f+=String.fromCharCode(g[i]);var j=window.btoa(f),k={type:"saveSSFFfile",usrName:a,fileURL:b.fileURL.split(c.absUrl())[1],data:j},l=q(k);return l},u.getUtt=function(c,d){var e;e=u.findFileInUtt(d,f.vals.signalsCanvasConfig.extensions.audio),u.getAudioFile(e).then(function(a){var b=t(a),c=h.wav2jso(b);return c}).then(function(a){g.curViewPort.sS=0,g.curViewPort.eS=a.Data.length,g.curViewPort.bufferLength=a.Data.length,g.setscrollOpen(0),g.resetSelect(),i.wavJSO=a,b.$broadcast("cleanPreview")}).then(function(){f.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){e=u.findFileInUtt(d,a),u.getSSFFfile(e)})}).then(function(){f.vals.labelCanvasConfig.order.forEach(function(b){var c=a.defer();e=u.findFileInUtt(d,b);var f=u.getESPSfile(e);c.resolve(f)})})},u.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},u}]),angular.module("emulvcApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState",function(a,b,c,d){a.wsServerUrl=b.vals.main.wsServerUrl,a.connectionError="sdfsadf",d.focusInTextField=!0,a.tryConnection=function(){console.log(a.wsServerUrl);var b=c.wsH.initConnect(a.wsServerUrl);b.then(function(b){console.log(b),"error"===b.type?(console.log("##############################"),a.connectionError="ERROR trying to connect to ws-server"):"open"===b.type&&(d.focusInTextField=!1,a.cancel())})}}]);