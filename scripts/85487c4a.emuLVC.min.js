"use strict";ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emulvcApp",["ui","ui.bootstrap","ngRoute"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]);var fileType={WAV:1,TEXTGRID:2,FMS:3,F0:4};angular.module("emulvcApp").service("ConfigProviderService",["$rootScope","$http",function(a,b){var c={};return c.vals={},c.httpGetConfig=function(){b.get("configFiles/defaultConfig.json").success(function(b){c.setVals(b),a.$broadcast("configLoaded",b)})},c.setVals=function(a){$.isEmptyObject(c.vals)?(console.log(a),c.vals=a):(console.log(a),Object.keys(a).forEach(function(b){console.log(b+" : "+a[b]),Object.keys(a[b]).forEach(function(d){void 0!==c.vals[b][d]?c.vals[b][d]=a[b][d]:console.error("BAD ENTRY IN CONFIG")})}))},c}]),angular.module("emulvcApp").controller("MainCtrl",["$scope","$modal","$log","$compile","$timeout","$window","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","Tierdataservice",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.cps=k,a.history=h,a.fontImage=l,a.tds=n,a.connectBtnLabel="connect",a.showSaveCommStaBtnDiv=!1,a.lastkeycode="N/A",a.uttList=[],a.showDropZone=!0,a.curUserName="",a.curUtt={},a.modifiedCurSSFF=!1,a.modifiedMetaData=!1,a.lastclickedutt=null,a.shortcut=null,a.windowWidth=f.outerWidth,angular.element(f).bind("resize",function(){a.refreshTimeline(),$("#HandletiersCtrl").scope().deleteEditArea(),a.windowWidth=f.outerWidth,a.$apply("windowWidth")}),angular.element(f).bind("keyup",function(a){a.keyCode===k.vals.keyMappings.shift&&h.history(),a.keyCode===k.vals.keyMappings.alt&&h.history()}),k.httpGetConfig(),a.history.init(),$(".TimelineCtrl").ownResize(".resizer"),a.$on("configLoaded",function(){a.handleConfigLoaded()}),a.$on("connectedToWSserver",function(){a.connectBtnLabel="disconnect",a.showDropZone=!1,k.vals.main.comMode="ws",a.showSaveCommStaBtnDiv=!0,i.wsH.getProtocol().then(function(b){"emuLVC-websocket-protocol"===b.protocol&&"0.0.1"===b.version&&(i.wsH.getConfigFile().then(function(a){k.setVals(a)}),k.vals.main.autoConnect?a.$broadcast("newUserLoggedOn",""):i.wsH.getDoUserManagement().then(function(b){"YES"===b?a.openModal("views/login.html","dialog",!0):a.$broadcast("newUserLoggedOn","")}))})}),a.$on("fileLoaded",function(b,c,d){switch(c){case c.WAV:a.uttList[0].name=d.name.substr(0,d.name.lastIndexOf(".")),i.httpGetUtterence(a.uttList[0],"testData/"+a.uttList[0]+"/");break;case c.TEXTGRID:}console.log("data"),console.log(d)}),a.$on("newUserLoggedOn",function(b,c){a.curUserName=c,i.wsH.getUsrUttList(c).then(function(b){i.getUtt(b[0]),a.curUtt=b[0],g.getsubmenuOpen()||a.openSubmenu(),a.uttList=b})}),a.$on("saveSSFFb4load",function(){console.log("saving utt"),i.wsH.saveSSFFfile(a.curUserName,m.data[0]),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),i.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.$on("discardSSFFb4load",function(){console.log("discarding ssff changes"),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),i.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.$on("newlyLoadedAudioFile",function(b,c,d){g.curViewPort.sS=0,g.curViewPort.eS=c.Data.length,g.curViewPort.bufferLength=c.Data.length,g.setscrollOpen(0),j.wavJSO=c,a.baseName=d.substr(0,d.lastIndexOf("."))}),a.handleConfigLoaded=function(){g.getsubmenuOpen()||a.openSubmenu(),a.shortcut=Object.create(k.vals.keyMappings);for(var b in a.shortcut)8===a.shortcut[b]?a.shortcut[b]="BACKSPACE":9===a.shortcut[b]?a.shortcut[b]="TAB":13===a.shortcut[b]?a.shortcut[b]="ENTER":16===a.shortcut[b]?a.shortcut[b]="SHIFT":18===a.shortcut[b]?a.shortcut[b]="ALT":27===a.shortcut[b]?a.shortcut[b]="ESC":32===a.shortcut[b]?a.shortcut[b]="SPACE":-1===a.shortcut[b]?a.shortcut[b]="NONE":38===a.shortcut[b]?a.shortcut[b]="ARROW UP":40===a.shortcut[b]?a.shortcut[b]="ARROW DOWN":187===a.shortcut[b]?a.shortcut[b]="+":189===a.shortcut[b]?a.shortcut[b]="-":a.shortcut[b.toString()]=String.fromCharCode(a.shortcut[b]);k.vals.main.autoConnect&&i.wsH.initConnect(k.vals.main.wsServerUrl),g.setspectroSettings(k.vals.spectrogramSettings.N,k.vals.spectrogramSettings.rangeFrom,k.vals.spectrogramSettings.rangeTo,k.vals.spectrogramSettings.dynamicRange,k.vals.spectrogramSettings.window),$(".TimelineCtrl").css("height",k.vals.colors.timelineHeight),$(".HandletiersCtrl").css("padding-top",$(".TimelineCtrl").height()+2*$(".menu").height()+"px"),k.vals.restrictions.sortLabels&&$("#allowSortable").sortable("enable"),$("#"+k.vals.signalsCanvasConfig.order[1]).insertBefore("#"+k.vals.signalsCanvasConfig.order[0]),$("#"+k.vals.signalsCanvasConfig.order[0]).insertBefore("#"+k.vals.signalsCanvasConfig.order[1])},a.renameTier=function(){void 0!==g.getcurClickTierName()?a.openModal("views/renameTier.html","dialog",!0):a.openModal("views/error.html","dialog","Rename Error",!1,"Please choose a Tier first !")},a.downloadTextGrid=function(){console.log(i.toTextGrid())},a.refreshTimeline=function(){a.$broadcast("refreshTimeline")},a.refreshScope=function(){a.$digest()},a.getShortCut=function(b){return null!==a.shortcut?null!==a.shortcut[b]?""!==a.shortcut[b]?a.shortcut[b]:"NONE":"NONE":"NOT SET"},a.menuUttClick=function(b){a.modifiedCurSSFF?(a.lastclickedutt=b,a.openModal("views/saveChanges.html","dialog","Changes not Saved Warning",!0,"Changes made to: "+b.name+". Do you wish to save them?")):(a.$broadcast("loadingNewUtt"),i.getUtt(b),a.curUtt=b)},a.menuUttSave=function(){i.wsH.saveSSFFfile(a.curUserName,m.data[0]),a.modifiedCurSSFF=!1},a.dragStart=function(){g.setdragBarActive(!0)},a.dragEnd=function(){g.setdragBarActive(!1)},a.openModal=function(c,d,e,f,h){var i=!0;e&&(i="static"),g.setmodalOpen(!0);b.open({backdrop:i,keyboard:!0,backdropClick:!0,templateUrl:c,windowClass:d,controller:"ModalInstanceCtrl",resolve:{modalContent:function(){return h},modalTitle:function(){return f},windowLength:function(){return g.spectroSettings.windowLength},rangeFrom:function(){return g.spectroSettings.rangeFrom},rangeTo:function(){return g.spectroSettings.rangeTo},dynamicRange:function(){return g.spectroSettings.dynamicRange},selectSegmentsInSelection:function(){return a.shortcut.selectSegmentsInSelection},window:function(){return g.spectroSettings.window},selectFirstContourCorrectionTool:function(){return a.shortcut.selectFirstContourCorrectionTool},selectSecondContourCorrectionTool:function(){return a.shortcut.selectSecondContourCorrectionTool},selectThirdContourCorrectionTool:function(){return a.shortcut.selectThirdContourCorrectionTool},selectFourthContourCorrectionTool:function(){return a.shortcut.selectFourthContourCorrectionTool},selectNoContourCorrectionTool:function(){return a.shortcut.selectNoContourCorrectionTool},playAllInView:function(){return a.shortcut.playAllInView},keyBackspace:function(){return a.shortcut.backspace},snapAbove:function(){return a.shortcut.snapAbove},snapBelow:function(){return a.shortcut.snapBelow},plus:function(){return a.shortcut.plus},minus:function(){return a.shortcut.minus},snapZero:function(){return a.shortcut.snapZero},snapBoundary:function(){return a.shortcut.snapBoundary},keyAlt:function(){return a.shortcut.alt},playSelected:function(){return a.shortcut.playSelected},history:function(){return a.shortcut.history},keyopenSubmenu:function(){return a.shortcut.openSubmenu},playEntireFile:function(){return a.shortcut.playEntireFile},keyTab:function(){return a.shortcut.tab},tierUp:function(){return a.shortcut.tierUp},tierDown:function(){return a.shortcut.tierDown},keyShift:function(){return a.shortcut.shift},keyEnter:function(){return a.shortcut.enter},keyZoomIn:function(){return a.shortcut.zoomIn},keyZoomOut:function(){return a.shortcut.zoomOut},keyZoomAll:function(){return a.shortcut.zoomAll},keyZoomSel:function(){return a.shortcut.zoomSel},shiftViewPortLeft:function(){return a.shortcut.shiftViewPortLeft},shiftViewPortRight:function(){return a.shortcut.shiftViewPortRight},currentTier:function(){return""!==g.getcurClickTierName()?g.getcurClickTierName():"error"}}})},a.changingMetaData=function(){a.modifiedMetaData=!0},a.changingSSFFdata=function(){a.modifiedCurSSFF=!0},a.uttIsDisabled=function(b){return b.name===a.curUtt.name?!1:!0},a.getUttColor=function(b){var c;return c=a.modifiedCurSSFF?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curUtt.name?c:void 0},a.getMetaBtnColor=function(){var b;return b=a.modifiedMetaData?{color:"red"}:{color:"rgb(128,230,25)"}},a.cursorInTextField=function(){g.focusInTextField=!0},a.cursorOutOfTextField=function(){g.focusInTextField=!1},a.openSubmenu=function(){g.getsubmenuOpen()?(g.setsubmenuOpen(!1),$("#menuLeft").removeClass("cbp-spmenu-open"),$("#TimelineCtrl").removeClass("cbp-spmenu-push-toright").addClass("cbp-spmenu-push-toleft"),$("#HandletiersCtrl").removeClass("cbp-spmenu-push-toright").addClass("cbp-spmenu-push-toleft"),$("#menu").removeClass("cbp-spmenu-push-toright"),$("#menu-bottom").removeClass("cbp-spmenu-push-toright")):(g.setsubmenuOpen(!0),$("#menuLeft").addClass("cbp-spmenu-open"),$("#TimelineCtrl").removeClass("cbp-spmenu-push-toleft").addClass("cbp-spmenu-push-toright"),$("#HandletiersCtrl").removeClass("cbp-spmenu-push-toleft").addClass("cbp-spmenu-push-toright"),$("#menu").addClass("cbp-spmenu-push-toright"),$("#menu-bottom").addClass("cbp-spmenu-push-toright"));e(a.refreshTimeline,350)},a.connectBtnClick=function(){"connect"===a.connectBtnLabel?a.openModal("views/connectModal.html","dialog",!1):(i.wsH.closeConnect(),a.uttList=[],a.showDropZone=!0,a.showSaveCommStaBtnDiv=!1,k.httpGetConfig())},a.openDemoDBclick=function(){a.showDropZone=!1,k.vals.main.comMode="http:GET",i.getUttList("testData/demoUttList.json").then(function(b){console.log(b.data),a.uttList=b.data,i.getUtt(b.data[0])})},a.saveMetaData=function(){i.wsH.saveUsrUttList(a.curUserName,a.uttList),a.modifiedMetaData=!1},a.openFile=function(){alert("code to open file")},a.setlastkeycode=function(b){a.lastkeycode=b},a.cmdZoomAll=function(){g.setViewPort(0,g.curViewPort.bufferLength)},a.cmdZoomSel=function(){g.setViewPort(g.curViewPort.selectS,g.curViewPort.selectE)},a.cmdZoomIn=function(){g.zoomViewPort(!0)},a.cmdZoomOut=function(){g.zoomViewPort(!1)},a.cmdZoomLeft=function(){g.shiftViewPort(!1)},a.cmdZoomRight=function(){g.shiftViewPort(!0)},a.cmdPlayView=function(){j.playFromTo(g.curViewPort.sS,g.curViewPort.eS),g.animatePlayHead(g.curViewPort.sS,g.curViewPort.eS)},a.cmdPlaySel=function(){j.playFromTo(g.curViewPort.selectS,g.curViewPort.selectE),g.animatePlayHead(g.curViewPort.selectS,g.curViewPort.selectE)},a.cmdPlayAll=function(){j.playFromTo(0,j.wavJSO.Data.length),g.animatePlayHead(0,j.wavJSO.Data.length)}}]),angular.module("emulvcApp").controller("FileCtrl",["$rootScope","$scope","viewState","Iohandlerservice","Soundhandlerservice","ConfigProviderService",function(a,b,c,d,e,f){function g(a){a.stopPropagation(),a.preventDefault(),b.$apply(function(){b.dropText=j,b.dropClass=""})}function h(a,b){if(b=b||"",a.isFile)a.file(function(a){a.name.substr(a.name.lastIndexOf(".")+1).toUpperCase()});else if(a.isDirectory){var c=a.createReader();c.readEntries(function(c){for(var d=0;d<c.length;d++)h(c[d],b+a.name+"/")})}}var i=document.getElementById("dropzone"),j="Drop your files here",k="File is not allowed",l="Parsing started";b.$on("configLoaded",function(){"server"===f.vals.main.mode&&(b.dropClass="hidden")}),b.dropText=j,i.addEventListener("dragenter",g,!1),i.addEventListener("dragleave",g,!1),i.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault();var c=a.dataTransfer&&a.dataTransfer.types&&a.dataTransfer.types.indexOf("Files")>=0;b.$apply(function(){b.dropText=c?j:k,b.dropClass=c?"over":"not-available"})},!1),i.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),b.$apply(function(){b.dropText=l,b.dropClass=""});for(var c=a.dataTransfer.items,d=0;d<c.length;d++){var e=c[d].webkitGetAsEntry();e&&h(e)}},!1)}]),angular.module("emulvcApp").directive("tier",function(){return{templateUrl:"views/tier.html",restrict:"E",link:function(a,b){function c(b,c,d){if(!$.isEmptyObject(b)&&!$.isEmptyObject(c)&&!$.isEmptyObject(d)){var f=e[0].getContext("2d");f.clearRect(0,0,e[0].width,e[0].height);var g,h,i,j;g=c.getSampleDist(e[0].width),j=a.fontImage.getTextImageTwoLines(f,b.TierName,"("+b.type+")",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor,!1),f.drawImage(j,0,0,j.width,j.height,5,0,j.width,j.height);var k=c.getcurMouseSegmentId(),l=-1;if("seg"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var m=b.events;m.forEach(function(b){if(++l,b.startSample>=c.curViewPort.sS&&b.startSample<=c.curViewPort.eS||b.startSample+b.sampleDur>c.curViewPort.sS&&b.startSample+b.sampleDur<c.curViewPort.eS||b.startSample<c.curViewPort.sS&&b.startSample+b.sampleDur>c.curViewPort.eS){h=c.getPos(e[0].width,b.startSample),i=c.getPos(e[0].width,b.startSample+b.sampleDur+1),f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(h,0,2,e[0].height/2),f.fillStyle=d.vals.colors.endBoundaryColor,f.fillRect(i,e[0].height/2,2,e[0].height),j=a.fontImage.getTextImage(f,b.label,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor);var g=a.fontImage.getLastImageWidth(),k=h+(i-h)/2-g/2;i-h>g&&f.drawImage(j,0,0,j.width,j.height,k,e[0].height/2-d.vals.font.fontPxSize,j.width,j.height);var m=a.fontImage.getTextImage(f,b.startSample,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),n=a.fontImage.getLastImageWidth(),o=h+(i-h)/2-n/2,p=a.fontImage.getTextImage(f,"dur: "+b.sampleDur,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),q=a.fontImage.getLastImageWidth();f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(h,e[0].height/4),f.lineTo(o+n/2,e[0].height/4),f.lineTo(o+n/2,e[0].height/4+10),f.stroke(),f.strokeStyle=d.vals.colors.endBoundaryColor,f.beginPath(),f.moveTo(i,e[0].height/4*3),f.lineTo(o+n/2,e[0].height/4*3),f.lineTo(o+n/2,e[0].height/4*3-10),f.stroke(),g>=i-h&&(f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(o+n/2,e[0].height/4+10),f.lineTo(o+n/2,e[0].height/4+30),f.stroke()),i-h>n&&f.drawImage(m,0,0,j.width,j.height,h+3,0,j.width,j.height),i-h>q&&f.drawImage(p,0,0,j.width,j.height,i-q,e[0].height/4*3-5,j.width,j.height)}})}else if("point"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var n,o;for(var p in b.events){var q=b.events[p];q.startSample>c.curViewPort.sS&&q.startSample<c.curViewPort.eS&&(n=Math.round(c.getPos(e[0].width,q.startSample)+g/2),b.TierName===c.curMouseMoveTierName&&k===c.curMouseMoveSegmentName?console.log("this is the selected boundary"):(f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(n,0,1,e[0].height/2-e[0].height/10),f.fillRect(n,e[0].height/2+e[0].height/10,1,e[0].height/2-e[0].height/10),o=f.measureText(b.events[p].label).width,f.fillStyle=d.vals.colors.labelColor,f.fillText(b.events[p].label,n-o/2+1,e[0].height/2)),f.fillStyle=d.vals.colors.startBoundaryColor,o=f.measureText(q.startSample).width,f.fillText(q.startSample,n+5,e[0].height/8))}}}}function d(a,b,c){var d=e[1].getContext("2d");if(d.clearRect(0,0,e[1].width,e[1].height),a.events[b.getcurMouseSegmentId()]&&b.movingBoundary){d.fillStyle=c.vals.colors.selectedBoundaryColor;var f=b.getcurMouseTierDetails(),g=Math.round(b.getPos(e[0].width,f.events[b.getcurMouseSegmentId()].startSample));d.fillRect(g,0,1,e[0].height)}a.TierName===b.curClickTierName&&(d.fillStyle=c.vals.colors.selectedTierColor,d.fillRect(0,0,e[0].width,e[0].height));var h,i,j,k,l;h=b.getPos(e[1].width,b.curViewPort.selectS),i=b.getPos(e[1].width,b.curViewPort.selectE),j=b.getSampleDist(e[1].width),h===i?(k="seg"===b.curMouseMoveTierType?0:j/2,d.fillStyle=c.vals.colors.selectedBorderColor,d.fillRect(h+k,0,1,e[0].height)):(d.fillStyle=c.vals.colors.selectedAreaColor,d.fillRect(h,0,i-h,e[0].height),d.strokeStyle=c.vals.colors.selectedBorderColor,d.beginPath(),d.moveTo(h,0),d.lineTo(h,e[0].height),d.moveTo(i,0),d.lineTo(i,e[0].height),d.closePath(),d.stroke());var m=b.getcurMouseSegmentId(),n=b.getselected(),o=b.getcurClickTierName();""!==o&&a.TierName===o&&n.forEach(function(f){l=a.events[f],h=Math.round(b.getPos(e[0].width,l.startSample)),i=Math.round(b.getPos(e[0].width,l.startSample+l.sampleDur+1)),d.fillStyle=c.vals.colors.selectedSegmentColor,d.fillRect(h,0,i-h,e[0].height),d.fillStyle=c.vals.colors.startBoundaryColor}),l=a.events[m],void 0!==l&&void 0!==m&&a.TierName===b.getcurMouseTierName()&&(h=Math.round(b.getPos(e[1].width,l.startSample)),i=Math.round(b.getPos(e[1].width,l.startSample+l.sampleDur+1)),d.fillStyle=c.vals.colors.selectedBoundaryColor,d.fillRect(h,0,3,e[1].height),d.fillStyle=c.vals.colors.startBoundaryColor)}var e=b.find("canvas");a.$watch("tierDetails.data",function(){c(a.tier,a.vs,a.config)},!0),a.$watch("vs",function(){c(a.tier,a.vs,a.config),d(a.tier,a.vs,a.config)},!0),b.bind("mouseleave",function(){a.vs.setcurMouseSegmentId(void 0),d(a.tier,a.vs,a.config)}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.tier)||$.isEmptyObject(a.vs)||c(a.tier,a.vs,a.config)}),a.updateView=function(){c(a.tier,a.vs,a.config)}}}}),angular.module("emulvcApp").directive("osci",function(){return{templateUrl:"views/osci.html",restrict:"E",link:function(a,b){function c(a,b){var c=a.vs,d=i.getContext("2d");d.clearRect(0,0,h.width,h.height);var e=c.getPos(i.width,c.playHeadAnimationInfos.sS),g=c.getPos(i.width,c.playHeadAnimationInfos.curS);d.fillStyle=a.config.vals.colors.selectedAreaColor,d.fillRect(e,0,g-e,h.height),f(a,b,!1)}function d(a,b,c){return a.measureText(b).width*c}function e(a,b,c,e){return b.toString().length>c.toString().length?d(a,b,e):d(a,c,e)}function f(a,b,c){var f=a.vs,g=i.getContext("2d");if(c&&g.clearRect(0,0,i.width,i.height),f.movingBoundary){g.fillStyle=b.vals.colors.selectedBoundaryColor;var h=f.getcurMouseTierDetails(),j=Math.round(f.getPos(i.width,h.events[f.getcurMouseSegmentId()].startSample));g.fillRect(j,0,1,i.height)}g.strokeStyle=b.vals.colors.labelColor,g.fillStyle=b.vals.colors.labelColor,g.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,g.beginPath(),g.moveTo(0,0),g.lineTo(5,5),g.moveTo(i.width,0),g.lineTo(i.width-5,5),g.closePath(),g.stroke();var k,l,m,n,o=g.canvas.width/g.canvas.offsetWidth;if(f.curViewPort&&(k=f.round(f.curViewPort.sS/a.shs.wavJSO.SampleRate,6),l=f.round(f.curViewPort.eS/a.shs.wavJSO.SampleRate,6),m=a.fontImage.getTextImageTwoLines(g,f.curViewPort.sS,k,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(m,0,0,m.width,m.height,5,0,m.width,m.height),n=e(g,f.curViewPort.eS,l,o),m=a.fontImage.getTextImageTwoLines(g,f.curViewPort.eS,l,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(m,0,0,m.width,m.height,i.width-n-5,0,m.width,m.height)),-1!==f.curViewPort.selectS&&-1!==f.curViewPort.selectE){var p,q=f.getPos(i.width,f.curViewPort.selectS),r=f.getPos(i.width,f.curViewPort.selectE),s=f.getSampleDist(i.width);if(f.curViewPort.selectS===f.curViewPort.selectE)p="seg"===f.curMouseMoveTierType?0:s/2,g.fillStyle=b.vals.colors.selectedBorderColor,g.fillRect(q+p,0,1,i.height),m=a.fontImage.getTextImageTwoLines(g,f.round(f.curViewPort.selectS/a.shs.wavJSO.SampleRate+1/a.shs.wavJSO.SampleRate/2,6),f.curViewPort.selectS,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(m,0,0,m.width,m.height,q+p+5,0,m.width,m.height);else if(g.fillStyle=b.vals.colors.selectedAreaColor,g.fillRect(q,0,r-q,i.height),g.strokeStyle=b.vals.colors.selectedBorderColor,g.beginPath(),g.moveTo(q,0),g.lineTo(q,i.height),g.moveTo(r,0),g.lineTo(r,i.height),g.closePath(),g.stroke(),g.fillStyle=b.vals.colors.labelColor,n=e(g,f.curViewPort.selectS,f.round(f.curViewPort.selectS/a.shs.wavJSO.SampleRate,6),o),m=a.fontImage.getTextImageTwoLines(g,f.curViewPort.selectS,f.round(f.curViewPort.selectS/a.shs.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(m,0,0,m.width,m.height,q-n-5,0,m.width,m.height),m=a.fontImage.getTextImageTwoLines(g,f.curViewPort.selectE,f.round(f.curViewPort.selectE/a.shs.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(m,0,0,m.width,m.height,r+5,0,m.width,m.height),n=d(g,f.round((f.curViewPort.selectE-f.curViewPort.selectS)/a.shs.wavJSO.SampleRate,6),o),r-q>n){var t=f.curViewPort.selectE-f.curViewPort.selectS-1,u=f.round((f.curViewPort.selectE-f.curViewPort.selectS)/a.shs.wavJSO.SampleRate,6);n=e(g,t,u,o),m=a.fontImage.getTextImageTwoLines(g,t,u,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(m,0,0,m.width,m.height,q+(r-q)/2-n/2,0,m.width,m.height)}}}var g=b.find("canvas").length,h=b.find("canvas")[0],i=b.find("canvas")[g-1];a.$watch("vs.playHeadAnimationInfos",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c(a,a.config)},!0),a.$watch("tds.data",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)},!0),a.$on("refreshTimeline",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)}),a.$watch("vs.curViewPort",function(b,c){if(!$.isEmptyObject(a.shs)&&!$.isEmptyObject(a.shs.wavJSO)){if(c.sS!==b.sS||c.sE!==b.sE||-1===b.selectS){var d=a.dhs.calculatePeaks(a.vs,h,a.shs.wavJSO.Data);a.dhs.osciPeaks=d,a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,h,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config)}f(a,a.config,!0)}},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0===a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1===a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2===a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"})),f(a,a.config,!0)}},!0)}}}),angular.module("emulvcApp").directive("preview",function(){return{templateUrl:"views/preview.html",restrict:"E",link:function(a,b){function c(){f?d(a.vs,e,a.config,g):(a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,e,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config),g.src=e.toDataURL("image/png"),f=!0,d(a.vs,e,a.config,g))}function d(b,c,d,e){var f=c.getContext("2d"),g=new Image,h=c.width/a.shs.wavJSO.Data.length*b.curViewPort.sS,i=c.width/a.shs.wavJSO.Data.length*b.curViewPort.eS;g.onload=function(){f.clearRect(0,0,c.width,c.height),f.drawImage(g,0,0),f.fillStyle=d.vals.colors.selectedAreaColor,f.fillRect(h,0,i-h,c.height),f.strokeStyle=d.vals.colors.selectedBorderColor,f.beginPath(),f.moveTo(h,0),f.lineTo(h,c.height),f.moveTo(i,0),f.lineTo(i,c.height),f.closePath(),f.stroke()},g.src=e.src}var e=b.find("canvas")[0],f=!1,g=new Image;a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$on("cleanPreview",function(){f=!1})}}}),angular.module("emulvcApp").directive("spectro",function(){return{templateUrl:"views/spectro.html",restrict:"E",link:function(a,b){function c(){u=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width),v=f(a.vs.curViewPort.sS,a.vs.curViewPort.eS,u),null!==v?(s.clearRect(0,0,p.width,p.height),h(v),g()):k(a.vs,a.shs.wavJSO.Data)}function d(){z=null,A=0,z=[]}function e(a,b,c,d){z[A]=[],z[A][0]=a,z[A][1]=b,z[A][2]=c,z[A][3]=d,++A}function f(a,b,c){for(var d=0;d<z.length;++d)if(z[d][0]===a&&z[d][1]===b&&z[d][2]===c)return d;return null}function g(){if(a.vs.movingBoundary){s.fillStyle=a.config.vals.colors.selectedBoundaryColor;var b=a.vs.getcurMouseTierDetails(),c=Math.round(a.vs.getPos(s.canvas.width,b.events[a.vs.getcurMouseSegmentId()].startSample));s.fillRect(c,0,1,s.canvas.height)}var d,e=a.vs.getPos(o.width,a.vs.curViewPort.selectS),f=a.vs.getPos(o.width,a.vs.curViewPort.selectE),g=a.vs.getSampleDist(o.width);a.vs.curViewPort.selectS===a.vs.curViewPort.selectE?(d="seg"===a.vs.curMouseMoveTierType?0:g/2,s.fillStyle=a.config.vals.colors.selectedBorderColor,s.fillRect(e+d,0,1,o.height)):(s.fillStyle=a.config.vals.colors.selectedAreaColor,s.fillRect(e,0,f-e,o.height),s.strokeStyle=a.config.vals.colors.selectedBorderColor,s.beginPath(),s.moveTo(e,0),s.lineTo(e,o.height),s.moveTo(f,0),s.lineTo(f,o.height),s.closePath(),s.stroke(),s.fillStyle=o.labelColor)}function h(a){var b=new Image;b.onload=function(){r.drawImage(b,0,0)},b.src=z[a][3]}function i(){r.fillStyle="#222",r.fillRect(0,0,o.width,o.height),r.font=a.config.vals.font.fontPxSize+"px "+a.config.vals.font.fontType,r.fillStyle="#333",r.fillText("loading...",10,25),null!==y&&(y.terminate(),y=null)}function j(){var b=new Image;u=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width),y.addEventListener("message",function(c){var d=c.data.img;b.onload=function(){r.drawImage(b,0,0,o.width,o.height,0,0,o.width,o.height),e(a.vs.curViewPort.sS,a.vs.curViewPort.eS,u,o.toDataURL("image/png")),g()},b.src=d,a.$apply()})}function k(a,b){i(),s.clearRect(0,0,p.width,p.height),g(),l(a,b)}function l(b,c){t=Math.round((b.curViewPort.eS-b.curViewPort.sS)/o.width),y=new Worker(x);var d=c.subarray(b.curViewPort.sS,b.curViewPort.eS+3*t*b.spectroSettings.windowLength),e=new Float32Array(d);j(),y.postMessage({cmd:"config",N:b.spectroSettings.windowLength}),y.postMessage({cmd:"config",alpha:q}),y.postMessage({cmd:"config",freq:b.spectroSettings.rangeTo}),y.postMessage({cmd:"config",freq_low:b.spectroSettings.rangeFrom}),y.postMessage({cmd:"config",start:Math.round(b.curViewPort.sS)}),y.postMessage({cmd:"config",end:Math.round(b.curViewPort.eS)}),y.postMessage({cmd:"config",myStep:t}),y.postMessage({cmd:"config",window:b.spectroSettings.window}),y.postMessage({cmd:"config",cacheSide:0}),y.postMessage({cmd:"config",width:o.width}),y.postMessage({cmd:"config",height:o.height}),y.postMessage({cmd:"config",cacheWidth:0}),y.postMessage({cmd:"config",dynRangeInDB:b.spectroSettings.dynamicRange}),y.postMessage({cmd:"config",pixelRatio:w}),y.postMessage({cmd:"config",sampleRate:a.shs.wavJSO.SampleRate}),y.postMessage({cmd:"config",streamChannels:a.shs.wavJSO.NumChannels}),y.postMessage({cmd:"pcm",stream:e}),y.postMessage({cmd:"render"})}function m(b,c,d,e,f){if(d.vals.restrictions.drawCrossHairs){s.clearRect(0,0,c.width,c.height),s.strokeStyle=d.vals.colors.crossHairsColor,s.fillStyle=d.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&s.setLineDash([2]);var h=e.getX(f),i=e.getY(f);s.beginPath(),s.moveTo(0,i),s.lineTo(5,i+5),s.moveTo(0,i),s.lineTo(c.width,i),s.lineTo(c.width-5,i+5),s.moveTo(h,0),s.lineTo(h,c.height),s.stroke(),s.font=d.vals.font.fontPxSize+"px "+d.vals.font.fontType;var j=b.round(b.spectroSettings.rangeTo-i/c.height*b.spectroSettings.rangeTo,2),k=s.measureText(j+" Hz").width,l=Math.round(b.curViewPort.sS+h/c.width*(b.curViewPort.eS-b.curViewPort.sS)),m=b.round(b.getViewPortStartTime()+h/c.width*(b.getViewPortEndTime()-b.getViewPortStartTime()),6),n=a.fontImage.getTextImage(r,j+" Hz",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!0),o=a.fontImage.getTextImageTwoLines(r,l,m,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!1);s.drawImage(n,0,0,n.width,n.height,5,i,n.width,n.height),s.drawImage(n,0,0,n.width,n.height,c.width-5-k*(r.canvas.width/r.canvas.offsetWidth),i,n.width,n.height),s.drawImage(o,0,0,o.width,o.height,h+5,0,o.width,o.height),"Google Inc."===navigator.vendor&&s.setLineDash([0]),g()}}var n=b.find("canvas").length,o=b.find("canvas")[0],p=b.find("canvas")[n-1],q=.16,r=o.getContext("2d"),s=p.getContext("2d"),t=0;window.URL=window.URL||window.webkitURL;var u,v,w=window.devicePixelRatio||1,x="scripts/workers/spectroWorker.js",y=new Worker(x),z=null,A=0;d(),b.bind("mousemove",function(b){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||m(a.vs,p,a.config,a.dhs,b)}),b.bind("mouseleave",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(s.clearRect(0,0,p.width,p.height),g())}),a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("tds.data",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(s.clearRect(0,0,p.width,p.height),g())},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(s.clearRect(0,0,p.width,p.height),g())},!0),a.$on("newlyLoadedAudioFile",function(){console.log("clearing spectro image cache..."),d()}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()}),a.$watch("vs.spectroSettings",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(j(),d(),k(a.vs,a.shs.wavJSO.Data))},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0===a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1===a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2===a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"}))}},!0)}}}),angular.module("emulvcApp").controller("HandletiersCtrl",["$scope","$http","$injector","viewState","HistoryService","ConfigProviderService","Soundhandlerservice","Tierdataservice","fontScaleService",function(a,b,c,d,e,f,g,h,i){a.vs=d,a.fontImage=i,a.shs=g,a.config=f,a.testValue="",a.message="",a.myHistory=[],a.myHistoryCounter=0,a.tierDetails=h,a.sortableOptions={update:function(a,b){f.vals.restrictions.sortLabels||b.item.parent().sortable("cancel")},start:function(){a.deleteEditArea()},create:function(){$("#allowSortable").sortable("disable")},axis:"y",placeholder:"tierPlaceholder"},a.$on("newlyLoadedLabelJson",function(b,c){$.isEmptyObject(a.tierDetails.data)?a.tierDetails.data=c:(c.tiers.forEach(function(b){a.tierDetails.data.tiers.push(b)}),c.fileInfos.forEach(function(b){a.tierDetails.data.fileInfos.push(b)})),a.sortTiers()}),a.$on("loadingNewUtt",function(){a.tierDetails.data={}}),a.sortTiers=function(){var b,c=[],d=[];f.vals.labelCanvasConfig.order.forEach(function(e){b=e.split(".")[1],a.tierDetails.data.tiers.forEach(function(e,f){e.TierName.split("_")[1]===b&&(c.push(e),d.push(a.tierDetails.data.fileInfos[f]))})}),a.tierDetails.data.tiers=c,a.tierDetails.data.fileInfos=d},a.updateAllLabels=function(){""!==a.testValue&&angular.forEach(a.tierDetails.data.events,function(b){b.label=a.testValue})},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.getTierLength=function(){return a.tierDetails.data.tiers.length},a.getTier=function(b){var c;return angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===b&&(c=a)}),c},a.renameLabel=function(){d.isEditing()?(a.rename(d.getcurClickTierName(),d.getlastID(),$("."+d.getlasteditArea()).val()),d.deleteEditArea(),d.focusInTextField=!1):0===d.countSelected()?alert("please select a segement first!"):(d.setEditing(!0),d.openEditArea())},a.deleteEditArea=function(){d.deleteEditArea()},a.selectTier=function(b){var c;d.isEditing()&&(a.renameLabel(),d.deleteEditArea());
var e=d.getcurClickTierName();void 0===e?d.setcurClickTierName($("li").children()[0].id):b?(c=$("li."+e).next().children()[0],void 0===c?d.setcurClickTierName($("li").children()[0].id):d.setcurClickTierName(c.id)):(c=$("li."+e).prev().children()[0],void 0===c?d.setcurClickTierName($("li").children()[0].id):d.setcurClickTierName(c.id))},a.tabNext=function(b){d.isEditing()&&(a.renameLabel(),d.deleteEditArea());var c=parseInt(d.getselected()[0],10);b?c>1&&--c:c<d.getTierLength()-1&&++c,1>c&&(c=d.getTierLength()-1),angular.forEach(a.tierDetails.data.tiers,function(a){var b=0;a.TierName===d.getcurClickTierName()&&angular.forEach(a.events,function(a){b===c&&(d.setcurClickSegment(a,c),d.setlasteditArea("_"+c)),++b})})},a.snapBoundary=function(b){var c,e,f=d.getcurMouseSegment().startSample,g=d.getcurMouseTierDetails();a.tierDetails.data.tiers.forEach(function(d,f){d.TierName===g.TierName&&(f>=1&&b?(c=a.tierDetails.data.tiers[f-1],e=f-1):f<a.tierDetails.data.tiers.length-1&&!b&&(console.log("to bottom"),c=a.tierDetails.data.tiers[f+1],e=f+1))});var h,i,j=1/0;void 0!==c&&(c.events.forEach(function(a){h=Math.abs(f-a.startSample),j>h&&(j=h,i=a.startSample-f)}),this.moveBorder(i,g))},a.expandSegment=function(b,c){if(void 0===d.getcurClickTierName())a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","Please select a Tier first");else if(0===d.getselected().length)a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","Please select one or more Segments first");else{var e=0;"absolute"===f.vals.labelCanvasConfig.addTimeMode?e=parseInt(f.vals.labelCanvasConfig.addTimeValue,10):"relative"===f.vals.labelCanvasConfig.addTimeMode?e=f.vals.labelCanvasConfig.addTimeValue*(d.curViewPort.bufferLength/100):a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","Error in Configuration (Value labelCanvasConfig.addTimeMode)"),b||(e=0-e);var g,h=d.getselected().sort(),i=0;c?angular.forEach(a.tierDetails.data.tiers,function(b){if(b.TierName===d.getcurClickTierName())if(b.events[h[h.length-1]+1].sampleDur>h.length*e)if(b.events[h[0]].sampleDur>-(h.length*e)){var c=!1;for(g=1;g<=h.length;g++)b.events[h[g-1]].sampleDur+e<=0&&(c=!0);if(c)a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","Cannot Expand/Shrink. Segment would be too small");else{for(g=1;g<=h.length;g++)b.events[h[g-1]].startSample+=i,b.events[h[g-1]].sampleDur+=e,i=g*e;b.events[h[h.length-1]+1].startSample+=i,b.events[h[h.length-1]+1].sampleDur-=i}}else a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","No Space left to decrease");else a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","No Space left to increase")}):angular.forEach(a.tierDetails.data.tiers,function(b){if(b.TierName===d.getcurClickTierName())if(b.events[h[0]-1].sampleDur>h.length*e)if(b.events[h[h.length-1]].sampleDur>h.length*e){var c=!1;for(g=1;g<=h.length;g++)b.events[h[g-1]].sampleDur+e<=0&&(c=!0);if(c)a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","Cannot Expand/Shrink. Segment would be too small");else{for(g=0;g<h.length;g++)b.events[h[g]].startSample-=e*(h.length-g),b.events[h[g]].sampleDur+=e;b.events[h[0]-1].sampleDur-=e*h.length}}else a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","No Space left to increase");else a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","No Space left to decrease")})}},a.selectSegmentsInSelection=function(){if(void 0===d.getcurClickTierName())a.openModal("views/error.html","dialogSmall",!1,"Selection Error","Please select a Tier first");else{var b=d.curViewPort.selectS,c=d.curViewPort.selectE;angular.forEach(a.tierDetails.data.tiers,function(a){var e=0;a.TierName===d.getcurClickTierName()&&angular.forEach(a.events,function(a){a.startSample>=b&&a.startSample+a.sampleDur<=c&&d.setcurClickSegmentMultiple(a,e),++e})})}},a.rename=function(b,c,d){angular.forEach(a.tierDetails.data.tiers,function(a){var f=0;a.TierName===b&&angular.forEach(a.events,function(a){c===f&&(a.label=d,e.history()),++f})})},a.deleteTier=function(b){var c=0;angular.forEach(a.tierDetails.data.tiers,function(d){d.TierName===b&&a.tierDetails.data.tiers.splice(c,1),++c}),e.history()},a.renameTier=function(b){var c=!1;angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===b&&(c=!0)}),c?a.openModal("views/error.html","dialog",!1,"Rename Error","This Tiername already exists ! Please choose another name !"):(angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===d.getcurClickTierName()&&(a.TierName=b)}),e.history())},a.deleteSegments=function(){var b=d.getselected(),c=d.getcurClickTierName();angular.forEach(a.tierDetails.data.tiers,function(a){if(a.TierName===c){for(var e in b){var f=b[e],g=a.events[f].sampleDur;a.events[f-1].sampleDur+=g/2,a.events[f+1].sampleDur+=g/2,a.events[f+1].startSample-=g/2,a.events.splice(f,1)}d.setcurClickSegment(a.events[b[0]-1],b[0]-1)}}),e.history()},a.getNearest=function(b,c){var d=parseInt(a.vs.curViewPort.sS,10)+b,e=0,f=0;return angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(f=d-a.startSample>=a.sampleDur/2?e+1:e),++e}),f},a.getEventId=function(b,c){var d=parseInt(a.vs.curViewPort.sS,10)+b,e=0,f=0;return angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(f=e),++e}),f},a.getEvent=function(b,c){var d=parseInt(a.vs.curViewPort.sS,10)+b,e=null;return angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(e=a)}),e},a.moveBorder=function(a,b){if(null!==b&&b.TierName===d.getcurMouseTierName()){var c=d.getcurMouseSegmentId();c>1&&b.events[c-1].sampleDur+a>=1&&b.events[c].sampleDur-a>=1&&(b.events[c-1].sampleDur+=a,b.events[c].startSample+=a,b.events[c].sampleDur-=a)}},a.moveSegment=function(a,b){if(null!==b&&b.TierName===d.getcurClickTierName()){var c=d.getselected().sort();if(b.events[c[0]-1].sampleDur+a>=1&&b.events[c[c.length-1]+1].sampleDur-a>=1){b.events[c[0]-1].sampleDur+=a;for(var e=0;e<c.length;e++)b.events[c[e]].startSample+=a;b.events[c[c.length-1]+1].startSample+=a,b.events[c[c.length-1]+1].sampleDur-=a}}}}]),angular.module("emulvcApp").controller("TimelineCtrl",["$scope","$http","$compile","viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService","Ssffdataservice",function(a,b,c,d,e,f,g,h){a.vs=d,a.shs=e,a.cps=g.vals.colors,a.config=g,a.dhs=f,a.ssffds=h,a.showSSFFOsci=!1,a.showSSFFSpectro=!1,a.$on("newlyLoadedSSFFfile",function(b,c){a.ssffds.data=[],a.ssffds.data.push(c);for(var d in g.vals.signalsCanvasConfig.assign)"fms:fm"===g.vals.signalsCanvasConfig.assign[d]&&("osci"===d&&(a.showSSFFOsci=!0),"spec"===d&&(a.showSSFFSpectro=!0))}),a.$on("loadingNewUtt",function(){a.ssffds.data=[]}),a.resizeSpectro=function(){0===d.getscrollOpen()?d.setscrollOpen(1):d.setscrollOpen(0)},a.resizeOsci=function(){0===d.getscrollOpen()?d.setscrollOpen(2):d.setscrollOpen(0)}}]),angular.module("emulvcApp").controller("ModalInstanceCtrl",["$rootScope","$scope","$modalInstance","ConfigProviderService","modalTitle","modalContent","windowLength","rangeFrom","rangeTo","dynamicRange","window","currentTier","viewState","snapBoundary","keyZoomIn","keyZoomOut","keyZoomAll","keyZoomSel","shiftViewPortLeft","shiftViewPortRight","keyTab","keyShift","keyEnter","playAllInView","playSelected","playEntireFile","keyBackspace","tierUp","tierDown","snapBelow","snapAbove","snapZero","plus","minus","selectFirstContourCorrectionTool","selectSecondContourCorrectionTool","keyopenSubmenu","history","selectSegmentsInSelection","selectThirdContourCorrectionTool","selectFourthContourCorrectionTool","selectNoContourCorrectionTool","keyAlt",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q){b.cps=d,b.modalContent=f,b.modalTitle=e,b.windowLength=g,b.rangeFrom=h,b.rangeTo=i,b.dynamicRange=j,b.window=k,b.currentTier=l,b.keyZoomIn=o,b.keyZoomOut=p,b.keyZoomAll=q,b.keyZoomSel=r,b.keyTab=u,b.keyShift=v,b.keyEnter=w,b.snapBoundary=n,b.playAllInView=x,b.playEntireFile=z,b.keyBackspace=A,b.playSelected=y,b.tierUp=B,b.plus=G,b.keyAlt=Q,b.minus=H,b.history=L,b.snapBelow=D,b.snapAbove=E,b.snapZero=F,b.tierDown=C,b.selectSegmentsInSelection=M,b.openSubmenu=K,b.selectFirstContourCorrectionTool=I,b.selectSecondContourCorrectionTool=J,b.selectThirdContourCorrectionTool=N,b.selectFourthContourCorrectionTool=O,b.selectNoContourCorrectionTool=P,b.shiftViewPortLeft=s,b.shiftViewPortRight=t,b.ok=function(){m.setmodalOpen(!1),c.dismiss("cancel")},b.cancel=function(){m.setmodalOpen(!1),c.dismiss("cancel")},b.deleteSegment=function(){$("#HandletiersCtrl").scope().deleteSegments(),c.dismiss("ok")},b.cursorInTextField=function(){m.focusInTextField=!0},b.cursorOutOfTextField=function(){m.focusInTextField=!1},b.selected=function(a){return a===m.spectroSettings.window?!0:!1},b.test=function(){alert("hier")},b.deleteTier=function(a){$("#HandletiersCtrl").scope().deleteTier(a),c.dismiss("ok")},b.renameTier=function(){$("#HandletiersCtrl").scope().renameTier($("#newName").val()),c.dismiss("ok")},b.saveSpectroSettings=function(){var a=$("#windowLength").val(),b=$("#rangeFrom").val(),d=$("#rangeTo").val(),e=$("#dynamicRange").val(),f=$("#windowFunction").val();m.setspectroSettings(a,b,d,e,f),m.setmodalOpen(!1),c.dismiss("ok")},b.saveSSFF=function(){a.$broadcast("saveSSFFb4load"),m.setmodalOpen(!1),c.dismiss("ok")},b.discardSSFF=function(){a.$broadcast("discardSSFFb4load"),m.setmodalOpen(!1),c.dismiss("ok")}}]),angular.module("emulvcApp").factory("viewState",["$rootScope","Soundhandlerservice","$window","Tierdataservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,bufferLength:-1},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null},e.selected=[],e.lasteditArea=null,e.editing=!1,e.submenuOpen=!1,e.modalOpen=!1,e.scrollOpen=0,e.curClickTierName=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=void 0,e.start=null,e.loadingUtt=!1,e.curMouseSegmentId=void 0,e.dragBarActive=!1,e.movingBoundary=!1,e.focusInTextField=!1,e.updatePlayHead=function(d){b.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=d);var f=Math.ceil(d-e.start)/1e3*b.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.round(e.playHeadAnimationInfos.sS+f),b.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?a.$apply():(e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.setspectroSettings=function(a,b,c,d,f){e.spectroSettings.windowLength=parseInt(a,10),e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f)},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.selectE&&(this.curViewPort.selectE=b)},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getdragBarActive=function(){return this.dragBarActive},e.setdragBarActive=function(a){this.dragBarActive=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.getmodalOpen=function(){return this.modalOpen},e.setmodalOpen=function(a){this.modalOpen=a},e.getscrollOpen=function(){return this.scrollOpen},e.setscrollOpen=function(a){this.scrollOpen=a},e.setcurClickTierName=function(a){this.curClickTierName=a},e.getcurClickTierName=function(){return this.curClickTierName},e.setcurMouseTierName=function(a){this.curMouseTierName=a},e.getcurMouseTierName=function(){return this.curMouseTierName},e.getcurMouseTierDetails=function(){var a,b=this.getcurMouseTierName();return d.data.tiers.forEach(function(c){c.TierName===b&&(a=c)}),a},e.setcurMouseSegment=function(a){this.curMouseSegment=a},e.getcurMouseSegment=function(){return this.curMouseSegment},e.setcurMouseSegmentId=function(a){this.curMouseSegmentId=a},e.getcurMouseSegmentId=function(){return this.curMouseSegmentId},e.setcurClickSegment=function(a,b){null!==a&&(this.select(a.startSample,a.startSample+a.sampleDur),this.curClickSegments=[],this.curClickSegments.push(a),this.selected=[],this.selected.push(b))},e.selectBoundry=function(){if(void 0!==this.curClickSegments){var a=this.curClickSegments[0].startSample,b=this.curClickSegments[0].startSample+this.curClickSegments[0].sampleDur;this.curClickSegments.forEach(function(c){c.startSample<=a&&(a=c.startSample),c.startSample+c.sampleDur>=b&&(b=c.startSample+c.sampleDur)}),this.select(a,b)}},e.setcurClickSegmentMultiple=function(a,b){var c=!0,d=this;this.selected.forEach(function(e){-1===d.selected.indexOf(b)&&e-1===b&&(d.selected.push(b),d.curClickSegments.push(a),c=!1),-1===d.selected.indexOf(b)&&e+1===b&&(d.selected.push(b),d.curClickSegments.push(a),c=!1)}),c&&(this.curClickSegments=[],this.curClickSegments.push(a),this.selected=[],this.selected.push(b)),this.selectBoundry()},e.getselected=function(){return this.selected},e.getcurClickSegments=function(){return this.curClickSegments},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.setlasteditArea=function(a){this.lasteditArea=a},e.getlastID=function(){return this.lasteditArea.substr(1)},e.getlasteditArea=function(){return this.lasteditArea},e.deleteEditArea=function(){null!==this.getlasteditArea()&&$("."+this.getlasteditArea()).remove(),this.editing=!1},e.countSelected=function(){return this.selected.length},e.setTierLength=function(a){this.tierLength=a},e.getTierLength=function(){return this.tierLength},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getPCMpp=function(a){var b=parseInt(this.curViewPort.sS,10),c=parseInt(this.curViewPort.eS,10);return(c-b)/a.originalEvent.srcElement.width},e.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},e.openEditArea=function(){var a=this.getcurClickSegments()[0],b=this.getlastID(),c=$("#"+this.getcurClickTierName()).find("canvas")[0];console.log(this.getcurClickTierName());var d=this.getPos(c.clientWidth,a.startSample)+c.offsetLeft,e=this.getPos(c.clientWidth,a.startSample+a.sampleDur)+c.offsetLeft,f=c.offsetTop,g=c.clientHeight,h=this.createEditArea(this.getcurClickTierName(),d,f,e-d,g,a.label,b);return this.createSelection($("#"+h)[0],0,$("#"+h).val().length),h},e.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},e.createEditArea=function(a,b,c,d,e,f,g){console.log(a);var h="_"+g;return $("#"+a).prepend($("<textarea>").attr({id:h,"class":h+" Label_Edit","ng-model":"message",autofocus:"true"}).css({position:"absolute","z-index":"5",left:b+2+"px",width:d-1+"px",height:e/3*2+"px","padding-top":e/3+"px"}).text(f)),h},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.setViewPort=function(a,c){var d=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==c&&(this.curViewPort.eS=Math.round(c)),d>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),d<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.sS=d,this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=d,this.curViewPort.eS=e)},e.zoomViewPort=function(a){var b,c,d=this.getcurMouseSegmentId(),e=this.getcurMouseTierDetails(),f=this.curViewPort.eS-this.curViewPort.sS;if(e&&d){var g=e.events[d].startSample,h=g-this.curViewPort.sS,i=this.curViewPort.eS-g;a?(b=this.curViewPort.sS+.5*h,c=this.curViewPort.eS-.5*i):(b=this.curViewPort.sS-.5*h,c=this.curViewPort.eS+.5*i)}else a?(b=this.curViewPort.sS+~~(f/4),c=this.curViewPort.eS-~~(f/4)):(b=this.curViewPort.sS-~~(f/4),c=this.curViewPort.eS+~~(f/4));this.setViewPort(b,c)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e}]),angular.module("emulvcApp").directive("trackmouseintier",["ConfigProviderService","viewState",function(a,b){return{restrict:"A",link:function(c,d){function e(a){var e=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),b.deleteEditArea(),j=c.getEvent(q,c.this.tier),k=c.getEventId(q,c.this.tier),l=c.getEvent(q,c.this.tier),m=c.getEventId(q,c.this.tier),b.setlasteditArea("_"+k),b.setcurClickTierName(e),b.setcurClickSegment(j,k),b.setTierLength(c.this.tier.events.length),p=q,c.$apply()}function f(a){var f=d.parent().parent().parent()[0].id;b.getcurClickTierName()!==f&&e(a),q=i(a)*b.getPCMpp(a),b.deleteEditArea(),j=c.getEvent(q,c.this.tier),k=c.getEventId(q,c.this.tier),l=c.getEvent(q,c.this.tier),m=c.getEventId(q,c.this.tier),b.setcurClickTierName(f),b.setcurClickSegmentMultiple(j,k),b.setTierLength(c.this.tier.events.length),p=q,c.$apply()}function g(a){var e=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),j=c.getEvent(q,c.this.tier),k=c.getEventId(q,c.this.tier),b.setcurClickTierName(e),b.setlasteditArea("_"+k),b.setcurClickSegment(j,k),b.setEditing(!0),b.setTierLength(c.this.tier.events.length),b.openEditArea(),c.cursorInTextField(),p=q,c.$apply()}function h(a,e){var f=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),n=c.getEvent(q,c.this.tier),o=c.getNearest(q,c.this.tier),b.setcurMouseTierName(f),e&&(b.setcurMouseSegment(n),b.setcurMouseSegmentId(o)),p=q,c.$apply()}function i(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var j,k,l,m,n,o,p,q;d.bind("click",function(a){h(a,!0),e(a)}),d.bind("contextmenu",function(a){a.preventDefault(),h(a,!0),f(a)}),d.bind("dblclick",function(b){h(b,!0),a.vals.restrictions.editItemName&&g(b)}),d.bind("mousemove",function(d){var e=!0;switch(q=i(d)*b.getPCMpp(d),d.which){case 1:break;case 2:break;case 3:break;default:b.getdragBarActive()===!1&&(a.vals.restrictions.editItemSize&&d.shiftKey?(b.deleteEditArea(),c.moveBorder(Math.floor(q-p),c.this.tier),p=q,b.selectBoundry(),b.movingBoundary=!0,c.$apply(),e=!1):b.movingBoundary=!1,a.vals.restrictions.editItemSize&&d.altKey&&(b.deleteEditArea(),c.moveSegment(Math.floor(q-p),c.this.tier),p=q,b.selectBoundry(),c.$apply()))}h(d,e)}),d.bind("mousedown",function(a){h(a,!0)}),d.bind("mouseup",function(a){h(a,!0)}),d.bind("mouseout",function(a){b.movingBoundary=!1,h(a,!0)})}}}]),angular.module("emulvcApp").directive("trackmouse",function(){return{restrict:"A",link:function(a,b){function c(b){d=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),d>e?(f=d,a.vs.select(e,f)):(e=d,a.vs.select(e,f)),a.$apply()}var d,e,f;b.bind("mousedown",function(b){e=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),f=e,a.vs.select(e,e),a.$apply()}),b.bind("mousemove",function(b){switch(b.which){case 1:a.vs.getdragBarActive()||c(b)}}),b.bind("mouseup",function(b){a.vs.getdragBarActive()||c(b)})}}}),angular.module("emulvcApp").directive("handleglobalkeystrokes",["viewState","Soundhandlerservice","ConfigProviderService","HistoryService",function(a,b,c,d){return{restrict:"A",link:function(e){$(document).bind("keydown",function(f){var g=f.keyCode?f.keyCode:f.which;e.$apply(function(){if(e.setlastkeycode(g,f.shiftKey),a.focusInTextField)a.isEditing()&&(g===c.vals.keyMappings.enter&&$("#HandletiersCtrl").scope().renameLabel(),g===c.vals.keyMappings.esc&&$("#HandletiersCtrl").scope().deleteEditArea(),13===g&&(f.preventDefault(),f.stopPropagation()));else{if(g===c.vals.keyMappings.shiftViewPortLeft&&a.shiftViewPort(!1),g===c.vals.keyMappings.shiftViewPortRight&&a.shiftViewPort(!0),g===c.vals.keyMappings.zoomOut&&a.zoomViewPort(!1),g===c.vals.keyMappings.zoomSel&&a.setViewPort(a.curViewPort.selectS,a.curViewPort.selectE),g===c.vals.keyMappings.selectFirstContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=1),g===c.vals.keyMappings.selectSecondContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=2),g===c.vals.keyMappings.selectThirdContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=3),g===c.vals.keyMappings.selectFourthContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=4),g===c.vals.keyMappings.selectNoContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=void 0),g===c.vals.keyMappings.zoomIn&&a.zoomViewPort(!0),g===c.vals.keyMappings.playEntireFile&&c.vals.restrictions.playback&&(b.playFromTo(0,b.wavJSO.Data.length),a.animatePlayHead(0,b.wavJSO.Data.length)),g===c.vals.keyMappings.playAllInView&&c.vals.restrictions.playback&&(b.playFromTo(a.curViewPort.sS,a.curViewPort.eS),a.animatePlayHead(a.curViewPort.sS,a.curViewPort.eS)),g===c.vals.keyMappings.playSelected&&c.vals.restrictions.playback&&(b.playFromTo(a.curViewPort.selectS,a.curViewPort.selectE),a.animatePlayHead(a.curViewPort.selectS,a.curViewPort.selectE)),g===c.vals.keyMappings.shiftViewPortRight&&a.shiftViewPort(!0),g===c.vals.keyMappings.zoomAll&&a.setViewPort(0,a.curViewPort.bufferLength),g===c.vals.keyMappings.tierUp&&$("#HandletiersCtrl").scope().selectTier(!1),g===c.vals.keyMappings.tierDown&&$("#HandletiersCtrl").scope().selectTier(!0),g===c.vals.keyMappings.snapBoundaryToTop&&c.vals.restrictions.editItemSize&&$("#HandletiersCtrl").scope().snapBoundary(!0),g===c.vals.keyMappings.snapBoundaryToBottom&&c.vals.restrictions.editItemSize&&$("#HandletiersCtrl").scope().snapBoundary(!1),g===c.vals.keyMappings.plus&&c.vals.restrictions.editItemSize&&$("#HandletiersCtrl").scope().expandSegment(!0,!0),g===c.vals.keyMappings.plusShift&&c.vals.restrictions.editItemSize&&$("#HandletiersCtrl").scope().expandSegment(!0,!1),g===c.vals.keyMappings.minus&&c.vals.restrictions.editItemSize&&(f.shiftKey?$("#HandletiersCtrl").scope().expandSegment(!1,!1):$("#HandletiersCtrl").scope().expandSegment(!1,!0)),g===c.vals.keyMappings.openSubmenu&&e.openSubmenu(),g===c.vals.keyMappings.spectroSettings&&e.openModal("views/spectroSettings.html","dialog"),g===c.vals.keyMappings.selectSegmentsInSelection&&$("#HandletiersCtrl").scope().selectSegmentsInSelection(),g===c.vals.keyMappings.tab&&(f.shiftKey?$("#HandletiersCtrl").scope().tabNext(!0):$("#HandletiersCtrl").scope().tabNext(!1)),g===c.vals.keyMappings.history&&d.goBackHistory()===!1&&a.getmodalOpen()===!1&&e.openModal("views/error.html","dialogSmall",!1,"History Error","No more history saved"),g===c.vals.keyMappings.backspace)if(f.shiftKey);else if(c.vals.restrictions.deleteItem){var h=a.getcurClickSegments();if(void 0!==h){for(var i="",j=0;j<h.length;j++)i+=h[j].label+",";i=i.substring(0,i.length-1),console.log(i),e.openModal("views/deleteSegment.html","dialogSmall",!1,"Really Delete",i)}}f.metaKey||(f.preventDefault(),f.stopPropagation())}})}),e.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emulvcApp").directive("delete",function(){return{restrict:"A",link:function(a,b){var c=a.this.tier.TierName;b.bind("click",function(){a.openModal("views/deleteTier.html","dialogSmall",c,c)})}}}),angular.module("emulvcApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=c.find("canvas"),e=b.parent().children()[0],f=b.parent().children()[2],g=c.find(e),h=c.find(f),i=!0,j="Tier",k="smallTier",l="TierCanvas",m="TierMarkupCanvas",n="smallCanvas";b.bind("click",function(){i?(i=!1,c.parent().parent()[0].className=k+" ng-scope",d[0].className=l+" "+n,d[1].className=m+" "+n,a.config.vals.activeButtons.deleteSingleTier&&g.hide(),a.config.vals.activeButtons.saveSingleTier&&h.hide()):(i=!0,c.parent().parent()[0].className=j+" ng-scope",d[0].className=l,d[1].className=m,a.config.vals.activeButtons.deleteSingleTier&&g.show(),a.config.vals.activeButtons.saveSingleTier&&h.show()),a.updateView()})}}}),angular.module("emulvcApp").directive("previewtrack",function(){return{restrict:"A",link:function(a,b){function c(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var d=-1;b.bind("click",function(b){if(!$.isEmptyObject(a.shs.wavJSO)){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}),b.bind("mousedown",function(b){$.isEmptyObject(a.shs.wavJSO)||(d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width))}),b.bind("mousemove",function(b){switch(event.which){case 1:if(-1!==d){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}}),b.bind("mouseup",function(){d=-1}),b.bind("mouseout",function(){d=-1})}}}),angular.module("emulvcApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","Httphandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p={};return p.wsH=n,p.getUttList=function(a){var b;return"http:GET"===k.vals.main.comMode?b=o.getUttList(a):"ws"===k.vals.main.comMode&&alert("handle ws case for get utt list"),b},p.getUtt=function(a){var b;return"http:GET"===k.vals.main.comMode?b=o.getUtt(a):"ws"===k.vals.main.comMode&&n.getUtt(a),b},p.toTextGrid=function(a){return j.toTextGrid(a)},p}]),angular.module("emulvcApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,c){var d=this.wavJSO.BitsPerSample/8,e=this.wavJSO.origArrBuf.subarray(0,44),f=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*d),g=new DataView(e);g.setUint32(40,(c-a)*d,!0);var h=f.subarray(a*d,(c-a)*d),i=new Uint8Array(e.byteLength+h.byteLength);i.set(new Uint8Array(e),0),i.set(new Uint8Array(h),e.byteLength);var j=b.arrayBufferToBase64(i.buffer);this.player.src="data:audio/wav;base64,"+j},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emulvcApp").directive("drawssff",function(){return{restrict:"A",link:function(a,b){function c(){if(!$.isEmptyObject(a.ssffds.data)&&0!==a.ssffds.data.length){var b=a.config.vals.signalsCanvasConfig.assign.spec.split(":"),c=b[1],g=d(a.ssffds.data,c);e(a.vs,f,a.config,g)}}function d(a,b){var c;return a.forEach(function(a){a.Columns.forEach(function(d){d.name===b&&(c=d,c.sampleRate=a.sampleRate,c.startTime=a.startTime)})}),c}function e(b,c,d,e){var f=c.getContext("2d");f.clearRect(0,0,c.width,c.height);var g=b.spectroSettings.rangeFrom,h=b.spectroSettings.rangeTo,i=b.getViewPortStartTime(),j=b.getViewPortEndTime(),k=Math.round(i*e.sampleRate+e.startTime),l=Math.round(j*e.sampleRate+e.startTime),m=l-k,n=e.values.slice(k,k+m);if(m<c.width&&m>=2){var o,p,q,r,s,t;n.forEach(function(d,m){d.forEach(function(u,v){if(v>=a.config.vals.signalsCanvasConfig.contourLims.fm.min&&v<=a.config.vals.signalsCanvasConfig.contourLims.fm.max)if(s=k+m,t=1/e.sampleRate*s+e.startTime,o=(t-i)/(j-i)*c.width,p=c.height-(u-g)/(h-g)*c.height,m===b.curPreselColumnSample&&b.curCorrectionToolNr-1===v?(f.strokeStyle="white",f.fillStyle="white"):(f.strokeStyle="hsl("+v*(360/d.length)+",80%, 50%)",f.fillStyle="hsl("+v*(360/d.length)+",80%, 50%)"),f.beginPath(),f.arc(o,p-1,2,0,2*Math.PI,!1),f.closePath(),f.stroke(),f.fill(),0!==m){if(s=k+m-1,t=1/e.sampleRate*s+e.startTime,q=(t-i)/(j-i)*c.width,r=c.height-(n[m-1][v]-g)/(h-g)*c.height,b.curCorrectionToolNr-1===v&&(f.strokeStyle="white",f.fillStyle="white"),f.beginPath(),f.moveTo(q,r),f.lineTo(o,p),f.stroke(),f.fill(),m===n.length-1&&l!==e.values.length-1){var w=e.values[l+1];u=w[v],s=l+1,t=1/e.sampleRate*s+e.startTime;var x=(t-i)/(j-i)*c.width,y=c.height-(u-g)/(h-g)*c.height;f.beginPath(),f.moveTo(o,p),f.lineTo(x,y),f.stroke(),f.fill()}}else if(0!==k){var z=e.values[k-1];u=z[v],s=k-1,t=1/e.sampleRate*s+e.startTime,q=(t-i)/(j-i)*c.width,r=c.height-(u-g)/(h-g)*c.height,b.curCorrectionToolNr-1===v&&(f.strokeStyle="white",f.fillStyle="white"),f.beginPath(),f.moveTo(q,r),f.lineTo(o,p),f.stroke(),f.fill()}})})}else{f.strokeStyle="red";var u,v;2>=m?(u="Zoom out to see contour(s)",v=f.measureText(u).width,f.strokeText(u,c.width/2-v/2,c.height/2)):(u="Zoom in to see contour(s)",v=f.measureText(u).width,f.strokeText(u,c.width/2-v/2,c.height/2))}}var f=b[0];a.$watch("vs.curViewPort",function(a,b){c(a,b)},!0),a.$watch("vs.curPreselColumnSample",function(a,b){c(a,b)},!0),a.$watch("vs.curCorrectionToolNr",function(a,b){c(a,b)},!0),a.$watch("ssffds.data",function(a,b){c(a,b)},!0),a.$watch("viewState.spectroSettings",function(a,b){c(a,b)},!0)}}}),angular.module("emulvcApp").service("Ssffparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.ssff2jso=function(a){var c=this;b.ssffData.Columns=[];var d=new Uint8Array(a),e=String.fromCharCode.apply(null,d),f=e.split(/^/m);(f[0]!==c.headID||f[1]!==c.machineID)&&alert("no ssff file... or missing fields"),"Record_Freq "!==f[2].split(/[ ,]+/)[0]||"Start_Time "!==f[3].split(/[ ,]+/)[0]?(this.ssffData.sampleRate=parseFloat(f[2].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,"")),this.ssffData.startTime=parseFloat(f[3].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))):alert("no ssff file... or missing fields ");
for(var g=4;g<f.length&&("Original_Freq"===f[g].split(/[ ,]+/)[0]&&(this.ssffData.origFreq=parseFloat(f[g].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),f[g]!==this.sepString);g++){var h=f[g].split(/[ ]+/);"Column"===h[0]&&this.ssffData.Columns.push({name:h[1],ssffdatatype:h[2],length:parseInt(h[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[]})}for(var i,j,k,l=f.slice(0,g+1).join("").length;l<=d.length;)for(g=0;g<this.ssffData.Columns.length;g++)"DOUBLE"===this.ssffData.Columns[g].ssffdatatype?(k=8*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Float64Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):"FLOAT"===this.ssffData.Columns[g].ssffdatatype?(k=4*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Float32Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):"SHORT"===this.ssffData.Columns[g].ssffdatatype?(k=2*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Uint16Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):alert("not supported... only doubles, floats, short  column types and for now");return this.ssffData},b.jso2ssff=function(a){var b=this,c=this.headID+this.machineID;c+="Record_Freq "+this.vs.round(a.sampleRate,1)+"\n",c+="Start_Time "+a.startTime+"\n",a.Columns.forEach(function(a){c+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),c+="Original_Freq DOUBLE "+this.vs.round(a.origFreq,1)+"\n",c+=this.sepString;var d,e,f=new Uint8Array(this.stringToUint(c));return d=new Uint16Array(a.Columns[0].length),e=a.Columns[0].values[0],a.Columns[0].values.forEach(function(c,e){a.Columns.forEach(function(a){if("SHORT"!==a.ssffdatatype)return alert("Only SHORT columns supported for now!!!"),void 0;d=new Uint16Array(a.length),a.values[e].forEach(function(a,b){d[b]=a});var c=new Uint8Array(d.buffer);f=b.Uint8Concat(f,c)})}),f.buffer},b.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},b.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},b}]),angular.module("emulvcApp").directive("correctiontool",function(){return{restrict:"A",link:function(a,b){b.bind("mousemove",function(b){if(void 0!==a.vs.curCorrectionToolNr){var c=a.ssffds.data[0].Columns[0],d=a.vs.getViewPortStartTime(),e=a.vs.getViewPortEndTime(),f=Math.round(d*c.sampleRate+c.startTime),g=Math.round(e*c.sampleRate+c.startTime),h=g-f,i=c.values.slice(f,f+h),j=d+a.dhs.getX(b)/b.originalEvent.srcElement.width*(e-d),k=Math.round((j+c.startTime)*c.sampleRate);a.vs.curPreselColumnSample=k-f-1,b.shiftKey&&(i[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]=a.vs.spectroSettings.rangeTo-a.dhs.getY(b)/b.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo,a.changingSSFFdata()),a.$apply()}})}}}),angular.module("emulvcApp").service("Drawhelperservice",function(){function a(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=a.curViewPort.eS-a.curViewPort.sS,j=a.curCursorPosInPercent*a.bufferLength-a.curViewPort.sS,k=j/i,l=f.width*k,m=1,n=Math.round(c*(f.height/d)),o=b*m,p=Math.round((f.height-n)/2),q=Math.round(e*(f.height/d)),r=(b-1)*m,s=Math.round((f.height-q)/2);l>=o?(h.fillStyle=g.vals.colors.playProgressColor,h.strokeStyle=g.vals.colors.playProgressColor):(h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor),h.beginPath(),h.moveTo(r,s),h.lineTo(o,p),h.stroke()}var b={};return b.osciPeaks=[],b.getX=function(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)},b.getY=function(a){return a.offsetY*(a.originalEvent.srcElement.height/a.originalEvent.srcElement.clientHeight)},b.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=-1/0,o=0,p=0,q=m.length;q>p;p++)m[p]>n&&(n=m[p]),o+=m[p];k+=o/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},b.freshRedrawDrawOsciOnCanvas=function(b,c,d,e,f){var g=c.getContext("2d");if(g.clearRect(0,0,c.width,c.height),d.peaks&&d.samplePerPx>=1)d.peaks.forEach(function(e,g){0!==g&&a(b,g,e,d.maxPeak,d.peaks[g-1],c,f)});else if(d.samplePerPx<1){{var h=1/d.samplePerPx/2;b.curViewPort.sS}g.strokeStyle=f.vals.colors.osciColor,g.fillStyle=f.vals.colors.osciColor;var i;if(0===b.curViewPort.sS){for(g.moveTo(h,(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),i=0;i<d.peaks.length;i++)g.lineTo(i/d.samplePerPx+h,(d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height);for(g.stroke(),i=0;i<d.peaks.length;i++)g.beginPath(),g.arc(i/d.samplePerPx+h,(d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill()}else{for(g.moveTo(-h,c.height-(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),i=1;i<d.peaks.length;i++)g.lineTo(i/d.samplePerPx-h,c.height-((d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height+3));for(g.stroke(),i=1;i<d.peaks.length;i++)g.beginPath(),g.arc(i/d.samplePerPx-h,c.height-(d.peaks[i]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill()}}if(g.strokeStyle=f.vals.colors.zeroLineColor,g.fillStyle=f.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&g.setLineDash([2]),d.samplePerPx>=1)g.beginPath(),g.moveTo(0,c.height/2),g.lineTo(c.width,c.height/2),g.stroke(),g.fillText("0",5,c.height/2-5,c.width);else{var j=c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height;g.beginPath(),g.moveTo(0,j),g.lineTo(c.width,j),g.stroke(),g.fill(),g.fillText("0",5,c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-5,c.width)}"Google Inc."===navigator.vendor&&g.setLineDash([0])},b}),angular.module("emulvcApp").service("HistoryService",["Ssffdataservice","Tierdataservice",function(a,b){var c={};return c.myHistory=[],c.myHistoryCounter=0,c.session=void 0,c.init=function(){c.history()},c.history=function(){var d=angular.copy({ssff:a.getData(),tier:b.getData()});if(c.myHistoryCounter>0){var e=angular.copy(c.myHistory[c.myHistoryCounter-1]);angular.equals(d,e)===!1&&(c.myHistory[c.myHistoryCounter]=d,++c.myHistoryCounter)}else c.myHistory[c.myHistoryCounter]=d,++c.myHistoryCounter},c.goBackHistory=function(){return c.myHistoryCounter>1?(a.setData(c.myHistory[c.myHistoryCounter-2].ssff),b.setData(c.myHistory[c.myHistoryCounter-2].tier),--c.myHistoryCounter,!0):!1},c}]),angular.module("emulvcApp").service("Wavparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.wav2jso=function(a){var b,c,d,e={};return b=0,c=a.subarray(b,4),d=new Uint8Array(c),e.ChunkID=String.fromCharCode.apply(null,d),"RIFF"!==e.ChunkID&&console.error("Wav read error: ChunkID not RIFF. Got "+e.ChunkID),b=4,c=a.subarray(b,4),d=new Uint32Array(c),e.ChunkSize=d[0],b=8,c=a.subarray(b,4),d=new Uint8Array(c),e.Format=String.fromCharCode.apply(null,d),"WAVE"!==e.Format&&console.error("Wav read error: Format not WAVE. Got "+e.Format),b=12,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk1ID=String.fromCharCode.apply(null,d),"fmt "!==e.Subchunk1ID&&console.error("Wav read error: Subchunk1ID not fmt. Got "+e.Subchunk1ID),b=16,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk1Size=d[0],16!==e.Subchunk1Size&&console.error("Wav read error: Subchunk1Size not 16"),b=20,c=a.subarray(b,2),d=new Uint16Array(c),e.AudioFormat=d[0],1!==e.AudioFormat&&console.error("Wav read error: AudioFormat not 1"),b=22,c=a.subarray(b,2),d=new Uint16Array(c),e.NumChannels=d[0],1!==e.NumChannels&&console.error("Wav read error: NumChannels not 1"),b=24,c=a.subarray(b,4),d=new Uint32Array(c),e.SampleRate=d[0],b=28,c=a.subarray(b,4),d=new Uint32Array(c),e.ByteRate=d[0],b=32,c=a.subarray(b,2),d=new Uint16Array(c),e.BlockAlign=d[0],b=34,c=a.subarray(b,2),d=new Uint16Array(c),e.BitsPerSample=d[0],16!==e.BitsPerSample&&console.error("Wav read error: NumChannels not 1"),b=36,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk2ID=String.fromCharCode.apply(null,d),"data"!==e.Subchunk2ID&&console.error("Wav read error: BitsPerSample not 16"),b=40,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk2Size=d[0],b=44,c=a.subarray(b,e.Subchunk2Size),d=new Int16Array(c),e.Data=d,e.origArrBuf=a,e},b}]),function(a){function b(a){var b=a.pageY,c=a.pageX,d=a.originalEvent.targetTouches;return d&&(c=d[0].pageX,b=d[0].pageY),{x:c,y:b}}function c(b,c,e){return b.each(function(){var b=a(this),f=c?a(c,this).css("cursor",e):b;f.bind(h,{e:b,k:e},d)})}function d(c){var d=b(c),h=function(a){return parseInt(g.css(a))||!1};return g=c.data.e,k={X:h("left")||0,Y:h("top")||0,H:h("height")||g[0].scrollHeight||0,pX:d.x,pY:d.y,k:c.data.k},a(".container").scope().dragStart(),a(document).bind(i,e).bind(j,f),l=a(document).height()-2*a(".menu-bottom").height(),!1}function e(c){var d=b(c),e=Math.max(d.y-k.pY+k.H,0);return l>e&&(g.css({height:e}),a(".container").scope().refreshTimeline(),a(".HandletiersCtrl").css("padding-top",a(".TimelineCtrl").height()+2*a(".menu").height()+"px")),!1}function f(){a(".container").scope().dragEnd(),a(document).unbind(i,e).unbind(j,f)}var g,h="mousedown touchstart",i="mousemove touchmove",j="mouseup touchend",k={},l=0;a.fn.ownResize=function(a){return c(this,a,"ns-resize")}}(jQuery),angular.module("emulvcApp").service("Textgridparserservice",["Soundhandlerservice","viewState",function(a,b){var c={};return c.shs=a,c.l1='File type = "ooTextFile"',c.l2='Object class = "TextGrid"',c.toJSO=function(a){a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g,"");var b,c,d,e,f=a.split("\n"),g=!0,h={origSamplerate:this.shs.wavJSO.SampleRate,fileURI:"",tiers:[]};if(f[0].replace(/\s+/g,"")===this.l1.replace(/\s+/g,"")&&f[1].replace(/\s+/g,"")===this.l2.replace(/\s+/g,"")){for(var i=2;i<f.length;i++){var j=f[i];if("item[]:"!==j){if(!g)if(0===j.indexOf("item[")&&(b='"IntervalTier"'===f[i+1].split(/=/)[1]?"seg":"point",c=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers.push({TierName:c,type:b,events:[]})),h.tiers.length>0&&"seg"===h.tiers[h.tiers.length-1].type&&0===j.indexOf("intervals")&&0!==j.indexOf("intervals:")){var k=Math.ceil(f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate),l=Math.floor(f[i+2].split(/=/)[1]*this.shs.wavJSO.SampleRate);e=f[i+3].split(/=/)[1].replace(/"/g,""),0===k&&(k+=1),h.tiers[h.tiers.length-1].events.push({label:e,startSample:k-1,sampleDur:l-k})}else h.tiers.length>0&&"point"===h.tiers[h.tiers.length-1].type&&0===j.indexOf("points")&&0!==j.indexOf("points:")&&(d=f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate,e=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers[h.tiers.length-1].events.push({label:e,startSample:Math.round(d)}))}else g=!1}return this.testForGapsInLabelJSO(h),h}alert("bad header in TextGrid file!!! The header has to be: ",this.l1,"\n",this.l2)},c.toTextGrid=function(){var b='File type = "ooTextFile"',d='Object class = "TextGrid"',e="",f="\n",g="	";e=e+b+f+d+f+f,e=e+"xmin = "+c.findTimeOfMinSample()+f,e=e+"xmax = "+c.findTimeOfMaxSample()+f,e=e+"tiers? <exists>"+f,e=e+"size = "+$("#HandletiersCtrl").scope().getTierLength()+f,e=e+"item []:"+f;var h=0;return $("#HandletiersCtrl tier").each(function(){var b=$("#HandletiersCtrl").scope().getTier($(this).attr("id"));h+=1,e=e+g+"item ["+h+"]:"+f,"seg"===b.type?e=e+g+g+'class = "IntervalTier"'+f:"point"===b.type&&(e=e+g+g+'class = "TextTier"'+f),e=e+g+g+'name = "'+b.TierName+'"'+f,e=e+g+g+"xmin = "+c.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+c.findTimeOfMaxSample()+f,"seg"===b.type?e=e+g+g+"intervals: size = "+b.events.length+f:"point"===b.type&&(e=e+g+g+"points: size = "+b.events.length+f);for(var d=0;d<b.events.length;d++){var i=d+1;"seg"===b.type?(e=e+g+g+g+"intervals ["+i+"]:"+f,e=0!==b.events[d].startSample?e+g+g+g+g+"xmin = "+(b.events[d].startSample/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmin = 0"+f,e=d<b.events.length-1?e+g+g+g+g+"xmax = "+((b.events[d].startSample+b.events[d].sampleDur+1)/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmax = "+c.findTimeOfMaxSample()+f,e=e+g+g+g+g+'text = "'+b.events[d].label+'"'+f):"point"===b.type&&(e=e+g+g+g+"points["+i+"]:"+f,e=e+g+g+g+g+"time = "+b.events[d].startSample/a.wavJSO.SampleRate+f,e=e+g+g+g+g+'mark = "'+b.events[d].label+'"'+f)}}),e},c.findTimeOfMinSample=function(){return 0},c.findTimeOfMaxSample=function(){return b.curViewPort.bufferLength/a.wavJSO.SampleRate},c.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.tiers.length;c++)if("seg"===a.tiers[c].type)for(var d=0;d<a.tiers[c].events.length-1;d++)a.tiers[c].events[d].startSample+a.tiers[c].events[d].sampleDur+1!==a.tiers[c].events[d+1].startSample&&(b+=1)},c}]),angular.module("emulvcApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emulvcApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=5,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth,i=document.createElement("canvas"),j=i.getContext("2d");return j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth,k=document.createElement("canvas"),l=k.getContext("2d");if(l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return k},a}),angular.module("emulvcApp").directive("draggable",["$rootScope","uuid",function(a,b){return{restrict:"A",link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragstart",function(b){b.originalEvent.dataTransfer.setData("text",e),angular.element(d).addClass("dragDragging"),a.$emit("dragStart")}),d.bind("dragend",function(){angular.element(d).removeClass("dragDragging"),a.$emit("dragEnd")})}}}]),angular.module("emulvcApp").directive("dropable",["$rootScope","uuid",function(a,b){return{restrict:"A",scope:{onDrop:"&"},link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move",!1}),d.bind("dragenter",function(a){angular.element(a.target).addClass("dragOver")}),d.bind("dragleave",function(a){angular.element(a.target).removeClass("dragOver")}),d.bind("drop",function(a){a.preventDefault&&a.preventDefault(),a.stopPropogation&&a.stopPropogation();var b=a.originalEvent.dataTransfer.getData("text"),d=document.getElementById(e),f=document.getElementById(b);angular.element(a.target).removeClass("dragTarget"),angular.element(a.target).removeClass("dragOver"),c.drop(f,d)}),a.$on("dragStart",function(){var a=document.getElementById(e);angular.element(a).addClass("dragTarget")}),a.$on("dragEnd",function(){var a=document.getElementById(e);angular.element(a).removeClass("dragTarget"),angular.element(a).removeClass("dragOver")})}}}]),angular.module("emulvcApp").service("Espsparserservice",["Soundhandlerservice",function(a){var b={};return b.toJSO=function(b,c){var d="_"+c.split(".")[c.split(".").length-1];b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/[ \t]+/g," ");for(var e,f=b.split("\n"),g=0;g<f.length;g++)if("#"===f[g]){e=g;break}var h={fileInfos:[{fileURI:"",fileType:"esps",associatedTierNames:[d]}],tiers:[]};h.tiers.push({TierName:d,type:"",events:[]});var i,j=f[e+1].split(/\s+/);if(h.tiers[0].type="H#"!==j[j.length-1]?"point":"seg","point"===h.tiers[0].type)for(g=e+1;g<f.length-1;g++)j=f[g].split(/\s+/),h.tiers[0].events.push({label:j[j.length-1],startSample:Math.round(j[1]*a.wavJSO.SampleRate)});else for(j=f[e+1].split(/\s+/),h.tiers[0].events.push({label:"",startSample:0,sampleDur:Math.round(j[1]*a.wavJSO.SampleRate)}),g=e+2;g<f.length-1;g++)j=f[g].split(/\s+/),i=f[g-1].split(/\s+/),h.tiers[0].events.push({label:j[j.length-1],startSample:Math.round(i[1]*a.wavJSO.SampleRate),sampleDur:Math.round((j[1]-i[1])*a.wavJSO.SampleRate)});return h},b}]),angular.module("emulvcApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState",function(a,b,c,d,e,f){a.username="",a.passcode="",a.loginError="",a.tryLogin=function(){a.passcode===d.vals.userManagment.passcode?(a.loginError="CORRECT PASSCODE!... getting users utterance list...",e.wsH.getUsrUttList(a.username).then(function(c){"USER NOT FOUND"===c?a.loginError=c:(a.loginError="USER FOUND",b.$broadcast("newUserLoggedOn",a.username),a.cancel())})):a.loginError="WRONG PASSCODE!"},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1}}]),angular.module("emulvcApp").service("Ssffdataservice",function(){var a={};return a.data=[],a.getData=function(){return a.data},a.setData=function(b){angular.copy(b,a.data)},a}),angular.module("emulvcApp").service("Tierdataservice",function(){var a={};return a.data={},a.getData=function(){return a.data},a.setData=function(b){angular.copy(b,a.data)},a}),angular.module("emulvcApp").service("Websockethandler",["$q","$rootScope","$location","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a,c){var d=j.toJSO(c,a);b.$broadcast("newlyLoadedLabelJson",d)}function n(a,c){var d=l.base64ToArrayBuffer(c),f=e.ssff2jso(d);f.fileURL=document.URL+a,b.$broadcast("newlyLoadedSSFFfile",f,a.replace(/^.*[\\\/]/,""))}function o(a){b.$broadcast("connectedToWSserver"),b.$apply(y.resolve(a))}function p(a){t(JSON.parse(a.data))}function q(a){console.log(a),console.log("WEBSOCKET ERROR!!!!!"),b.$apply(y.resolve(a))}function r(a){console.log(a),console.log("WEBSOCKET closed!!!!!")}function s(b){var c=a.defer(),d=u();return w[d]={time:new Date,cb:c},b.callbackID=d,x.send(JSON.stringify(b)),c.promise}function t(a){var c=a;if(w.hasOwnProperty(c.callbackID)){switch(console.log("resolving callback: "+c.type+" Nr.: "+c.callbackID),c.type){case"getESPSfile":m(c.fileName,c.data);break;case"getSSFFfile":n(c.fileName,c.data)}b.$apply(w[c.callbackID].cb.resolve(c.data)),delete w[c.callbackID]}}function u(){var a=k.new();return console.log(a),a}var v={},w={},x={},y={};return v.initConnect=function(b){var c=a.defer();return x=new WebSocket(b),x.onopen=o,x.onmessage=p,x.onerror=q,x.onclose=r,y=c,c.promise},v.closeConnect=function(){x.onclose=function(){},x.close()},v.getProtocol=function(){var a={type:"getProtocol"},b=s(a);return b},v.getDoUserManagement=function(){var a={type:"getDoUserManagement"},b=s(a);return b},v.getConfigFile=function(){var a={type:"getConfigFile"},b=s(a);return b},v.getUsrUttList=function(a){var b={type:"getUttList",usrName:a},c=s(b);return c},v.getSSFFfile=function(a){var b={type:"getSSFFfile",fileName:a},c=s(b);return c},v.getESPSfile=function(a){var b={type:"getESPSfile",fileName:a},c=s(b);return c},v.getAudioFile=function(a){var b={type:"getAudioFile",fileName:a},c=s(b);return c},v.saveUsrUttList=function(a,b){var c=angular.toJson(b),d={type:"saveUttList",usrName:a,data:c},e=s(d);return e},v.saveSSFFfile=function(a,b){for(var d=e.jso2ssff(b),f="",g=new Uint8Array(d),h=g.byteLength,i=0;h>i;i++)f+=String.fromCharCode(g[i]);var j=window.btoa(f),k={type:"saveSSFFfile",usrName:a,fileURL:b.fileURL.split(c.absUrl())[1],data:j},l=s(k);return l},v.getUtt=function(c){var d;d=v.findFileInUtt(c,f.vals.signalsCanvasConfig.extensions.audio),v.getAudioFile(d).then(function(a){var b=l.base64ToArrayBuffer(a);console.log(typeof b);var c=h.wav2jso(b);return c}).then(function(a){g.curViewPort.sS=0,g.curViewPort.eS=a.Data.length,g.curViewPort.bufferLength=a.Data.length,g.setscrollOpen(0),g.resetSelect(),i.wavJSO=a,b.$broadcast("cleanPreview")}).then(function(){f.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){d=v.findFileInUtt(c,a),v.getSSFFfile(d)})}).then(function(){f.vals.labelCanvasConfig.order.forEach(function(b){var e=a.defer();d=v.findFileInUtt(c,b);var f=v.getESPSfile(d);e.resolve(f)})})},v.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},v}]),angular.module("emulvcApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState",function(a,b,c,d){a.wsServerUrl=b.vals.main.wsServerUrl,a.connectionError="",d.focusInTextField=!0,a.tryConnection=function(){console.log(a.wsServerUrl);var b=c.wsH.initConnect(a.wsServerUrl);b.then(function(b){"error"===b.type?a.connectionError="ERROR trying to connect to ws-server":"open"===b.type&&(d.focusInTextField=!1,a.cancel())})}}]),angular.module("emulvcApp").service("Httphandler",["$rootScope","$http","HistoryService","viewState","ConfigProviderService","Soundhandlerservice","Ssffparserservice","Wavparserservice","Espsparserservice",function(a,b,c,d,e,f,g,h,i){var j={};return j.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},j.getUttList=function(a){var c=b.get(a);return c},j.getSSFFfile=function(c){b.get(c,{responseType:"arraybuffer"}).success(function(b){var d=g.ssff2jso(b);d.fileURL=document.URL+c,a.$broadcast("newlyLoadedSSFFfile",d,c.replace(/^.*[\\\/]/,""))})},j.getESPS=function(c){b.get(c).success(function(b){var d=i.toJSO(b,c);a.$broadcast("newlyLoadedLabelJson",d)}).error(function(a,b){console.log("Request failed with status: "+b)})},j.getUtt=function(g){var i;i=j.findFileInUtt(g,e.vals.signalsCanvasConfig.extensions.audio),b.get(i,{responseType:"arraybuffer"}).then(function(a){var b=h.wav2jso(a.data);return b}).then(function(b){d.curViewPort.sS=0,d.curViewPort.eS=b.Data.length,d.curViewPort.bufferLength=b.Data.length,d.setscrollOpen(0),d.resetSelect(),f.wavJSO=b,a.$broadcast("cleanPreview")}).then(function(){e.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){i=j.findFileInUtt(g,a),j.getSSFFfile(i)})}).then(function(){e.vals.labelCanvasConfig.order.forEach(function(a){i=j.findFileInUtt(g,a),console.log(i),j.getESPS(i)})}).then(function(){console.log("history"),c.history()})},j}]),angular.module("emulvcApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a.stringToArrayBuffer=function(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d<a.length;++d)c[d]=a.charCodeAt(d);return b},a});