"use strict";ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emulvcApp",["ui","ui.bootstrap","ngRoute","ngAnimate","ngProgressLite"]).config(["$routeProvider","$locationProvider","ngProgressLiteProvider",function(a,b,c){a.when("/",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.settings.speed=1500}]),angular.module("emulvcApp").service("ConfigProviderService",["viewState",function(a){var b={};return b.vals={},b.curDbConfig={},b.setVals=function(a){$.isEmptyObject(b.vals)?b.vals=a:Object.keys(a).forEach(function(c){angular.isArray(b.vals[c])?(b.vals[c]=[],a[c].forEach(function(a){b.vals[c].push(a)})):Object.keys(a[c]).forEach(function(d){void 0!==b.vals[c][d]?b.vals[c][d]=a[c][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+c+" key2: "+d)})})},b.getSsffTrackConfig=function(a){var c;return b.curDbConfig.ssffTracks.forEach(function(b){b.name===a&&(c=b)}),c},b.getLimsOfTrack=function(c){var d={};return b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourLims.forEach(function(a){a.ssffTrackName===c&&(d.min=a.min,d.max=a.max)}),d},b}]),angular.module("emulvcApp").controller("MainCtrl",["$scope","$rootScope","$modal","$log","$compile","$timeout","$window","$document","ngProgressLite","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","Levelservice","dialogService","Textgridparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){a.cps=n,a.hists=k,a.fontImage=o,a.tds=q,a.vs=j,a.dials=r,a.connectBtnLabel="connect",a.tmp={},a.tmp.showSaveCommStaBtnDiv=!1,a.dbLoaded=!1,a.isRightSideMenuHidden=!0,a.is2dCancasesHidden=!0,a.showDropZone=!0,a.lastkeycode="N/A",a.bundleList=[],a.curUserName="",a.curUtt={},a.modifiedCurLevelItems=!1,a.modifiedCurSSFF=!1,a.modifiedMetaData=!1,a.lastclickedutt=null,a.shortcut=null,a.filterText="",a.windowWidth=g.outerWidth,angular.element(g).bind("resize",function(){a.refreshTimeline(),j.deleteEditArea(),a.windowWidth=g.outerWidth,a.$apply("windowWidth")}),angular.element(g).bind("keyup",function(a){(a.keyCode===n.vals.keyMappings.shift||a.keyCode===n.vals.keyMappings.alt)&&k.addCurChangeObjToUndoStack()}),$(".TimelineCtrl").ownResize(".resizer"),a.$on("newUserLoggedOn",function(b,c){a.curUserName=c,j.setState("loadingSaving"),l.getUsrUttList(c).then(function(b){l.getUtt(b[0]).then(function(c){console.log(c),j.setState("labeling"),a.curUtt=b[0],$("#FileCtrl").scope().hideDropZone(),j.getsubmenuOpen()||a.openSubmenu(),a.bundleList=b,a.curUtt=b[0]})})}),a.$on("loadingNewUtt",function(){j.resetSelect(),j.setcurClickLevelName(void 0)}),a.$on("saveSSFFb4load",function(){console.log("saving utt"),l.wsH.saveSSFFfile(a.curUserName,p.data[0]),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),l.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.$on("discardSSFFb4load",function(){console.log("discarding ssff changes"),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),l.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.loadDefaultConfig=function(){l.httpGetDefaultConfig().success(function(b){n.setVals(b),a.handleDefaultConfigLoaded()}).error(function(a,b,c,d){r.open("views/error.html","ModalCtrl","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d)})},a.loadDefaultConfig(),a.handleDefaultConfigLoaded=function(){j.getsubmenuOpen()||a.openSubmenu(),a.shortcut=Object.create(n.vals.keyMappings);for(var b in a.shortcut)8===a.shortcut[b]?a.shortcut[b]="BACKSPACE":9===a.shortcut[b]?a.shortcut[b]="TAB":13===a.shortcut[b]?a.shortcut[b]="ENTER":16===a.shortcut[b]?a.shortcut[b]="SHIFT":18===a.shortcut[b]?a.shortcut[b]="ALT":27===a.shortcut[b]?a.shortcut[b]="ESC":32===a.shortcut[b]?a.shortcut[b]="SPACE":-1===a.shortcut[b]?a.shortcut[b]="NONE":38===a.shortcut[b]?a.shortcut[b]="ARROW UP":40===a.shortcut[b]?a.shortcut[b]="ARROW DOWN":187===a.shortcut[b]?a.shortcut[b]="+":189===a.shortcut[b]?a.shortcut[b]="-":a.shortcut[b.toString()]=String.fromCharCode(a.shortcut[b]);n.vals.main.autoConnect&&l.wsH.initConnect(n.vals.main.wsServerUrl).then(function(b){"error"===b.type?r.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+n.vals.main.wsServerUrl):a.handleConnectedToWSserver()}),j.setspectroSettings(n.vals.spectrogramSettings.N,n.vals.spectrogramSettings.rangeFrom,n.vals.spectrogramSettings.rangeTo,n.vals.spectrogramSettings.dynamicRange,n.vals.spectrogramSettings.window),$(".TimelineCtrl").css("height",n.vals.colors.timelineHeight),$(".HandleLevelsCtrl").css("padding-top",$(".TimelineCtrl").height()+2*$(".menu").height()+"px"),j.setTransitionTime(n.vals.colors.transitionTime/1e3),n.vals.restrictions.sortLabels,console.log(),$("#"+n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order[1]).insertBefore("#"+n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order[0]),$("#"+n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order[0]).insertBefore("#"+n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order[1])},a.handleConnectedToWSserver=function(){a.showDropZone=!1,n.vals.main.comMode="WS",a.showSaveCommStaBtnDiv=!0,l.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.1"===b.version?(l.getDoUserManagement().then(function(b){"NO"===b?l.getDBconfigFile().then(function(b){n.setVals(b.EMUwebAppConfig),delete b.EMUwebAppConfig,n.curDbConfig=b,l.getBundleList().then(function(b){a.bundleList=b,a.menuBundleClick(a.bundleList[0])})}):r.open("views/error.html","ModalCtrl","We are sorry but the EMU-webApp does not support user management yet...")}),n.vals.main.autoConnect&&(a.connectBtnLabel="disconnect")):(r.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+n.vals.main.wsServerUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"'),l.wsH.closeConnect())})},a.downloadTextGrid=function(){console.log(l.toTextGrid())},a.refreshTimeline=function(){a.$broadcast("refreshTimeline")},a.refreshScope=function(){a.$digest()},a.getShortCut=function(b){return null!==a.shortcut?null!==a.shortcut[b]&&""!==a.shortcut[b]?a.shortcut[b]:"NONE":"NOT SET"},a.menuBundleClick=function(b){k.getNrOfPosibleUndos()>0&&(a.modifiedCurSSFF=!0),a.modifiedCurSSFF||a.modifiedCurLevelItems?(a.lastclickedutt=b,r.open("views/saveChanges.html","ModalCtrl",b.name)):b!==a.curUtt&&(p.data=[],l.getBundle(b.name).then(function(c){200===c.status&&(c=c.data),i.done();var d;d=t.base64ToArrayBuffer(c.mediaFile.data);var e=u.wav2jso(d);j.curViewPort.sS=0,j.curViewPort.eS=e.Data.length,j.curViewPort.bufferLength=e.Data.length,j.setscrollOpen(0),j.resetSelect(),m.wavJSO=e,d=t.base64ToArrayBuffer(c.ssffFiles[0].data);var f=v.ssff2jso(d,c.ssffFiles[0].ssffTrackName);p.data.push(f),q.setData(c.annotation),a.curUtt=b,j.setState("labeling")}))},a.menuUttSave=function(){l.saveUtt(a.curUtt).then(function(){a.modifiedCurSSFF=!1,a.modifLevelItems=!1})},a.dragStart=function(){j.setdragBarActive(!0)},a.dragEnd=function(){j.setdragBarActive(!1)},a.uttIsDisabled=function(b){return b.name===a.curUtt.name?!1:!0},a.getUttColor=function(b){var c;return c=k.getNrOfPosibleUndos()>0?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curUtt.name?c:void 0},a.getMetaBtnColor=function(){var b;return b=a.modifiedMetaData?{color:"red"}:{color:"rgb(128,230,25)"}},a.cursorInTextField=function(){j.focusInTextField=!0},a.cursorOutOfTextField=function(){j.focusInTextField=!1},a.openSubmenu=function(){j.setsubmenuOpen(j.getsubmenuOpen()?!1:!0),f(a.refreshTimeline,n.vals.colors.transitionTime)},a.addLevelSegBtnClick=function(){j.getPermission("addLevelSegBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.addLevelPointBtnClick=function(){j.getPermission("addLevelPointBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.renameSelLevelBtnClick=function(){j.getPermission("renameSelLevelBtnClick")?void 0!==j.getcurClickLevelName()?r.open("views/renameLevel.html","ModalCtrl",j.getcurClickLevelName()):r.open("views/error.html","ModalCtrl","Rename Error : Please choose a Level first !"):console.log("action currently not allowed")},a.downloadTextGridBtnClick=function(){j.getPermission("downloadTextGridBtnClick")?r.openExport("views/export.html","ExportCtrl",s.toTextGrid(q.data),"textgrid.txt"):console.log("action currently not allowed")},a.spectSettingsBtnClick=function(){j.getPermission("spectSettingsChange")?r.open("views/spectroSettings.html","SpectsettingsCtrl"):console.log("action currently not allowed")},a.connectBtnClick=function(){j.getPermission("connectBtnClick")?r.open("views/connectModal.html","WsconnectionCtrl").then(function(b){b&&l.wsH.initConnect(b).then(function(b){"error"===b.type?r.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+n.vals.main.wsServerUrl):a.handleConnectedToWSserver()})}):console.log("action currently not allowed")},a.openDemoDBbtnClick=function(){j.getPermission("openDemoBtnDBclick")?(n.vals.main.comMode="DEMO",j.setState("loadingSaving"),l.getDBconfigFile().then(function(b){n.setVals(b.data.EMUwebAppConfig),delete b.data.EMUwebAppConfig,n.curDbConfig=b.data,l.getBundleList().then(function(b){a.showDropZone=!1,a.bundleList=b.data,a.menuBundleClick(a.bundleList[0]),j.setState("labeling")})})):console.log("action currently not allowed")},a.aboutBtnClick=function(){r.open("views/about.html","AboutCtrl")},a.clearBtnClick=function(){r.open("views/confirmModal.html","ConfirmmodalCtrl","Do you wish to clear all loaded data and if connected disconnect from the server? This will also delete any unsaved changes...").then(function(b){b&&(l.wsH.isConnected()&&l.wsH.closeConnect(),a.bundleList=[],m.wavJSO={},q.data={},p.data=[],a.showDropZone=!0,a.loadDefaultConfig(),a.$broadcast("refreshTimeline"),j.setState("noDBorFilesloaded"))})},a.cmdZoomAll=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.setViewPort(0,j.curViewPort.bufferLength)):console.log("action currently not allowed")},a.cmdZoomIn=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.zoomViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomOut=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.zoomViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomLeft=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.shiftViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomRight=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.shiftViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomSel=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.setViewPort(j.curViewPort.selectS,j.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayView=function(){j.getPermission("playaudio")?(m.playFromTo(j.curViewPort.sS,j.curViewPort.eS),j.animatePlayHead(j.curViewPort.sS,j.curViewPort.eS)):console.log("action currently not allowed")},a.cmdPlaySel=function(){j.getPermission("playaudio")?(m.playFromTo(j.curViewPort.selectS,j.curViewPort.selectE),j.animatePlayHead(j.curViewPort.selectS,j.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayAll=function(){j.getPermission("playaudio")?(m.playFromTo(0,m.wavJSO.Data.length),j.animatePlayHead(0,m.wavJSO.Data.length)):console.log("action currently not allowed")},a.saveMetaData=function(){l.wsH.saveUsrUttList(a.curUserName,a.bundleList),a.modifiedMetaData=!1},a.openFile=function(){alert("code to open file")},a.setlastkeycode=function(b){a.lastkeycode=b},a.toggleRightSideMenuHidden=function(){a.isRightSideMenuHidden=!a.isRightSideMenuHidden},a.toggle2dCancases=function(){a.is2dCancasesHidden=!a.is2dCancasesHidden},a.changePerspective=function(b){for(var c,d=0;d<n.vals.perspectives.length;d++)console.log(n.vals.perspectives[d].name),b.name===n.vals.perspectives[d].name&&(c=d);j.curPerspectiveIdx=c,a.toggleRightSideMenuHidden()},a.getPerspectiveColor=function(a){var b;return b=a.name===n.vals.perspectives[j.curPerspectiveIdx].name?{"background-color":"#999",color:"white"}:{"background-color":"white",color:"black"}}}]),angular.module("emulvcApp").controller("FileCtrl",["$scope","viewState","Iohandlerservice","Soundhandlerservice","ConfigProviderService","dialogService","Wavparserservice",function(a,b,c,d,e,f,g){a.dropzone=document.getElementById("dropzone"),a.dropDefault="Drop your files here or click here to open a file",a.dropNotAllowed="File is not allowed",a.dropAllowed="Drop files to start loading",a.dropParsingStarted="Parsing started",a.wavLoaded=0,a.txtGridLoaded=0,a.labelLoaded=0,a.dropText=a.dropDefault,a.hideDropZone=function(){a.dropClass="hidden"},a.loadFiles=function(){f.open("views/error.html","ModalCtrl","Currently the EMU-webApp does not support this feature! Sorry... ")},a.showDropZone=function(){a.dropClass=""},a.traverseFileTree=function(b,c){if(c=c||"",b.isFile)b.file(function(b){var c=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();if("WAV"===c&&b.type.match("audio/wav")&&window.File&&window.FileReader&&window.FileList&&window.Blob){var d=new FileReader;d.readAsArrayBuffer(b),d.onloadend=function(a){a.target.readyState==FileReader.DONE&&console.log(g.wav2jso(a.target.result))},++a.wavLoaded,a.$apply()}"TEXTGRID"===c&&(++a.txtGridLoaded,a.$apply()),("LAB"===c||"TONE"===c)&&(++a.labelLoaded,a.$apply())});else if(b.isDirectory){var d=b.createReader();d.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTree(d[e],c+b.name+"/")})}}}]),angular.module("emulvcApp").directive("level",function(){return{templateUrl:"views/level.html",restrict:"E",link:function(a,b){function c(b,c,d){if(!$.isEmptyObject(b)&&!$.isEmptyObject(c)&&!$.isEmptyObject(d)){var f=e[0].getContext("2d");f.clearRect(0,0,e[0].width,e[0].height);var g,h,i,j;g=c.getSampleDist(e[0].width),j=a.fontImage.getTextImageTwoLines(f,b.name,"("+b.type+")",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor,!1),f.drawImage(j,0,0,j.width,j.height,5,0,j.width,j.height);var k=(c.getcurMouseSegment(),c.getcurClickSegments(),c.getcurClickLevelName(),-1);if("SEGMENT"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var l=b.items;l.forEach(function(g){if(++k,g.sampleStart>=c.curViewPort.sS&&g.sampleStart<=c.curViewPort.eS||g.sampleStart+g.sampleDur>c.curViewPort.sS&&g.sampleStart+g.sampleDur<c.curViewPort.eS||g.sampleStart<c.curViewPort.sS&&g.sampleStart+g.sampleDur>c.curViewPort.eS){var l;g.labels.forEach(function(a){a.name===b.name&&(l=a.value)}),h=c.getPos(e[0].width,g.sampleStart),i=c.getPos(e[0].width,g.sampleStart+g.sampleDur),f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(h,0,2,e[0].height/2),f.fillStyle=d.vals.colors.endBoundaryColor,f.fillRect(i,e[0].height/2,2,e[0].height),j=a.fontImage.getTextImage(f,l,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor);var m=a.fontImage.getLastImageWidth(),n=h+(i-h)/2-m/2;i-h>m&&f.drawImage(j,0,0,j.width,j.height,n,e[0].height/2-d.vals.font.fontPxSize,j.width,j.height);var o=a.fontImage.getTextImage(f,g.sampleStart,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),p=a.fontImage.getLastImageWidth(),q=h+(i-h)/2-p/2,r=a.fontImage.getTextImage(f,"dur: "+g.sampleDur,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),s=a.fontImage.getLastImageWidth();f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(h,e[0].height/4),f.lineTo(q+p/2,e[0].height/4),f.lineTo(q+p/2,e[0].height/4+10),f.stroke(),f.strokeStyle=d.vals.colors.endBoundaryColor,f.beginPath(),f.moveTo(i,e[0].height/4*3),f.lineTo(q+p/2,e[0].height/4*3),f.lineTo(q+p/2,e[0].height/4*3-10),f.stroke(),m>=i-h&&(f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(q+p/2,e[0].height/4+10),f.lineTo(q+p/2,e[0].height/4+30),f.stroke()),i-h>p&&f.drawImage(o,0,0,j.width,j.height,h+3,0,j.width,j.height),i-h>s&&f.drawImage(r,0,0,j.width,j.height,i-s,e[0].height/4*3-5,j.width,j.height)}})}else if("EVENT"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var m;b.items.forEach(function(h){if(h.samplePoint>c.curViewPort.sS&&h.samplePoint<c.curViewPort.eS){m=Math.round(c.getPos(e[0].width,h.samplePoint)+g/2);var i;h.labels.forEach(function(a){a.name===b.name&&(i=a.value)}),f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(m,0,1,e[0].height/2-e[0].height/10),f.fillRect(m,e[0].height/2+e[0].height/10,1,e[0].height/2-e[0].height/10),j=a.fontImage.getTextImage(f,i,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor),f.drawImage(j,0,0,j.width,j.height,m-5,e[0].height/3,j.width,j.height),j=a.fontImage.getTextImage(f,h.samplePoint,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.startBoundaryColor),f.drawImage(j,0,0,j.width,j.height,m+5,0,j.width,j.height)}})}}}function d(b,c,d){var f=e[1].getContext("2d");f.clearRect(0,0,e[1].width,e[1].height),b.name===c.getcurClickLevelName()&&(f.fillStyle=d.vals.colors.selectedLevelColor,f.fillRect(0,0,e[0].width,e[0].height)),a.dhs.drawMovingBoundaryLine(f),a.dhs.drawCurViewPortSelected(f);var g,h,i,j,k;g=c.getPos(e[1].width,c.curViewPort.selectS),h=c.getPos(e[1].width,c.curViewPort.selectE),i=c.getSampleDist(e[1].width);var l=c.getcurMouseSegment(),m=c.getcurClickSegments(),n=c.getcurClickLevelName();void 0!==m&&b.name===n&&m.length>0&&m.forEach(function(a){void 0!==a&&(g=Math.round(c.getPos(e[0].width,a.sampleStart)),h=Math.round(c.getPos(e[0].width,a.sampleStart+a.sampleDur)),f.fillStyle=d.vals.colors.selectedSegmentColor,f.fillRect(g,0,h-g,e[0].height),f.fillStyle=d.vals.colors.startBoundaryColor)}),k=c.getcurMouseSegment(),void 0!==k&&void 0!==l&&b.name===c.getcurMouseLevelName()&&(f.fillStyle=d.vals.colors.selectedBoundaryColor,"SEGMENT"===c.getcurMouseLevelType()?(g=Math.round(c.getPos(e[1].width,k.sampleStart)),h=Math.round(c.getPos(e[1].width,k.sampleStart+k.sampleDur+1)),f.fillRect(g,0,3,e[1].height)):(g=Math.round(c.getPos(e[1].width,k.samplePoint)),h=Math.round(c.getPos(e[1].width,k.samplePoint+20)),j=i/2,f.fillRect(g+j,0,3,e[1].height)),f.fillStyle=d.vals.colors.startBoundaryColor)}var e=b.find("canvas");a.$watch("levelDetails.data",function(){c(a.level,a.vs,a.config)},!0),a.$watch("vs",function(){c(a.level,a.vs,a.config),d(a.level,a.vs,a.config)},!0),b.bind("mouseleave",function(){a.vs.setcurMouseSegment(void 0),d(a.level,a.vs,a.config)}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.level)||$.isEmptyObject(a.vs)||c(a.level,a.vs,a.config)}),a.updateView=function(){c(a.level,a.vs,a.config)}}}}),angular.module("emulvcApp").directive("osci",function(){return{templateUrl:"views/osci.html",restrict:"E",link:function(a,b){function c(a,b){var c=a.vs,d=i.getContext("2d");d.clearRect(0,0,h.width,h.height);var e=c.getPos(i.width,c.playHeadAnimationInfos.sS),g=c.getPos(i.width,c.playHeadAnimationInfos.curS);d.fillStyle=a.config.vals.colors.selectedAreaColor,d.fillRect(e,0,g-e,h.height),f(a,b,!1)}function d(a,b,c){return a.measureText(b).width*c}function e(a,b,c,e){return b.toString().length>c.toString().length?d(a,b,e):d(a,c,e)}function f(a,b,c){var d=a.vs,f=i.getContext("2d");c&&f.clearRect(0,0,i.width,i.height);var g;g=d.getSampleDist(i.width),a.dhs.drawMovingBoundaryLine(f),a.dhs.drawCurViewPortSelected(f,!0),f.strokeStyle=b.vals.colors.labelColor,f.fillStyle=b.vals.colors.labelColor,f.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,f.beginPath(),f.moveTo(0,0),f.lineTo(5,5),f.moveTo(i.width,0),f.lineTo(i.width-5,5),f.closePath(),f.stroke();var h,j,k,l,m=f.canvas.width/f.canvas.offsetWidth;d.curViewPort&&(h=d.round(d.curViewPort.sS/a.shs.wavJSO.SampleRate,6),j=d.round(d.curViewPort.eS/a.shs.wavJSO.SampleRate,6),k=a.fontImage.getTextImageTwoLines(f,d.curViewPort.sS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),f.drawImage(k,0,0,k.width,k.height,5,0,k.width,k.height),l=e(f,d.curViewPort.eS,j,m),k=a.fontImage.getTextImageTwoLines(f,d.curViewPort.eS,j,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),f.drawImage(k,0,0,k.width,k.height,i.width-l-5,0,k.width,k.height))}var g=b.find("canvas").length,h=b.find("canvas")[0],i=b.find("canvas")[g-1];a.$watch("vs.playHeadAnimationInfos",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c(a,a.config)},!0),a.$watch("tds.data",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)},!0),a.$on("refreshTimeline",function(){if(!$.isEmptyObject(a.shs))if($.isEmptyObject(a.shs.wavJSO)){var b=h.getContext("2d");b.clearRect(0,0,h.width,h.height),b=i.getContext("2d"),b.clearRect(0,0,i.width,i.height)}else f(a,a.config,!0)}),a.$watch("vs.curViewPort",function(b,c){if(!$.isEmptyObject(a.shs)&&!$.isEmptyObject(a.shs.wavJSO)){if(c.sS!==b.sS||c.sE!==b.sE||-1===b.selectS){var d=a.dhs.calculatePeaks(a.vs,h,a.shs.wavJSO.Data);a.dhs.osciPeaks=d,a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,h,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config)}f(a,a.config,!0)}},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0===a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1===a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2===a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"})),f(a,a.config,!0)}},!0)}}}),angular.module("emulvcApp").directive("preview",function(){return{templateUrl:"views/preview.html",restrict:"E",link:function(a,b){function c(){f?d(a.vs,e,a.config,g):(a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,e,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config),g.src=e.toDataURL("image/png"),f=!0,d(a.vs,e,a.config,g))}function d(b,c,d,e){var f=c.getContext("2d"),g=new Image,h=c.width/a.shs.wavJSO.Data.length*b.curViewPort.sS,i=c.width/a.shs.wavJSO.Data.length*b.curViewPort.eS;g.onload=function(){f.clearRect(0,0,c.width,c.height),f.drawImage(g,0,0),f.fillStyle=d.vals.colors.selectedAreaColor,f.fillRect(h,0,i-h,c.height),f.strokeStyle=d.vals.colors.selectedBorderColor,f.beginPath(),f.moveTo(h,0),f.lineTo(h,c.height),f.moveTo(i,0),f.lineTo(i,c.height),f.closePath(),f.stroke()},g.src=e.src}var e=b.find("canvas")[0],f=!1,g=new Image;a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("shs.wavJSO",function(){if($.isEmptyObject(a.shs.wavJSO)){var b=e.getContext("2d");b.clearRect(0,0,e.width,e.height)}},!0)}}}),angular.module("emulvcApp").directive("submenu",["$animate",function(a){return{templateUrl:"views/leftSubmenu.html",restrict:"E",link:function(b,c){b.$watch("vs.submenuOpen",function(){var d=b.vs.getTransitionTime(),e={"-webkit-transition":"width "+d+"s ease-in-out, left "+d+"s ease-in-out,right "+d+"s ease-in-out","-moz-transition":"width "+d+"s ease-in-out, left "+d+"s ease-in-out,right "+d+"s ease-in-out","-ms-transition":"width "+d+"s ease-in-out, left "+d+"s ease-in-out,right "+d+"s ease-in-out","-o-transition":"width "+d+"s ease-in-out, left "+d+"s ease-in-out,right "+d+"s ease-in-out",transition:"width "+d+"s ease-in-out, left "+d+"s ease-in-out,right "+d+"s ease-in-out"};c.css(e),$("#menu-bottom").css(e),$("#menu").css(e),$("#TimelineCtrl").css(e),$("#HandleLevelsCtrl").css(e),b.vs.submenuOpen?(a.addClass(c,".slideInSubmenu"),a.addClass($("#menu"),".slideInBody"),a.addClass($("#menu-bottom"),".slideInBody"),a.addClass($("#TimelineCtrl"),".slideInBody"),a.addClass($("#HandleLevelsCtrl"),".slideInBody")):(a.removeClass(c,".slideInSubmenu"),a.removeClass($("#menu-bottom"),".slideInBody"),a.removeClass($("#menu"),".slideInBody"),a.removeClass($("#TimelineCtrl"),".slideInBody"),a.removeClass($("#HandleLevelsCtrl"),".slideInBody"))},!0)}}}]),angular.module("emulvcApp").animation(".slideInSubmenu",function(){return{addClass:function(a){a.addClass("cbp-spmenu-open")},removeClass:function(a){a.removeClass("cbp-spmenu-open")}}}),angular.module("emulvcApp").animation(".slideInBody",function(){return{addClass:function(a){a.addClass("cbp-spmenu-left-toright")},removeClass:function(a){a.removeClass("cbp-spmenu-left-toright")}}}),angular.module("emulvcApp").directive("spectro",["$q",function(){return{templateUrl:"views/spectro.html",restrict:"E",link:function(a,b){function c(){t=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width),u=f(a.vs.curViewPort.sS,a.vs.curViewPort.eS,t),null!==u?(s.clearRect(0,0,p.width,p.height),h(u),g()):k(a.vs,a.shs.wavJSO.Data)}function d(){y=null,z=0,y=[]}function e(a,b,c,d){y[z]=[],y[z][0]=a,y[z][1]=b,y[z][2]=c,y[z][3]=d,++z}function f(a,b,c){for(var d=0;d<y.length;++d)if(y[d][0]===a&&y[d][1]===b&&y[d][2]===c)return d;return null}function g(){a.dhs.drawMovingBoundaryLine(s),a.dhs.drawCurViewPortSelected(s,!1)}function h(a){var b=r.createImageData(o.width,o.height);b.data.set(y[a][3]),r.putImageData(b,0,0)}function i(){r.fillStyle="#222",r.fillRect(0,0,o.width,o.height),r.font=a.config.vals.font.fontPxSize+"px "+a.config.vals.font.fontType,r.fillStyle="#333",r.fillText("loading...",10,25),null!==x&&(x.terminate(),x=null)}function j(){t=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width);var b=r.createImageData(o.width,o.height);x.addEventListener("message",function(c){t===c.data.myStep&&(b.data.set(c.data.img),r.putImageData(b,0,0),e(a.vs.curViewPort.sS,a.vs.curViewPort.eS,t,c.data.img),g())})}function k(a,b){i(),l(a,b)}function l(b,c){t=Math.round((b.curViewPort.eS-b.curViewPort.sS)/o.width),x=new Worker(w);var d=c.subarray(b.curViewPort.sS,b.curViewPort.eS+3*t*b.spectroSettings.windowLength),e=new Float32Array(d);j(),x.postMessage({cmd:"config",N:b.spectroSettings.windowLength}),x.postMessage({cmd:"config",alpha:q}),x.postMessage({cmd:"config",freq:b.spectroSettings.rangeTo}),x.postMessage({cmd:"config",freqLow:b.spectroSettings.rangeFrom}),x.postMessage({cmd:"config",start:Math.round(b.curViewPort.sS)}),x.postMessage({cmd:"config",end:Math.round(b.curViewPort.eS)}),x.postMessage({cmd:"config",myStep:t}),x.postMessage({cmd:"config",window:b.spectroSettings.window}),x.postMessage({cmd:"config",width:o.width}),x.postMessage({cmd:"config",height:o.height}),x.postMessage({cmd:"config",dynRangeInDB:b.spectroSettings.dynamicRange}),x.postMessage({cmd:"config",pixelRatio:v}),x.postMessage({cmd:"config",sampleRate:a.shs.wavJSO.SampleRate}),x.postMessage({cmd:"config",streamChannels:a.shs.wavJSO.NumChannels}),x.postMessage({cmd:"pcm",stream:e}),x.postMessage({cmd:"render"})}function m(b,c,d,e,f){if(d.vals.restrictions.drawCrossHairs){s.clearRect(0,0,c.width,c.height),s.strokeStyle=d.vals.colors.crossHairsColor,s.fillStyle=d.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&s.setLineDash([2]);var h=e.getX(f),i=e.getY(f);s.beginPath(),s.moveTo(0,i),s.lineTo(5,i+5),s.moveTo(0,i),s.lineTo(c.width,i),s.lineTo(c.width-5,i+5),s.moveTo(h,0),s.lineTo(h,c.height),s.stroke(),s.font=d.vals.font.fontPxSize+"px "+d.vals.font.fontType;var j=b.round(b.spectroSettings.rangeTo-i/c.height*b.spectroSettings.rangeTo,2),k=s.measureText(j+" Hz").width,l=Math.round(b.curViewPort.sS+h/c.width*(b.curViewPort.eS-b.curViewPort.sS)),m=b.round(b.getViewPortStartTime()+h/c.width*(b.getViewPortEndTime()-b.getViewPortStartTime()),6),n=a.fontImage.getTextImage(r,j+" Hz",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!0),o=a.fontImage.getTextImageTwoLines(r,l,m,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!1);s.drawImage(n,0,0,n.width,n.height,5,i,n.width,n.height),s.drawImage(n,0,0,n.width,n.height,c.width-5-k*(r.canvas.width/r.canvas.offsetWidth),i,n.width,n.height),s.drawImage(o,0,0,o.width,o.height,h+5,0,o.width,o.height),"Google Inc."===navigator.vendor&&s.setLineDash([0]),g()}}var n=b.find("canvas").length,o=b.find("canvas")[0],p=b.find("canvas")[n-1],q=.16,r=o.getContext("2d"),s=p.getContext("2d"),t=0;window.URL=window.URL||window.webkitURL;var u,v=window.devicePixelRatio||1,w="scripts/workers/spectroWorker.js",x=new Worker(w),y=null,z=0;b.bind("mousemove",function(b){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(g(),m(a.vs,o,a.config,a.dhs,b))}),b.bind("mouseleave",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(s.clearRect(0,0,p.width,p.height),g())}),a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("tds.data",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$on("newlyLoadedAudioFile",function(){console.log("clearing spectro image cache..."),d()}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.shs)||($.isEmptyObject(a.shs.wavJSO)?(r.clearRect(0,0,o.width,o.height),s.clearRect(0,0,p.width,p.height)):c())}),a.$watch("vs.spectroSettings",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(j(),d(),k(a.vs,a.shs.wavJSO.Data))},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0===a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1===a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2===a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"}))}},!0),d()}}}]),angular.module("emulvcApp").controller("HandleLevelsCtrl",["$scope","$http","$injector","viewState","HistoryService","ConfigProviderService","Soundhandlerservice","Levelservice","fontScaleService","Drawhelperservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k){a.vs=d,a.hists=e,a.fontImage=i,a.shs=g,a.config=f,a.dhs=j,a.dials=k,a.testValue="",a.message="",a.levelDetails=h,a.sortableOptions={update:function(){!f.vals.restrictions.sortLabels},start:function(){a.deleteEditArea()},create:function(){},axis:"y",placeholder:"levelPlaceholder"},a.$on("loadingNewUtt",function(){a.levelDetails.data={}}),a.$on("errorMessage",function(a,b){k.open("views/error.html","ModalCtrl",b)}),a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.getLevelLength=function(){return a.levelDetails.data.levels.length},a.getLevel=function(b){var c;return angular.forEach(a.levelDetails.data.levels,function(a){a.LevelName===b&&(c=a)}),c},a.renameLevel=function(b){var c=!1;angular.forEach(a.levelDetails.data.levels,function(a){a.LevelName===b&&(c=!0)}),c?k.open("views/error.html","ModalCtrl","Rename Error : This Level name already exists ! Please choose another name !"):angular.forEach(a.levelDetails.data.levels,function(a){a.LevelName===d.getcurClickLevelName()&&(a.LevelName=b)})},a.getNearest=function(b,c){var d=parseFloat(a.vs.curViewPort.sS)+b,e=0,f=0;if("seg"===c.type)angular.forEach(c.items,function(a){d>=a.sampleStart&&d<=a.sampleStart+a.sampleDur&&(f=d-a.sampleStart>=a.sampleDur/2?e+1:e),++e});else{var g=0,h=0;angular.forEach(c.items,function(b,i){h=i<c.items.length-1?b.sampleStart+(c.items[i+1].sampleStart-c.items[i].sampleStart)/2:a.vs.curViewPort.bufferLength,i>0&&(g=b.sampleStart-(c.items[i].sampleStart-c.items[i-1].sampleStart)/2),h>=d&&d>=g&&(f=e),++e
})}return f}}]),angular.module("emulvcApp").controller("TimelineCtrl",["$scope","$http","$compile","viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService","Ssffdataservice","HistoryService",function(a,b,c,d,e,f,g,h,i){a.vs=d,a.shs=e,a.cps=g.vals.colors,a.config=g,a.dhs=f,a.ssffds=h,a.hists=i,a.resizeSpectro=function(){d.setscrollOpen(0===d.getscrollOpen()?1:0)},a.resizeOsci=function(){d.setscrollOpen(0===d.getscrollOpen()?2:0)}}]),angular.module("emulvcApp").controller("ExportCtrl",["$scope","dialogService","exportData","exportName","viewState","Levelservice","HistoryService",function(a,b,c,d,e){a.exportData=c,a.exportName=d,a.cancel=function(){b.close()},a.getBlob=function(){return new Blob([a.exportData],{type:"text/plain"})},a.cursorInTextField=function(){e.focusInTextField=!0},a.cursorOutOfTextField=function(){e.focusInTextField=!1}}]),angular.module("emulvcApp").factory("viewState",["$rootScope","Soundhandlerservice","$window","Levelservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,bufferLength:-1},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null},e.curClickSegments=[],e.lasteditArea=null,e.editing=!1,e.submenuOpen=!1,e.rightSubmenuOpen=!1,e.modalOpen=!1,e.scrollOpen=0,e.levelLength=0,e.curMouseLevelName=void 0,e.curMouseLevelType=void 0,e.curClickLevelName=void 0,e.curClickLevelType=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=void 0,e.curClickLevelIndex=void 0,e.start=null,e.loadingUtt=!1,e.curMouseSegmentId=void 0,e.TransitionTime=void 0,e.showDropZone=void 0,e.dragBarActive=!1,e.movingBoundary=!1,e.focusInTextField=!1,e.curTaskPercCompl=0,e.curPerspectiveIdx=0,e.states=[],e.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},e.states.loadingSaving={permittedActions:[]},e.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","spectSettingsChange","clearBtnClick"]},e.states.modalShowing={permittedActions:[]},e.prevState=e.states.noDBorFilesloaded,e.curState=e.states.noDBorFilesloaded,e.getPermission=function(a){return e.curState.permittedActions.indexOf(a)>-1},e.setState=function(a){e.prevState=e.curState,e.curState="string"==typeof a?e.states[a]:a},e.updatePlayHead=function(d){b.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=d);var f=Math.ceil(d-e.start)/1e3*b.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.round(e.playHeadAnimationInfos.sS+f),b.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?a.$apply():(e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.getViewPort=function(){return e.curViewPort},e.setspectroSettings=function(a,b,c,d,f){e.spectroSettings.windowLength=parseInt(a,10),e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f)},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.selectE&&(this.curViewPort.selectE=b)},e.selectLevel=function(a){var b,c=e.getcurClickLevelName(),f=$("li").children()[0].id;if(void 0===c)e.setcurClickLevelName(f);else{a?(b=$("li."+c).next().children()[0],void 0===b?e.setcurClickLevelName(f):(f=b.id,e.setcurClickLevelName(f))):(b=$("li."+c).prev().children()[0],void 0===b?e.setcurClickLevelName(f):(f=b.id,e.setcurClickLevelName(f)));var g=e.getcurClickSegments();if(void 0!==g&&g.length>0){var h=g[0].sampleStart+g[0].sampleDur/2,i=d.getLevelDetails(f),j=d.getEvent(h,i.level,!1);console.log(j),e.setlasteditArea("_"+j.id),e.setcurClickLevelType(i.level.type),e.setcurClickSegment(j),e.setLevelLength(i.level.items.length)}}},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getWindowFunctions=function(){return f},e.getdragBarActive=function(){return this.dragBarActive},e.setdragBarActive=function(a){this.dragBarActive=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.getTransitionTime=function(){return this.TransitionTime},e.setTransitionTime=function(a){this.TransitionTime=a},e.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},e.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},e.getmodalOpen=function(){return this.modalOpen},e.setmodalOpen=function(a){this.modalOpen=a},e.getscrollOpen=function(){return this.scrollOpen},e.setscrollOpen=function(a){this.scrollOpen=a},e.setcurClickLevel=function(a,b,c,d){this.setLevelLength(d),this.setcurClickLevelName(a,c),this.setcurClickLevelType(b),this.setLevelLength(d)},e.setcurClickLevelType=function(a){this.curClickLevelType=a},e.getcurClickLevelType=function(){return this.curClickLevelType},e.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},e.getcurClickLevelName=function(){return this.curClickLevelName},e.getcurClickNeighbours=function(){return this.curClickNeighbours},e.setcurMouseLevelName=function(a){this.curMouseLevelName=a},e.getcurMouseLevelName=function(){return this.curMouseLevelName},e.setcurMouseLevelType=function(a){this.curMouseLevelType=a},e.getcurMouseLevelType=function(){return this.curMouseLevelType},e.setcurMouseSegment=function(a,b){this.curMouseSegment=a,this.curMouseNeighbours=b},e.getcurMouseSegment=function(){return this.curMouseSegment},e.getcurMouseNeighbours=function(){return this.curMouseNeighbours},e.selectSegmentsInSelection=function(){var a=e.curViewPort.selectS,b=e.curViewPort.selectE;angular.forEach(d.data.levels,function(c){c.name===e.getcurClickLevelName()&&angular.forEach(c.items,function(c){c.sampleStart>=a&&c.sampleStart+c.sampleDur<=b&&e.setcurClickSegmentMultiple(c)})})},e.setcurClickSegment=function(a){e.curClickSegments=[],e.curClickSegments.push(a),e.selectBoundry()},e.selectBoundry=function(){if(e.curClickSegments.length>0){var a=this.curClickSegments[0].sampleStart||this.curClickSegments[0].samplePoint,b=this.curClickSegments[this.curClickSegments.length-1].sampleStart+this.curClickSegments[this.curClickSegments.length-1].sampleDur||this.curClickSegments[0].samplePoint;e.curClickSegments.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),e.select(a,b)}},e.setcurClickSegmentMultiple=function(a){var b=!0,c=this,d=a.sampleStart,f=d+a.sampleDur;this.curClickSegments.forEach(function(g){var h=g.sampleStart==f?!0:!1,i=g.sampleStart+g.sampleDur==d?!0:!1;(h||i)&&-1===e.curClickSegments.indexOf(a)&&(c.curClickSegments.push(a),b=!1)}),b&&(this.curClickSegments=[],this.curClickSegments.push(a)),e.selectBoundry()},e.getselectedRange=function(){return this.curClickSegments.length>1?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[this.curClickSegments.length-1].sampleStart+this.curClickSegments[this.curClickSegments.length-1].sampleDur}:1==this.curClickSegments.length?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[0].sampleStart+this.curClickSegments[0].sampleDur}:{start:-1,end:-1}},e.getcurClickSegments=function(){return this.curClickSegments},e.getselected=function(){return this.curClickSegments},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.setlasteditArea=function(a){this.lasteditArea=a},e.getlastID=function(){return this.lasteditArea.substr(1)},e.getlasteditArea=function(){return this.lasteditArea},e.deleteEditArea=function(){null!==this.getlasteditArea()&&$("."+this.getlasteditArea()).remove(),this.editing=!1},e.countSelected=function(){return this.curClickSegments.length},e.setLevelLength=function(a){this.levelLength=a},e.getLevelLength=function(){return this.levelLength},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getPCMpp=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.srcElement.width},e.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},e.openEditArea=function(a,b,c){var d=c.find("canvas").context.getContext("2d"),f=d.canvas.clientWidth,g=d.canvas.offsetLeft;if("SEGMENT"===b)var h=e.getPos(f,a.sampleStart)+g,i=e.getPos(f,a.sampleStart+a.sampleDur)+g;else var h=e.getPos(f,a.samplePoint)+g-f/50,i=e.getPos(f,a.samplePoint)+g+f/50;var j=d.canvas.offsetTop,k=d.canvas.clientHeight;console.log(a),e.createEditArea(c,h,j,i-h,k,a.labels[0].value,a.id),e.createSelection(c.find("textarea")[0],0,a.labels[0].value.length)},e.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},e.createEditArea=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" Label_Edit","ng-model":"message",autofocus:"true"}).css({position:"absolute","z-index":"9999",left:b+2+"px",top:c+1+"px",width:Math.round(d)+"px",height:Math.round(e)+"px","padding-top":Math.round(e/3+1)+"px"}).text(f))},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.setViewPort=function(a,c){var d=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==c&&(this.curViewPort.eS=Math.round(c)),d>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),d<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.sS=d,this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=d,this.curViewPort.eS=e)},e.zoomViewPort=function(a){var b,c,e=this.getcurMouseSegment(),f=d.getLevelDetails().level,g=this.curViewPort.eS-this.curViewPort.sS,h=this.curClickLevelIndex;if(f&&e.id){console.log(f),console.log(h);var i=f.items[h][e.id].sampleStart,j=i-this.curViewPort.sS,k=this.curViewPort.eS-i;a?(b=this.curViewPort.sS+.5*j,c=this.curViewPort.eS-.5*k):(b=this.curViewPort.sS-.5*j,c=this.curViewPort.eS+.5*k)}else a?(b=this.curViewPort.sS+~~(g/4),c=this.curViewPort.eS-~~(g/4)):(b=this.curViewPort.sS-~~(g/4),c=this.curViewPort.eS+~~(g/4));this.setViewPort(b,c)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e}]),angular.module("emulvcApp").directive("trackmouseinlevel",["ConfigProviderService","viewState","Levelservice",function(a,b,c){return{restrict:"A",link:function(d,e){function f(a){o=j(a)*b.getPCMpp(a),b.deleteEditArea(),b.setEditing(!1),b.focusInTextField=!1,k=c.getEvent(o+d.vs.curViewPort.sS,d.this.level,d.vs.curViewPort.bufferLength),b.setlasteditArea("_"+k.evtr.id),b.setcurClickLevel(p,q,d.$index,d.this.level.items.length),b.setcurClickSegment(k.evtr),n=o,d.$apply()}function g(a){b.getcurClickLevelName()!==p&&f(a),o=j(a)*b.getPCMpp(a),b.deleteEditArea(),k=c.getEvent(o+d.vs.curViewPort.sS,d.this.level,d.vs.curViewPort.bufferLength),b.setcurClickLevel(p,q,d.$index,d.this.level.items.length),b.setcurClickSegmentMultiple(k.evtr),n=o,d.$apply()}function h(a){o=j(a)*b.getPCMpp(a),k=c.getEvent(o+d.vs.curViewPort.sS,d.this.level,d.vs.curViewPort.bufferLength),b.setcurClickLevel(p,q,d.$index,d.this.level.items.length),b.setcurClickSegment(k.evtr),b.setlasteditArea("_"+k.evtr.id),b.setEditing(!0),b.openEditArea(k.evtr,q,e.parent()),d.cursorInTextField(),n=o,d.$apply()}function i(a,e){o=j(a)*b.getPCMpp(a),l=c.getEvent(o+d.vs.curViewPort.sS,d.this.level,d.vs.curViewPort.bufferLength),e&&void 0!=l.nearest&&(m=c.getElementNeighbourDetails(d.this.level.name,l.nearest.id,l.nearest.id),b.setcurMouseSegment(l.nearest,m)),b.setcurMouseLevelName(p),b.setcurMouseLevelType(q),n=o,d.$apply()}function j(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var k,l,m,n,o,p=d.level.name,q=d.level.type;e.bind("click",function(a){i(a,!0),f(a)}),e.bind("contextmenu",function(a){a.preventDefault(),i(a,!0),g(a)}),e.bind("dblclick",function(b){i(b,!0),a.vals.restrictions.editItemName?h(b):f(b)}),e.bind("mousemove",function(e){var f=!0,g=b.getPCMpp(e);o=j(e)*g;var h=o-n;switch(h=1>=g?Math.floor(o+d.vs.curViewPort.sS-c.getElementDetails(d.this.level.name,b.getcurMouseSegment().id).sampleStart):Math.round(o-n),e.which){case 1:break;case 2:break;case 3:break;default:if(b.getdragBarActive()===!1)if(a.vals.restrictions.editItemSize&&e.shiftKey)b.deleteEditArea(),void 0!==b.getcurMouseSegment()&&(b.movingBoundary=!0,"SEGMENT"==d.this.level.type?(d.levelDetails.moveBoundry(h,d.this.level.name,b.getcurMouseSegment(),b.getcurMouseNeighbours()),d.hists.updateCurChangeObj({type:"ESPS",action:"moveBoundary",name:d.this.level.name,neighbours:b.getcurMouseNeighbours(),itemIdx:b.getcurMouseSegment(),movedBy:h})):(d.levelDetails.movePoint(h,d.this.level.name,b.getcurMouseSegment()),d.hists.updateCurChangeObj({type:"ESPS",action:"movePoint",name:d.this.level.name,itemIdx:b.getcurMouseSegment(),movedBy:h})),b.selectBoundry(),n=o,d.$apply(),f=!1);else if(a.vals.restrictions.editItemSize&&e.altKey){if(b.deleteEditArea(),"SEGMENT"==d.this.level.type){var k=d.levelDetails.getElementNeighbourDetails(d.this.level.name,b.getcurClickSegments()[0].id,b.getcurClickSegments()[b.getcurClickSegments().length-1].id);d.levelDetails.moveSegment(h,d.this.level.name,b.getcurClickSegments(),k),d.hists.updateCurChangeObj({type:"ESPS",action:"moveSegment",name:d.this.level.name,neighbours:angular.copy(k),itemIdx:angular.copy(b.getcurClickSegments()),movedBy:h}),b.selectBoundry(),n=o,d.$apply()}}else b.movingBoundary=!1}i(e,f)}),e.bind("mousedown",function(a){i(a,!0)}),e.bind("mouseup",function(a){i(a,!0)}),e.bind("mouseout",function(a){b.movingBoundary=!1,i(a,!0)})}}}]),angular.module("emulvcApp").directive("trackmouse",function(){return{restrict:"A",link:function(a,b){function c(b){d=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),d>e?(f=d,a.vs.select(e,f)):(e=d,a.vs.select(e,f)),a.$apply()}var d,e,f;b.bind("mousedown",function(b){e=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),f=e,a.vs.select(e,e),a.$apply()}),b.bind("mousemove",function(b){switch(b.which){case 1:a.vs.getdragBarActive()||c(b)}}),b.bind("mouseup",function(b){a.vs.getdragBarActive()||c(b)})}}}),angular.module("emulvcApp").directive("handleglobalkeystrokes",["viewState","Soundhandlerservice","ConfigProviderService","HistoryService","Levelservice",function(a,b,c,d,e){return{restrict:"A",link:function(f){$(document).bind("keydown",function(g){var h=g.keyCode?g.keyCode:g.which;f.$apply(function(){if(f.setlastkeycode(h,g.shiftKey),a.focusInTextField){if(h===c.vals.keyMappings.enter&&a.isEditing()){var i=e.getElementDetails(a.getcurClickLevelName(),a.getlastID());d.addObjToUndoStack({type:"ESPS",action:"renameLabel",name:a.getcurClickLevelName(),itemIdx:a.getlastID(),oldValue:i.labels[0].value,newValue:$("."+a.getlasteditArea()).val()}),e.renameLabel(a.getcurClickLevelName(),a.getlastID(),$("."+a.getlasteditArea()).val()),a.deleteEditArea(),a.focusInTextField=!1}h===c.vals.keyMappings.esc&&(a.focusInTextField=!1,a.deleteEditArea()),13===h&&(g.preventDefault(),g.stopPropagation())}else{if(a.deleteEditArea(),h===c.vals.keyMappings.zoomAll&&(a.getPermission("zoom")?a.setViewPort(0,a.curViewPort.bufferLength):console.log("action currently not allowed")),h===c.vals.keyMappings.zoomIn&&(a.getPermission("zoom")?a.zoomViewPort(!0):console.log("action currently not allowed")),h===c.vals.keyMappings.zoomOut&&(a.getPermission("zoom")?a.zoomViewPort(!1):console.log("action currently not allowed")),h===c.vals.keyMappings.shiftViewPortLeft&&(a.getPermission("zoom")?a.shiftViewPort(!1):console.log("action currently not allowed")),h===c.vals.keyMappings.shiftViewPortRight&&(a.getPermission("zoom")?a.shiftViewPort(!0):console.log("action currently not allowed")),h===c.vals.keyMappings.zoomSel&&(a.getPermission("zoom")?a.setViewPort(a.curViewPort.selectS,a.curViewPort.selectE):console.log("action currently not allowed")),h===c.vals.keyMappings.playEntireFile&&(a.getPermission("zoom")?c.vals.restrictions.playback&&(b.playFromTo(0,b.wavJSO.Data.length),a.animatePlayHead(0,b.wavJSO.Data.length)):console.log("action currently not allowed")),h===c.vals.keyMappings.playAllInView&&(a.getPermission("zoom")?c.vals.restrictions.playback&&(b.playFromTo(a.curViewPort.sS,a.curViewPort.eS),a.animatePlayHead(a.curViewPort.sS,a.curViewPort.eS)):console.log("action currently not allowed")),h===c.vals.keyMappings.playSelected&&(a.getPermission("zoom")?c.vals.restrictions.playback&&(b.playFromTo(a.curViewPort.selectS,a.curViewPort.selectE),a.animatePlayHead(a.curViewPort.selectS,a.curViewPort.selectE)):console.log("action currently not allowed")),h===c.vals.keyMappings.selectFirstContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=1),h===c.vals.keyMappings.selectSecondContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=2),h===c.vals.keyMappings.selectThirdContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=3),h===c.vals.keyMappings.selectFourthContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=4),h===c.vals.keyMappings.selectNoContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=void 0),h===c.vals.keyMappings.levelUp&&a.selectLevel(!1),h===c.vals.keyMappings.levelDown&&a.selectLevel(!0),h===c.vals.keyMappings.snapBoundaryToTop&&c.vals.restrictions.editItemSize){var j=a.getcurMouseSegmentId(),k=a.getcurMouseLevelName(),l=e.snapBoundary(!0,a.getcurMouseSegment().sampleStart,k,j);f.hists.addObjToUndoStack({type:"ESPS",action:"snapBoundary",levelName:k,itemIdx:j,movedBy:l})}if(h===c.vals.keyMappings.snapBoundaryToBottom&&c.vals.restrictions.editItemSize){var j=a.getcurMouseSegmentId(),k=a.getcurMouseLevelName(),l=e.snapBoundary(!1,a.getcurMouseSegment().sampleStart,k,j);f.hists.addObjToUndoStack({type:"ESPS",action:"snapBoundary",levelName:k,itemIdx:j,movedBy:l})}if(h===c.vals.keyMappings.plus&&c.vals.restrictions.editItemSize)if(void 0===a.getcurClickLevelName())f.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===a.getselected().length)f.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===c.vals.labelCanvasConfig.addTimeMode)var m=parseInt(c.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===c.vals.labelCanvasConfig.addTimeMode)var m=c.vals.labelCanvasConfig.addTimeValue*(a.curViewPort.bufferLength/100);else f.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:a.getcurClickLevelName(),itemIdx:a.getcurClickSegments(),bufferLength:a.curViewPort.bufferLength,rightSide:!0,changeTime:m}),e.expandSegment(!0,a.getcurClickSegments(),a.getcurClickLevelName(),m)}if(h===c.vals.keyMappings.plusShift&&c.vals.restrictions.editItemSize)if(void 0===a.getcurClickLevelName())f.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===a.getselected().length)f.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===c.vals.labelCanvasConfig.addTimeMode)var m=parseInt(c.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===c.vals.labelCanvasConfig.addTimeMode)var m=c.vals.labelCanvasConfig.addTimeValue*(a.curViewPort.bufferLength/100);else f.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:a.getcurClickLevelName(),itemIdx:a.getcurClickSegments(),rightSide:!1,changeTime:m}),e.expandSegment(!1,a.getcurClickSegments(),a.getcurClickLevelName(),m)}if(h===c.vals.keyMappings.minus&&c.vals.restrictions.editItemSize)if(void 0===a.getcurClickLevelName())f.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===a.getselected().length)f.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===c.vals.labelCanvasConfig.addTimeMode)var m=parseInt(c.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===c.vals.labelCanvasConfig.addTimeMode)var m=c.vals.labelCanvasConfig.addTimeValue*(a.curViewPort.bufferLength/100);else f.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");g.shiftKey?(f.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:a.getcurClickLevelName(),itemIdx:a.getcurClickSegments(),rightSide:!1,changeTime:0-m}),e.expandSegment(!1,a.getcurClickSegments(),a.getcurClickLevelName(),0-m)):(f.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:a.getcurClickLevelName(),itemIdx:a.getcurClickSegments(),rightSide:!0,changeTime:0-m}),e.expandSegment(!0,a.getcurClickSegments(),a.getcurClickLevelName(),0-m))}if(h===c.vals.keyMappings.openSubmenu&&(g.shiftKey?f.toggleRightSideMenuHidden():f.openSubmenu()),h===c.vals.keyMappings.openRightSubmenu&&f.openRightSubmenu(),h===c.vals.keyMappings.spectroSettings&&f.dials.open("views/spectroSettings.html","dialog"),h===c.vals.keyMappings.selectSegmentsInSelection&&(void 0===a.getcurClickLevelName()?f.dials.open("views/error.html","ModalCtrl","Selection Error : Please select a Level first"):a.selectSegmentsInSelection()),h===c.vals.keyMappings.left&&a.getcurClickSegments().length>0){var n=a.getcurClickSegments()[0].id,o=a.getcurClickSegments()[a.getcurClickSegments().length-1].id,p=e.getElementNeighbourDetails(a.getcurClickLevelName(),n,o);void 0!==p.left&&(a.setcurClickSegment(p.left,p.left.id),a.setlasteditArea("_"+p.left.id))}if(h===c.vals.keyMappings.right&&a.getcurClickSegments().length>0){var n=a.getcurClickSegments()[0].id,o=a.getcurClickSegments()[a.getcurClickSegments().length-1].id,p=e.getElementNeighbourDetails(a.getcurClickLevelName(),n,o);void 0!==p.right&&(a.setcurClickSegment(p.right,p.right.id),a.setlasteditArea("_"+p.right.id))}if(h===c.vals.keyMappings.tab&&a.getcurClickSegments().length>0){var n=a.getcurClickSegments()[0].id,o=a.getcurClickSegments()[a.getcurClickSegments().length-1].id,p=e.getElementNeighbourDetails(a.getcurClickLevelName(),n,o);g.shiftKey?void 0!==p.left&&(a.setcurClickSegment(p.left,p.left.id),a.setlasteditArea("_"+p.left.id)):void 0!==p.right&&(a.setcurClickSegment(p.right,p.right.id),a.setlasteditArea("_"+p.right.id))}if(h===c.vals.keyMappings.enter&&c.vals.restrictions.addItem)if(a.getselectedRange().start==a.curViewPort.selectS&&a.getselectedRange().end==a.curViewPort.selectE)1==a.getcurClickSegments().length?(a.setEditing(!0),a.openEditArea(a.getcurClickSegments()[0],a.getselected()[0],a.getcurClickLevelType()),f.cursorInTextField()):f.dials.open("views/error.html","ModalCtrl","Modify Error: Please select a single Segment.");else if(-1==a.curViewPort.selectE&&-1==a.curViewPort.selectS)f.dials.open("views/error.html","ModalCtrl","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else if("seg"==a.getcurClickLevelType()){var q=e.insertSegment(a.curViewPort.selectS,a.curViewPort.selectE,a.getcurClickLevelName(),c.vals.labelCanvasConfig.newSegmentName);q?f.hists.addObjToUndoStack({type:"ESPS",action:"insertSegments",levelName:a.getcurClickLevelName(),start:a.curViewPort.selectS,end:a.curViewPort.selectE,segname:c.vals.labelCanvasConfig.newSegmentName}):f.dials.open("views/error.html","ModalCtrl","Error : You are not allowed to insert a Segment here.")}else{var r=e.insertPoint(a.curViewPort.selectS,a.getcurClickLevelName(),c.vals.labelCanvasConfig.newPointName);r?f.hists.addObjToUndoStack({type:"ESPS",action:"insertPoint",levelName:a.getcurClickLevelName(),start:a.curViewPort.selectS,pointName:c.vals.labelCanvasConfig.newPointName}):f.dials.open("views/error.html","ModalCtrl","Error : You are not allowed to insert a Point here.")}if(h===c.vals.keyMappings.history&&(g.shiftKey?d.redo():d.undo()),h===c.vals.keyMappings.backspace)if(g.shiftKey){if(c.vals.restrictions.deleteItem){var s=a.getcurClickSegments();if(void 0!==s){var t=a.getcurClickSegments(),u=a.getcurClickSegments();if("seg"===a.getcurClickLevelType()){var v=e.deleteSegments(t,u,a.getcurClickLevelName());a.setcurClickSegment(v.segment,v.id),f.hists.addObjToUndoStack({type:"ESPS",action:"deleteSegments",levelName:a.getcurClickLevelName(),selected:t,ids:u})}else f.dials.open("views/error.html","ModalCtrl","Delete Error: You can not delete Segments on Point Levels.")}}}else if(c.vals.restrictions.deleteItem){var s=a.getcurMouseSegment(),w=a.getcurMouseLevelName();void 0!==s?(f.hists.addObjToUndoStack({type:"ESPS",action:"deleteBoundary",levelName:w,levelType:a.getcurMouseLevelType(),seg:s}),e.deleteBoundary(a.getcurMouseSegment(),a.getcurMouseLevelName(),a.getcurMouseLevelType())):f.dials.open("views/error.html","ModalCtrl","Delete Error: Please select a Boundary first.")}console.log(h),g.metaKey||(g.preventDefault(),g.stopPropagation())}})}),f.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emulvcApp").directive("delete",function(){return{restrict:"A",link:function(a,b){var c=a.this.level.LevelName;b.bind("click",function(){a.vs.setcurClickLevelName(c),a.dials.open("views/deleteLevel.html","ModalCtrl",c)})}}}),angular.module("emulvcApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=c.find("canvas"),e=b.parent().children()[0],f=b.parent().children()[2],g=c.find(e),h=c.find(f),i=!0,j="Level",k="smallLevel",l="LevelCanvas",m="LevelMarkupCanvas",n="smallCanvas";b.bind("click",function(){i?(i=!1,c.parent().parent()[0].className=k+" ng-scope",d[0].className=l+" "+n,d[1].className=m+" "+n,a.config.vals.activeButtons.deleteSingleLevel&&g.hide(),a.config.vals.activeButtons.saveSingleLevel&&h.hide()):(i=!0,c.parent().parent()[0].className=j+" ng-scope",d[0].className=l,d[1].className=m,a.config.vals.activeButtons.deleteSingleLevel&&g.show(),a.config.vals.activeButtons.saveSingleLevel&&h.show()),a.updateView()})}}}),angular.module("emulvcApp").directive("save",["dialogService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d){var e=c.this.level.LevelName;d.bind("click",function(){c.vs.setcurClickLevelName(e),a.openExport("views/export.html","ExportCtrl",b.toESPS(c.this.level),"level.txt")})}}}]),angular.module("emulvcApp").directive("export",["$compile",function(a){return{restrict:"E",scope:{getUrlData:"&getData"},link:function(b,c,d){var e=URL.createObjectURL(b.getUrlData());console.log(d),c.append(a('<a id="dialogExport" download="'+d.filename+'" href="'+e+'">Export</a>')(b))}}}]),angular.module("emulvcApp").directive("previewtrack",function(){return{restrict:"A",link:function(a,b){function c(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var d=-1;b.bind("click",function(b){if(!$.isEmptyObject(a.shs.wavJSO)){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}),b.bind("mousedown",function(b){$.isEmptyObject(a.shs.wavJSO)||(d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width))}),b.bind("mousemove",function(b){switch(event.which){case 1:if(-1!==d){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}}),b.bind("mouseup",function(){d=-1}),b.bind("mouseout",function(){d=-1})}}}),angular.module("emulvcApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","Httphandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o={};return o.wsH=n,o.httpGetDefaultConfig=function(){var a=b.get("configFiles/defaultConfig.json");return a},o.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},o.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},o.getDBconfigFile=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?a=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(a=b.get("testData/newAE/ae_DBconfig.json")),a},o.getBundleList=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?a=n.getBundleList():"DEMO"===k.vals.main.comMode&&(a=b.get("testData/demoUttList.json")),a},o.getBundle=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"WS"===k.vals.main.comMode?c=n.getBundle(a):"DEMO"===k.vals.main.comMode&&(c=b.get("testData/testAeBundle.json")),c},o.toTextGrid=function(a){return j.toTextGrid(a)},o}]),angular.module("emulvcApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};
return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,c){var d=this.wavJSO.BitsPerSample/8,e=this.wavJSO.origArrBuf.subarray(0,44),f=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*d),g=new DataView(e);g.setUint32(40,(c-a)*d,!0);var h=f.subarray(a*d,(c-a)*d),i=new Uint8Array(e.byteLength+h.byteLength);i.set(new Uint8Array(e),0),i.set(new Uint8Array(h),e.byteLength);var j=b.arrayBufferToBase64(i.buffer);this.player.src="data:audio/wav;base64,"+j},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emulvcApp").directive("drawssff",function(){return{restrict:"A",link:function(a,b,c){function d(){if($.isEmptyObject(a.ssffds.data)){var b=g.getContext("2d");b.clearRect(0,0,g.width,g.height)}else 0!==a.ssffds.data.length&&a.config.vals.perspectives[a.vs.curPerspectiveIdx].signalCanvases.assign.forEach(function(b){if(Object.keys(b)[0]===f){var c=a.config.getSsffTrackConfig(b[Object.keys(b)[0]]),d=a.ssffds.getColumnOfTrack(c.name,c.columnName),h=a.ssffds.getSampleRateAndStartTimeOfTrack(c.name),i=a.config.getLimsOfTrack(c.name);e(a.vs,g,a.config,d,h.sampleRate,h.startTime,i)}})}function e(a,b,c,d,e,f,g){var h=b.getContext("2d");h.clearRect(0,0,b.width,b.height);var i=a.spectroSettings.rangeFrom,j=a.spectroSettings.rangeTo,k=a.getViewPortStartTime(),l=a.getViewPortEndTime(),m=Math.round(k*e+f),n=Math.round(l*e+f),o=n-m,p=d.values.slice(m,m+o);if(o<b.width&&o>=2){var q,r,s,t,u,v;p.forEach(function(c,o){c.forEach(function(w,x){if(x>=g.min&&x<=g.max)if(u=m+o,v=1/e*u+f,q=(v-k)/(l-k)*b.width,r=b.height-(w-i)/(j-i)*b.height,o===a.curPreselColumnSample&&a.curCorrectionToolNr-1===x?(h.strokeStyle="white",h.fillStyle="white"):(h.strokeStyle="hsl("+x*(360/c.length)+",80%, 50%)",h.fillStyle="hsl("+x*(360/c.length)+",80%, 50%)"),h.beginPath(),h.arc(q,r-1,2,0,2*Math.PI,!1),h.closePath(),h.stroke(),h.fill(),0!==o){if(u=m+o-1,v=1/e*u+f,s=(v-k)/(l-k)*b.width,t=b.height-(p[o-1][x]-i)/(j-i)*b.height,a.curCorrectionToolNr-1===x&&(h.strokeStyle="white",h.fillStyle="white"),h.beginPath(),h.moveTo(s,t),h.lineTo(q,r),h.stroke(),h.fill(),o===p.length-1&&n!==d.values.length-1){var y=d.values[n+1];w=y[x],u=n+1,v=1/e*u+f;var z=(v-k)/(l-k)*b.width,A=b.height-(w-i)/(j-i)*b.height;h.beginPath(),h.moveTo(q,r),h.lineTo(z,A),h.stroke(),h.fill()}}else if(0!==m){var B=d.values[m-1];w=B[x],u=m-1,v=1/e*u+f,s=(v-k)/(l-k)*b.width,t=b.height-(w-i)/(j-i)*b.height,a.curCorrectionToolNr-1===x&&(h.strokeStyle="white",h.fillStyle="white"),h.beginPath(),h.moveTo(s,t),h.lineTo(q,r),h.stroke(),h.fill()}})})}else{h.strokeStyle="red";var w,x;2>=o?(w="Zoom out to see contour(s)",x=h.measureText(w).width,h.strokeText(w,b.width/2-x/2,b.height/2)):(w="Zoom in to see contour(s)",x=h.measureText(w).width,h.strokeText(w,b.width/2-x/2,b.height/2))}}var f,g=b[0];c.$observe("ssffTrackname",function(a){f=a}),a.$watch("vs.curViewPort",function(a,b){d(a,b)},!0),a.$watch("vs.curPreselColumnSample",function(a,b){d(a,b)},!0),a.$watch("vs.curCorrectionToolNr",function(a,b){d(a,b)},!0),a.$watch("ssffds.data",function(a,b){d(a,b)},!0),a.$watch("viewState.spectroSettings",function(a,b){d(a,b)},!0)}}}),angular.module("emulvcApp").service("Ssffparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.ssffTrackName="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.ssff2jso=function(a,c){var d=this;b.ssffData.ssffTrackName=c,b.ssffData.Columns=[];var e,f=new Uint8Array(a),g="";for(e=0;e<f.length;e++)g+=String.fromCharCode(f[e]);var h=g.split(/^/m);(h[0]!==d.headID||h[1]!==d.machineID)&&alert("no ssff file... or missing fields"),"Record_Freq "!==h[2].split(/[ ,]+/)[0]||"Start_Time "!==h[3].split(/[ ,]+/)[0]?(this.ssffData.sampleRate=parseFloat(h[2].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,"")),this.ssffData.startTime=parseFloat(h[3].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))):alert("no ssff file... or missing fields ");for(var e=4;e<h.length&&("Original_Freq"===h[e].split(/[ ,]+/)[0]&&(this.ssffData.origFreq=parseFloat(h[e].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),h[e]!==this.sepString);e++){var i=h[e].split(/[ ]+/);"Column"===i[0]&&this.ssffData.Columns.push({name:i[1],ssffdatatype:i[2],length:parseInt(i[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[]})}for(var j,k,l,m=h.slice(0,e+1).join("").length;m<=f.length;)for(e=0;e<this.ssffData.Columns.length;e++)"DOUBLE"===this.ssffData.Columns[e].ssffdatatype?(l=8*this.ssffData.Columns[e].length,k=a.subarray(m,l),j=new Float64Array(k),this.ssffData.Columns[e].values.push(Array.prototype.slice.call(j)),m+=l):"FLOAT"===this.ssffData.Columns[e].ssffdatatype?(l=4*this.ssffData.Columns[e].length,k=a.subarray(m,l),j=new Float32Array(k),this.ssffData.Columns[e].values.push(Array.prototype.slice.call(j)),m+=l):"SHORT"===this.ssffData.Columns[e].ssffdatatype?(l=2*this.ssffData.Columns[e].length,k=a.subarray(m,l),j=new Uint16Array(k),this.ssffData.Columns[e].values.push(Array.prototype.slice.call(j)),m+=l):alert("not supported... only doubles, floats, short  column types and for now");return this.ssffData},b.jso2ssff=function(a){var b=this,c=this.headID+this.machineID;c+="Record_Freq "+this.vs.round(a.sampleRate,1)+"\n",c+="Start_Time "+a.startTime+"\n",a.Columns.forEach(function(a){c+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),c+="Original_Freq DOUBLE "+this.vs.round(a.origFreq,1)+"\n",c+=this.sepString;var d,e,f=new Uint8Array(this.stringToUint(c));return d=new Uint16Array(a.Columns[0].length),e=a.Columns[0].values[0],a.Columns[0].values.forEach(function(c,e){a.Columns.forEach(function(a){if("SHORT"!==a.ssffdatatype)return void alert("Only SHORT columns supported for now!!!");d=new Uint16Array(a.length),a.values[e].forEach(function(a,b){d[b]=a});var c=new Uint8Array(d.buffer);f=b.Uint8Concat(f,c)})}),f.buffer},b.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},b.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},b}]),angular.module("emulvcApp").directive("correctiontool",function(){return{restrict:"A",link:function(a,b){b.bind("mousemove",function(b){if(void 0!==a.vs.curCorrectionToolNr){var c=a.ssffds.data[0].Columns[0],d=a.vs.getViewPortStartTime(),e=a.vs.getViewPortEndTime(),f=Math.round(d*c.sampleRate+c.startTime),g=Math.round(e*c.sampleRate+c.startTime),h=g-f,i=c.values.slice(f,f+h),j=d+a.dhs.getX(b)/b.originalEvent.srcElement.width*(e-d),k=Math.round((j+c.startTime)*c.sampleRate);if(a.vs.curPreselColumnSample=k-f-1,b.shiftKey){var l=angular.copy(i[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]),m=a.vs.spectroSettings.rangeTo-a.dhs.getY(b)/b.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo;i[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]=a.vs.spectroSettings.rangeTo-a.dhs.getY(b)/b.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo,a.hists.updateCurChangeObj({type:"SSFF",ssffIdx:0,colIdx:0,sampleBlockIdx:f+a.vs.curPreselColumnSample,sampleIdx:a.vs.curCorrectionToolNr-1,oldValue:l,newValue:m})}a.$apply()}})}}}),angular.module("emulvcApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Levelservice",function(a,b,c,d,e){function f(a,b,c){return a.measureText(b).width*c}function g(a,b,c,d){return b.toString().length>c.toString().length?f(a,b,d):f(a,c,d)}function h(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=a.curViewPort.eS-a.curViewPort.sS,j=a.curCursorPosInPercent*a.bufferLength-a.curViewPort.sS,k=j/i,l=f.width*k,m=1,n=Math.round(c*(f.height/d)),o=b*m,p=Math.round((f.height-n)/2),q=Math.round(e*(f.height/d)),r=(b-1)*m,s=Math.round((f.height-q)/2);l>=o?(h.fillStyle=g.vals.colors.playProgressColor,h.strokeStyle=g.vals.colors.playProgressColor):(h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor),h.beginPath(),h.moveTo(r,s),h.lineTo(o,p),h.stroke()}var i={};return i.osciPeaks=[],i.getX=function(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)},i.getY=function(a){return a.offsetY*(a.originalEvent.srcElement.height/a.originalEvent.srcElement.clientHeight)},i.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=-1/0,o=0,p=0,q=m.length;q>p;p++)m[p]>n&&(n=m[p]),o+=m[p];k+=o/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},i.freshRedrawDrawOsciOnCanvas=function(a,b,c,d,e){var f=b.getContext("2d");if(f.clearRect(0,0,b.width,b.height),c.peaks&&c.samplePerPx>=1)c.peaks.forEach(function(d,f){0!==f&&h(a,f,d,c.maxPeak,c.peaks[f-1],b,e)});else if(c.samplePerPx<1){var g=1/c.samplePerPx/2,i=a.curViewPort.sS;f.strokeStyle=e.vals.colors.osciColor,f.fillStyle=e.vals.colors.osciColor;var j;if(0===a.curViewPort.sS){for(f.moveTo(g,(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=0;j<c.peaks.length;j++)f.lineTo(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height);for(f.stroke(),j=0;j<c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.strokeText(i,j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}else{for(f.beginPath(),f.moveTo(-g,b.height-(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=1;j<=c.peaks.length;j++)f.lineTo(j/c.samplePerPx-g,b.height-((c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height+3));for(f.stroke(),j=1;j<=c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.fillText(i,j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}}if(e.vals.restrictions.drawZeroLine){if(f.strokeStyle=e.vals.colors.zeroLineColor,f.fillStyle=e.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&f.setLineDash([2]),c.samplePerPx>=1)f.beginPath(),f.moveTo(0,b.height/2),f.lineTo(b.width,b.height/2),f.stroke(),f.fillText("0",5,b.height/2-5,b.width);else{var k=b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height;f.beginPath(),f.moveTo(0,k),f.lineTo(b.width,k),f.stroke(),f.fill(),f.fillText("0",5,b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-5,b.width)}"Google Inc."===navigator.vendor&&f.setLineDash([0])}},i.drawMovingBoundaryLine=function(c){var d,f;if(f=a.getSampleDist(c.canvas.width),d="seg"===a.getcurMouseLevelType()?0:f/2,a.movingBoundary){c.fillStyle=b.vals.colors.selectedBoundaryColor;var g=e.getLevelDetails(a.getcurMouseLevelName()).level,h=a.getcurMouseSegment(),i=e.getElementDetails(a.getcurMouseLevelName(),h.id);if("SEGMENT"==g.type)var j=Math.round(a.getPos(c.canvas.width,i.sampleStart));else var j=Math.round(a.getPos(c.canvas.width,i.samplePoint));c.fillRect(j+d,0,1,c.canvas.height)}},i.drawCurViewPortSelected=function(e,h){var i,j;j=a.getSampleDist(e.canvas.width),i="seg"===a.getcurMouseLevelType()?0:j/2;var k=a.getPos(e.canvas.width,a.curViewPort.selectS),l=a.getPos(e.canvas.width,a.curViewPort.selectE);if(k===l)e.fillStyle=b.vals.colors.selectedBorderColor,e.fillRect(k+i,0,1,e.canvas.height);else if(e.fillStyle=b.vals.colors.selectedAreaColor,e.fillRect(k,0,l-k,e.canvas.height),e.strokeStyle=b.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(k,0),e.lineTo(k,e.canvas.height),e.moveTo(l,0),e.lineTo(l,e.canvas.height),e.closePath(),e.stroke(),h){var m=e.canvas.width/e.canvas.offsetWidth,n=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),o=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1);if(e.drawImage(o,0,0,o.width,o.height,k-n-5,0,o.width,o.height),o=d.getTextImageTwoLines(e,a.curViewPort.selectE,a.round(a.curViewPort.selectE/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(o,0,0,o.width,o.height,l+5,0,o.width,o.height),n=f(e,a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),l-k>n){var p=a.curViewPort.selectE-a.curViewPort.selectS,q=a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);n=g(e,p,q,m),o=d.getTextImageTwoLines(e,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(o,0,0,o.width,o.height,k+(l-k)/2-n/2,0,o.width,o.height)}}},i}]),angular.module("emulvcApp").service("HistoryService",["Ssffdataservice","Levelservice","ConfigProviderService",function(a,b,c){function d(d,e){Object.keys(d).forEach(function(f){var g=d[f];if("SSFF"===g.type)a.data[g.ssffIdx].Columns[g.colIdx].values[g.sampleBlockIdx][g.sampleIdx]=e?g.oldValue:g.newValue;else if("ESPS"===g.type)switch(console.log("###UNDOING esps change"),console.log(g),g.action){case"moveBoundary":e?b.moveBoundry(-g.movedBy,g.name,g.itemIdx,g.neighbours):b.moveBoundry(g.movedBy,g.name,g.itemIdx,g.neighbours);break;case"snapBoundary":if(e){var h=b.getLevelDetails(g.name);b.moveBoundry(-g.movedBy,h.level,g.itemIdx,g.max)}else{var h=b.getLevelDetails(g.name);b.moveBoundry(g.movedBy,h.level,g.itemIdx,g.max)}break;case"moveSegment":e?b.moveSegment(-g.movedBy,g.name,g.itemIdx,g.neighbours):b.moveSegment(g.movedBy,g.name,g.itemIdx,g.neighbours);break;case"movePoint":e?b.movePoint(-g.movedBy,g.name,g.itemIdx):b.movePoint(g.movedBy,g.name,g.itemIdx);break;case"renameLabel":e?b.renameLabel(g.name,g.itemIdx,g.oldValue):b.renameLabel(g.name,g.itemIdx,g.newValue);break;case"renameLevel":e?b.renameLevel(g.name,g.oldName):b.renameLevel(g.oldName,g.name);break;case"deleteLevel":e?b.data.levels.splice(g.itemIdx,0,g.level):b.data.levels.splice(g.itemIdx,1);break;case"deleteBoundary":e?b.insertSegment(g.seg.sampleStart,g.seg.sampleStart,g.levelName,c.vals.labelCanvasConfig.newSegmentName):b.deleteBoundary(g.seg,g.levelName,g.levelType);break;case"deleteSegments":e?b.deleteSegmentsInvers(g.selected,g.ids,g.levelName):b.deleteSegments(g.selected,g.ids,g.levelName);break;case"insertSegments":e?b.insertSegmentInvers(g.start,g.end,g.levelName,g.segname):b.insertSegment(g.start,g.end,g.levelName,g.segname);break;case"insertPoint":e?b.insertPointInvers(g.start,g.levelName,g.pointName):b.insertPoint(g.start,g.levelName,g.pointName);break;case"expandSegments":e?b.expandSegment(g.rightSide,g.itemIdx,g.name,g.changeTime):b.expandSegment(g.rightSide,g.itemIdx,g.name,g.changeTime)}})}var e={},f=[],g=[],h={};return e.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.ssffIdx)+"#"+String(a.colIdx)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),h[b]?(console.log("here"+h[b].oldValue),a.oldValue=h[b].oldValue,h[b]=a):h[b]=a;else if("ESPS"===a.type)switch(a.action){case"moveBoundary":case"movePoint":case"moveSegment":b=String(a.type+"#"+a.action+"#"+a.levelName+"#"+a.itemIdx),h[b]?(a.movedBy+=h[b].movedBy,h[b]=a):h[b]=a}},e.addCurChangeObjToUndoStack=function(){g=[],$.isEmptyObject(h)||f.push(h),h={}},e.addObjToUndoStack=function(a){g=[];var b={};b[String(a.type)+"#"+String(a.ssffIdx)+"#"+String(a.itemIdx)]=a,$.isEmptyObject(b)||f.push(b),h={},console.log(f)},e.undo=function(){if(f.length>0){var a=angular.copy(f[f.length-1]);g.push(a),d(a,!0),f.pop()}},e.redo=function(){if(g.length>0){var a=angular.copy(g[g.length-1]);f.push(a),d(a,!1),g.pop()}},e.getNrOfPosibleUndos=function(){return f.length},e}]),angular.module("emulvcApp").service("Wavparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.wav2jso=function(a){var b,c,d,e={};return b=0,c=a.subarray(b,4),d=new Uint8Array(c),e.ChunkID=String.fromCharCode.apply(null,d),"RIFF"!==e.ChunkID&&console.error("Wav read error: ChunkID not RIFF. Got "+e.ChunkID),b=4,c=a.subarray(b,4),d=new Uint32Array(c),e.ChunkSize=d[0],b=8,c=a.subarray(b,4),d=new Uint8Array(c),e.Format=String.fromCharCode.apply(null,d),"WAVE"!==e.Format&&console.error("Wav read error: Format not WAVE. Got "+e.Format),b=12,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk1ID=String.fromCharCode.apply(null,d),"fmt "!==e.Subchunk1ID&&console.error("Wav read error: Subchunk1ID not fmt. Got "+e.Subchunk1ID),b=16,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk1Size=d[0],16!==e.Subchunk1Size&&console.error("Wav read error: Subchunk1Size not 16"),b=20,c=a.subarray(b,2),d=new Uint16Array(c),e.AudioFormat=d[0],1!==e.AudioFormat&&console.error("Wav read error: AudioFormat not 1"),b=22,c=a.subarray(b,2),d=new Uint16Array(c),e.NumChannels=d[0],1!==e.NumChannels&&console.error("Wav read error: NumChannels not 1"),b=24,c=a.subarray(b,4),d=new Uint32Array(c),e.SampleRate=d[0],b=28,c=a.subarray(b,4),d=new Uint32Array(c),e.ByteRate=d[0],b=32,c=a.subarray(b,2),d=new Uint16Array(c),e.BlockAlign=d[0],b=34,c=a.subarray(b,2),d=new Uint16Array(c),e.BitsPerSample=d[0],16!==e.BitsPerSample&&console.error("Wav read error: NumChannels not 1"),b=36,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk2ID=String.fromCharCode.apply(null,d),"data"!==e.Subchunk2ID&&console.error("Wav read error: BitsPerSample not 16"),b=40,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk2Size=d[0],b=44,c=a.subarray(b,e.Subchunk2Size),d=new Int16Array(c),e.Data=d,e.origArrBuf=a,e},b}]),$(function(){function a(a){var b=a.pageY,c=a.pageX,d=a.originalEvent.targetTouches;return d&&(c=d[0].pageX,b=d[0].pageY),{x:c,y:b}}function b(a,b,d){return a.each(function(){var a=$(this),e=b?$(b,this).css("cursor",d):a;e.bind(g,{e:a,k:d},c)})}function c(b){var c=a(b),g=function(a){return parseInt(f.css(a),10)||!1};return f=b.data.e,j={X:g("left")||0,Y:g("top")||0,H:g("height")||f[0].scrollHeight||0,pX:c.x,pY:c.y,k:b.data.k},$(".MainCtrl").scope().dragStart(),$(document).bind(h,d).bind(i,e),k=$(document).height()-2*$(".menu-bottom").height(),!1}function d(b){var c=a(b),d=Math.max(c.y-j.pY+j.H,0);return k>d&&(f.css({height:d}),$(".MainCtrl").scope().refreshTimeline(),$(".HandleLevelsCtrl").css("padding-top",$(".TimelineCtrl").height()+2*$(".menu").height()+"px")),!1}function e(){$(".MainCtrl").scope().dragEnd(),$(document).unbind(h,d).unbind(i,e)}var f,g="mousedown touchstart",h="mousemove touchmove",i="mouseup touchend",j={},k=0;$.fn.ownResize=function(a){return b(this,a,"ns-resize")}}),angular.module("emulvcApp").service("Textgridparserservice",["Soundhandlerservice","viewState",function(a,b){var c={};return c.shs=a,c.l1='File type = "ooTextFile"',c.l2='Object class = "TextGrid"',c.toJSO=function(a){a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g,"");var b,c,d,e,f=a.split("\n"),g=!0,h={origSamplerate:this.shs.wavJSO.SampleRate,fileURI:"",levels:[]};if(f[0].replace(/\s+/g,"")===this.l1.replace(/\s+/g,"")&&f[1].replace(/\s+/g,"")===this.l2.replace(/\s+/g,"")){for(var i=2;i<f.length;i++){var j=f[i];if("item[]:"!==j){if(!g)if(0===j.indexOf("item[")&&(b='"IntervalLevel"'===f[i+1].split(/=/)[1]?"seg":"point",c=f[i+2].split(/=/)[1].replace(/"/g,""),h.levels.push({LevelName:c,type:b,items:[]})),h.levels.length>0&&"seg"===h.levels[h.levels.length-1].type&&0===j.indexOf("intervals")&&0!==j.indexOf("intervals:")){var k=Math.ceil(f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate),l=Math.floor(f[i+2].split(/=/)[1]*this.shs.wavJSO.SampleRate);e=f[i+3].split(/=/)[1].replace(/"/g,""),0===k&&(k+=1),h.levels[h.levels.length-1].items.push({label:e,sampleStart:k-1,sampleDur:l-k})}else h.levels.length>0&&"point"===h.levels[h.levels.length-1].type&&0===j.indexOf("points")&&0!==j.indexOf("points:")&&(d=f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate,e=f[i+2].split(/=/)[1].replace(/"/g,""),h.levels[h.levels.length-1].items.push({label:e,sampleStart:Math.round(d)}))}else g=!1}return this.testForGapsInLabelJSO(h),h}alert("bad header in TextGrid file!!! The header has to be: ",this.l1,"\n",this.l2)},c.toTextGrid=function(){var b='File type = "ooTextFile"',d='Object class = "TextGrid"',e="",f="\n",g="	";e=e+b+f+d+f+f,e=e+"xmin = "+c.findTimeOfMinSample()+f,e=e+"xmax = "+c.findTimeOfMaxSample()+f,e=e+"levels? <exists>"+f,e=e+"size = "+$("#HandleLevelsCtrl").scope().getLevelLength()+f,e=e+"item []:"+f;var h=0;return $("#HandleLevelsCtrl level").each(function(){var b=$("#HandleLevelsCtrl").scope().getLevel($(this).attr("id"));h+=1,e=e+g+"item ["+h+"]:"+f,"seg"===b.type?e=e+g+g+'class = "IntervalLevel"'+f:"point"===b.type&&(e=e+g+g+'class = "TextLevel"'+f),e=e+g+g+'name = "'+b.LevelName+'"'+f,e=e+g+g+"xmin = "+c.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+c.findTimeOfMaxSample()+f,"seg"===b.type?e=e+g+g+"intervals: size = "+b.items.length+f:"point"===b.type&&(e=e+g+g+"points: size = "+b.items.length+f);for(var d=0;d<b.items.length;d++){var i=d+1;"seg"===b.type?(e=e+g+g+g+"intervals ["+i+"]:"+f,e=0!==b.items[d].sampleStart?e+g+g+g+g+"xmin = "+(b.items[d].sampleStart/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmin = 0"+f,e=d<b.items.length-1?e+g+g+g+g+"xmax = "+((b.items[d].sampleStart+b.items[d].sampleDur+1)/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmax = "+c.findTimeOfMaxSample()+f,e=e+g+g+g+g+'text = "'+b.items[d].label+'"'+f):"point"===b.type&&(e=e+g+g+g+"points["+i+"]:"+f,e=e+g+g+g+g+"time = "+b.items[d].sampleStart/a.wavJSO.SampleRate+f,e=e+g+g+g+g+'mark = "'+b.items[d].label+'"'+f)}}),e},c.findTimeOfMinSample=function(){return 0},c.findTimeOfMaxSample=function(){return b.curViewPort.bufferLength/a.wavJSO.SampleRate},c.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.levels.length;c++)if("seg"===a.levels[c].type)for(var d=0;d<a.levels[c].items.length-1;d++)a.levels[c].items[d].sampleStart+a.levels[c].items[d].sampleDur+1!==a.levels[c].items[d+1].sampleStart&&(b+=1)},c}]),angular.module("emulvcApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emulvcApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=5,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth,i=document.createElement("canvas"),j=i.getContext("2d");return j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth,k=document.createElement("canvas"),l=k.getContext("2d");if(l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return k},a}),angular.module("emulvcApp").directive("draggable",["$rootScope","uuid",function(a,b){return{restrict:"A",link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragstart",function(b){b.originalEvent.dataTransfer.setData("text",e),angular.element(d).addClass("dragDragging"),a.$emit("dragStart")}),d.bind("dragend",function(){angular.element(d).removeClass("dragDragging"),a.$emit("dragEnd")})}}}]),angular.module("emulvcApp").directive("dropable",["$rootScope","uuid",function(a,b){return{restrict:"A",scope:{onDrop:"&"},link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move",!1}),d.bind("dragenter",function(a){angular.element(a.target).addClass("dragOver")}),d.bind("dragleave",function(a){angular.element(a.target).removeClass("dragOver")}),d.bind("drop",function(a){a.preventDefault&&a.preventDefault(),a.stopPropogation&&a.stopPropogation();var b=a.originalEvent.dataTransfer.getData("text"),d=document.getElementById(e),f=document.getElementById(b);angular.element(a.target).removeClass("dragTarget"),angular.element(a.target).removeClass("dragOver"),c.drop(f,d)}),a.$on("dragStart",function(){var a=document.getElementById(e);angular.element(a).addClass("dragTarget")}),a.$on("dragEnd",function(){var a=document.getElementById(e);angular.element(a).removeClass("dragTarget"),angular.element(a).removeClass("dragOver")})}}}]),angular.module("emulvcApp").service("Espsparserservice",["Soundhandlerservice",function(a){var b={};return b.toJSO=function(b,c){var d="_"+c.split(".")[c.split(".").length-1];b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/[ \t]+/g," ");for(var e,f=b.split("\n"),g=0;g<f.length;g++)if("#"===f[g]){e=g;break}var h={fileInfos:[{fileURI:c,fileType:"esps",associatedLevelNames:[d]}],levels:[]};h.levels.push({LevelName:d,type:"",items:[]});var i,j=f[e+1].split(/\s+/);if(h.levels[0].type="H#"!==j[j.length-1]?"point":"seg","point"===h.levels[0].type)for(g=e+1;g<f.length-1;g++)j=f[g].split(/\s+/),h.levels[0].items.push({label:j[j.length-1],sampleStart:Math.round(j[1]*a.wavJSO.SampleRate)});else for(j=f[e+1].split(/\s+/),h.levels[0].items.push({label:"",sampleStart:0,sampleDur:Math.round(j[1]*a.wavJSO.SampleRate)}),g=e+2;g<f.length-1;g++)j=f[g].split(/\s+/),i=f[g-1].split(/\s+/),h.levels[0].items.push({label:j[j.length-1],sampleStart:Math.round(i[1]*a.wavJSO.SampleRate),sampleDur:Math.round((j[1]-i[1])*a.wavJSO.SampleRate)});return h},b.toESPS=function(b){var c=b.LevelName.substring(1),d="";d+="signal "+c+"\n",d+="nfields 1\n",d+="#\n";var e;return b.items.forEach(function(b,c){e=""===b.label&&0===c?"H#":b.label,d+="	"+String((b.sampleStart+b.sampleDur)/a.wavJSO.SampleRate)+"	125	"+e+"\n"}),d},b}]),angular.module("emulvcApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e,f,g){a.loginData={username:"",accesscode:"",errorMsg:""},a.tryLogin=function(){e.wsH.checkAccessCode(a.loginData.accesscode).then(function(c){"CORRECT"===c?(console.log("u are the champion"),e.wsH.getUsrUttList(a.loginData.username).then(function(c){"USER NOT FOUND"===c?a.loginData.errorMsg=c:(a.loginData.errorMsg="USER FOUND",b.$broadcast("newUserLoggedOn",a.loginData.username),a.cancel())})):a.loginData.errorMsg="Error wrong access code!!"})},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1},a.cancel=function(){g.close()}}]),angular.module("emulvcApp").service("Ssffdataservice",function(){var a={};return a.data=[],a.getColumnOfTrack=function(b,c){var d;return a.data.forEach(function(a){a.ssffTrackName===b&&a.Columns.forEach(function(a){a.name===c&&(d=a)})}),d},a.getSampleRateAndStartTimeOfTrack=function(b){var c={};return a.data.forEach(function(a){a.ssffTrackName===b&&(c.sampleRate=a.sampleRate,c.startTime=a.startTime)}),c},a}),angular.module("emulvcApp").service("Levelservice",["$rootScope","uuid",function(a,b){var c={};return c.data={},c.getData=function(){return c.data},c.setData=function(a){a.levels.forEach(function(a){"SEGMENT"===a.type&&a.items.forEach(function(a){void 0===a.id&&(a.id=b.new())}),"EVENT"===a.type&&a.items.forEach(function(a){void 0===a.id&&(a.id=b.new())})}),angular.copy(a,c.data)},c.getLevelDetails=function(a){var b=null,d=null;return c.data.levels.forEach(function(c,e){c.name===a&&(b=c,d=e)}),{level:b,id:d}},c.getElementDetails=function(a,b){var d=null;return c.data.levels.forEach(function(c){c.name===a&&c.items.forEach(function(a){a.id==b&&(d=a)})}),d},c.setElementDetails=function(a,b,d,e,f){c.data.levels.forEach(function(c){c.name===a&&c.items.forEach(function(a){a.id==b&&(a.sampleStart=e,a.sampleDur=f,a.labels[0].value=d)})})},c.setPointDetails=function(a,b,d,e){c.data.levels.forEach(function(c){c.name===a&&c.items.forEach(function(a){a.id==b&&(a.samplePoint=e,a.labels[0].value=d)})})},c.getElementNeighbourDetails=function(a,b,d){var e=null,f=null;return c.data.levels.forEach(function(c){c.name===a&&c.items.forEach(function(a,g){a.id==b&&(e=c.items[g-1]),a.id==d&&(f=c.items[g+1])})}),{left:e,right:f}},c.getEvent=function(a,b,c){var d=null,e=null;if("SEGMENT"===b.type)angular.forEach(b.items,function(c,f){a>=c.sampleStart&&a<=c.sampleStart+c.sampleDur&&(e=a-c.sampleStart>=c.sampleDur/2&&f-1>=0?b.items[f+1]:b.items[f]),a>=c.sampleStart&&a<=c.sampleStart+c.sampleDur&&(d=c)});else{var f=0,g=0;angular.forEach(b.items,function(h,i){g=i<b.items.length-1?h.samplePoint+(b.items[i+1].samplePoint-b.items[i].samplePoint)/2:c,f=i>0?h.samplePoint-(b.items[i].samplePoint-b.items[i-1].samplePoint)/2:0,g>=a&&a>=f&&(d=h,e=h)})}return{evtr:d,nearest:e}},c.deleteLevel=function(a){var b,d=0;return angular.forEach(c.data.levels,function(e,f){e.name===a&&(b=e,d=f,c.data.levels.splice(f,1))}),{level:b,id:d,name:a}},c.renameLabel=function(a,b,d){c.setElementDetails(a,b,d)},c.renameLevel=function(a,b){angular.forEach(c.data.levels,function(c){c.name===a&&(c.name=b)})},c.deleteSegmentsInvers=function(a,b,d){{var e,f,g=b[0]-1;b[b.length-1]+1}return angular.forEach(c.data.levels,function(c){if(c.name===d&&"SEGMENT"===c.type){var h=0;for(var i in a)h+=a[i].sampleDur;if(g>=0){c.items[g].sampleDur-=h/2,c.items[g+1].sampleDur-=h/2,c.items[g+1].sampleStart+=h/2;for(var i in b)c.items.splice(b[i],0,a[i]);e=c.items[g],f=g}else e=c.items[0],f=0}}),{segment:e,id:f}},c.deleteSegments=function(a,b){var d,e;return angular.forEach(c.data.levels,function(c){if(c.name===b&&"SEGMENT"===c.type){var f=0,g="";for(var h in a)f+=a[h].sampleDur,g+=a[h].labels[0].value;start>=0?(c.items[start].sampleDur+=f/2,c.items[end].sampleDur+=f/2,c.items[end].sampleStart-=f/2,c.items.splice(ids[0],ids.length),d=c.items[start],e=start):(d=c.items[0],e=0)}}),{segment:d,id:e}},c.insertSegmentInvers=function(a,b,d){var e=!0;return angular.forEach(c.data.levels,function(c){if(c.name===d)if(a==b){var f=-1;if(angular.forEach(c.items,function(b,c){a==b.sampleStart&&(f=c,e=!0)}),e){var g=c.items[f].sampleDur;c.items[f-1].sampleDur+=g,c.items.splice(f,1)}}else{var f=-1;if(angular.forEach(c.items,function(b,c){a==b.sampleStart&&(f=c,e=!0)}),e){var g=c.items[f].sampleDur,h=c.items[f+1].sampleDur;c.items[f-1].sampleDur+=g+h,c.items.splice(f,2)}}}),e},c.insertSegment=function(a,b,d,e){var f=!0;return angular.forEach(c.data.levels,function(c){if(c.name===d)if(a==b){var g=-1;if(angular.forEach(c.items,function(b,c){a>=b.sampleStart&&a<=b.sampleStart+b.sampleDur&&(g=c),b.sampleStart==a&&(f=!1),b.sampleStart+b.sampleDur==a&&(f=!1)}),f){var h=a-c.items[g].sampleStart;c.items.splice(g,0,angular.copy(c.items[g])),c.items[g+1].sampleStart=a,c.items[g+1].sampleDur=c.items[g].sampleDur-h,c.items[g+1].label=e,c.items[g].sampleDur=h}}else{var g=-1,i=-1;if(angular.forEach(c.items,function(c,d){a>=c.sampleStart&&a<=c.sampleStart+c.sampleDur&&(g=d),b>=c.sampleStart&&b<=c.sampleStart+c.sampleDur&&(i=d)
}),f=g===i,g===i){var h=a-c.items[g].sampleStart,j=b-a;c.items.splice(g,0,angular.copy(c.items[g])),c.items.splice(g,0,angular.copy(c.items[g])),c.items[g+1].sampleStart=a,c.items[g+1].sampleDur=j,c.items[g+1].label=e,c.items[g+2].sampleStart=b,c.items[g+2].sampleDur=c.items[g].sampleDur-h-j,c.items[g+2].label=e,c.items[g].sampleDur=h}}}),f},c.insertPoint=function(a,b,d){var e=!1;return angular.forEach(c.data.levels,function(c){if(c.name===b&&"point"==c.type){var f=0;angular.forEach(c.items,function(b,g){e||(a>f&&a<b.sampleStart&&Math.floor(a)!=Math.floor(b.sampleStart)&&(console.log(c.items),console.log(g),c.items.splice(g-1,0,angular.copy(c.items[g-1])),console.log(c.items),c.items[g].sampleStart=a,c.items[g].label=d,e=!0),f=b.sampleStart)})}}),e},c.insertPointInvers=function(a,b){var d=!1;return angular.forEach(c.data.levels,function(c){if(c.name===b&&"point"==c.type){angular.forEach(c.items,function(b,e){d||a==b.sampleStart&&(c.items.splice(e,1),d=!0)})}}),d},c.deleteBoundary=function(a,b){var d=null;angular.forEach(c.data.levels,function(c){c.name===b&&angular.forEach(c.items,function(b,e){"SEGMENT"===c.type?b.id==a.id&&(d.labels[0].value+=b.labels[0].value,d.sampleDur+=b.sampleDur,c.items.splice(e,1)):b.samplePoint==a.samplePoint&&c.items.splice(e,1),d=b})})},c.snapBoundary=function(a,b,d,e){var f,g,h,i,j=1/0;return c.data.levels.forEach(function(e,k){if(e.name===d){if(g=e,a){if(!(k>=1))return!1;f=c.data.levels[k-1]}else{if(!(k<c.data.levels.length-1))return!1;f=c.data.levels[k+1]}f.items.forEach(function(a){h=Math.abs(b-a.sampleStart),j>h&&(j=h,i=a.sampleStart-b)})}}),void 0!==i?(this.moveBoundry(i,g,e),i):!1},c.moveBoundry=function(a,b,d,e){var f=c.getElementDetails(b,d.id),g=c.getElementDetails(b,e.left.id);e.left.sampleDur+a>0&&d.sampleStart+a>0&&d.sampleDur-a>0&&(c.setElementDetails(b,e.left.id,g.labels[0].value,g.sampleStart,g.sampleDur+a),c.setElementDetails(b,d.id,f.labels[0].value,f.sampleStart+a,f.sampleDur-a))},c.movePoint=function(a,b,d){var e=c.getElementDetails(b,d.id);c.setPointDetails(b,d.id,e.labels[0].value,e.samplePoint+a)},c.moveSegment=function(a,b,d,e){var f=c.getElementDetails(b,e.left.id),g=c.getElementDetails(b,e.right.id);e.left.sampleDur+a>=1&&e.right.sampleDur-a>=1&&(c.setElementDetails(b,e.left.id,f.labels[0].value,f.sampleStart,f.sampleDur+a),c.setElementDetails(b,e.right.id,g.labels[0].value,g.sampleStart+a,g.sampleDur-a),angular.forEach(d,function(d){var e=c.getElementDetails(b,d.id);c.setElementDetails(b,d.id,e.labels[0].value,e.sampleStart+a,e.sampleDur)}))},c.expandSegment=function(b,d,e,f){var g;b?angular.forEach(d,function(a){c.setElementDetails(e,a.id,a.labels[0].value,a.sampleStart,a.sampleDur+f)}):angular.forEach(c.data.levels,function(b){if(b.name===tN)if(b.items[selected[0]-1].sampleDur>selected.length*f)if(b.items[selected[selected.length-1]].sampleDur>selected.length*f){var c=!1;for(g=1;g<=selected.length;g++)b.items[selected[g-1]].sampleDur+f<=0&&(c=!0);if(c)a.$broadcast("errorMessage","Expand Segements Error : Cannot Expand/Shrink. Segment would be too small");else{for(g=0;g<selected.length;g++)b.items[selected[g]].sampleStart-=f*(selected.length-g),b.items[selected[g]].sampleDur+=f;b.items[selected[0]-1].sampleDur-=f*selected.length}}else a.$broadcast("errorMessage","Expand Segements Error : No Space left to increase");else a.$broadcast("errorMessage","Expand Segements Error : No Space left to decrease")})},c}]),angular.module("emulvcApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","ngProgressLite","HistoryService","Ssffparserservice","Levelservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a){C=!0,b.$apply(B.resolve(a))}function s(a){w(JSON.parse(a.data))}function t(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(B.resolve(a))}function u(){C=!1,console.log("WEBSOCKET closed!!!!!")}function v(b){var c=a.defer(),e=x();return z[e]={time:new Date,cb:c},b.callbackID=e,A.send(JSON.stringify(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+i.vals.main.wsTimeoutInterval+"ms!  Please check the server..."}};w(a)},i.vals.main.wsTimeoutInterval),c.promise}function w(a){var c=a;if(z.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":handleReceivedESPS(c.fileName,c.data);break;case"getSSFFfile":handleReceivedSSFF(c.fileName,c.data)}"SUCCESS"===c.status.type?b.$apply(z[c.callbackID].cb.resolve(c.data)):q.open("views/error.html","ModalCtrl","Communication error with server! Error message is: "+c.status.message),delete z[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||q.open("views/error.html","ModalCtrl","What just happened? You should not be here...")}function x(){var a=n.new();return a}var y={},z={},A={},B={},C=!1;return y.initConnect=function(b){var c=a.defer();return A=new WebSocket(b),A.onopen=r,A.onmessage=s,A.onerror=t,A.onclose=u,B=c,c.promise},y.isConnected=function(){return C},y.closeConnect=function(){A.onclose=function(){},A.close()},y.getProtocol=function(){var a={type:"GETPROTOCOL"},b=v(a);return b},y.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=v(a);return b},y.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=v(a);return b},y.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=v(a);return b},y.getBundle=function(a){e.start(),e.set(.5);var b={type:"GETBUNDLE",name:a},c=v(b);return c},y}]),angular.module("emulvcApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e){a.wsServerUrl=b.vals.main.wsServerUrl,a.connectionError="",d.focusInTextField=!0,a.tryConnection=function(){e.close(a.wsServerUrl)},a.cancel=function(){e.close(!1)}}]),angular.module("emulvcApp").service("Httphandler",["$rootScope","$http","$q","HistoryService","viewState","ConfigProviderService","Soundhandlerservice","Ssffparserservice","Wavparserservice","Espsparserservice",function(a,b,c,d,e,f,g,h,i,j){var k={};return k.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},k.getUttList=function(a){var c=b.get(a);return c},k.getSSFFfile=function(c){b.get(c,{responseType:"arraybuffer"}).success(function(b){var d=h.ssff2jso(b);d.fileURL=document.URL+c,a.$broadcast("newlyLoadedSSFFfile",d,c.replace(/^.*[\\\/]/,""))})},k.getESPS=function(c){b.get(c).success(function(b){var d=j.toJSO(b,c);a.$broadcast("newlyLoadedLabelJson",d)}).error(function(a,b){console.log("Request failed with status: "+b)})},k.getUtt=function(h){var j,l,m=[],n=c.defer();return l=k.findFileInUtt(h,f.vals.signalsCanvasConfig.extensions.audio),b.get(l,{responseType:"arraybuffer"}).then(function(a){var b=i.wav2jso(a.data);return b}).then(function(b){e.curViewPort.sS=0,e.curViewPort.eS=b.Data.length,e.curViewPort.bufferLength=b.Data.length,e.setscrollOpen(0),e.resetSelect(),g.wavJSO=b,a.$broadcast("cleanPreview")}).then(function(){f.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){l=k.findFileInUtt(h,a),j=k.getSSFFfile(l),m.push(j)})}).then(function(){f.vals.labelCanvasConfig.order.forEach(function(a){l=k.findFileInUtt(h,a),console.log(l),j=k.getESPS(l),m.push(j)})}),c.all(m).then(function(){console.log("history"),d.history(),n.resolve("finishedLoadingUtt")}),n.promise},k}]),angular.module("emulvcApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a.stringToArrayBuffer=function(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d<a.length;++d)c[d]=a.charCodeAt(d);return b},a}),angular.module("emulvcApp").service("dialogService",["$modal","viewState",function(a,b){var c={},d={};return c.open=function(c,e,f){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{passedInTxt:function(){return f}}}),d.result},c.openExport=function(c,e,f,g){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{exportData:function(){return f},exportName:function(){return g}}}),d.result},c.close=function(a){b.focusInTextField=!1,b.setState(b.prevState),d.close(a)},c}]),angular.module("emulvcApp").controller("WaitCtrl",["$scope","viewState",function(a,b){a.vs=b}]),angular.module("emulvcApp").service("Appcachehandler",["$http","dialogService",function(a,b){function c(){n.filesDownloaded=0,n.totalFiles=0,a.get("manifest.appcache").success(function(a){a=a.replace(new RegExp("(NETWORK|FALLBACK):((?!(NETWORK|FALLBACK|CACHE):)[\\w\\W]*)","gi"),""),a=a.replace(new RegExp("#[^\\r\\n]*(\\r\\n?|\\n)","g"),""),a=a.replace(new RegExp("CACHE MANIFEST\\s*|\\s*$","g"),""),a=a.replace(new RegExp("[\\r\\n]+","g"),"#");var b=a.split("#").length;n.totalFiles=b+1})}function d(a){console.log("###### handleCheckingEvent ##########"),console.log(a)}function e(a){console.log("###### handleNoupdateEvent ##########"),console.log(a)}function f(a){console.log("######## handleDownloadingEvent ##########"),console.log(a),c()}function g(a){console.log("###### handleProgressEvent ##########"),console.log(a)}function h(a){console.log("###### handleCachedEvent ##########"),console.log(a),b.open("views/confirmModal.html","ConfirmmodalCtrl","A new version of the EMU-WebApp is available and has already been downloaded! Would you like to use it (CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-WebApp you will automatically use the updated version)?").then(function(a){a&&window.location.reload()})}function i(a){console.log("###### handleUpdatereadyEvent ##########"),console.log(a)}function j(a){console.log("###### handleObsoleteEvent ##########"),console.log(a)}function k(a){console.log("###### handleErrorEvent ##########"),console.log(a)}var l={},m=window.applicationCache,n={filesDownloaded:0,totalFiles:0};return m.addEventListener("checking",d,!1),m.addEventListener("noupdate",e,!1),m.addEventListener("downloading",f,!1),m.addEventListener("progress",g,!1),m.addEventListener("cached",h,!1),m.addEventListener("updateready",i,!1),m.addEventListener("obsolete",j,!1),m.addEventListener("error",k,!1),l.checkForNewVersion=function(){console.log("check for new version")},l}]);var counter=0;window.addEventListener("load",function(){window.applicationCache.addEventListener("updateready",function(){console.log("counter:"+counter),$(".modal").css("display","none")},!1),window.applicationCache.addEventListener("progress",function(){counter+=1},!1),window.applicationCache.addEventListener("checking",function(){},!1)},!1),document.addEventListener("DOMContentLoaded",function(){console.log("DOM fully loaded and parsed"),console.log(document.getElementById("appcachemodal"))}),angular.module("emulvcApp").controller("AboutCtrl",["$scope","ConfigProviderService","dialogService",function(a,b,c){a.cps=b,a.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 38:b="↑";break;case 40:b="↓";break;case 187:b="+";break;case 189:b="-";break;default:b=String.fromCharCode(a)}return b},a.cancel=function(){c.close()}}]),angular.module("emulvcApp").controller("SpectsettingsCtrl",["$scope","dialogService","viewState",function(a,b,c){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],console.log(Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1]),a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowLength:a.vs.spectroSettings.windowLength,window:a.vs.spectroSettings.window},a.cursorInTextField=function(){c.focusInTextField=!0},a.cursorOutOfTextField=function(){c.focusInTextField=!1},a.saveSpectroSettings=function(){console.log(a.modalVals),console.log(a.selWindowInfo.name),c.setspectroSettings(a.modalVals.windowLength,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name),a.cancel()},a.cancel=function(){b.close()}}]),angular.module("emulvcApp").controller("ConfirmmodalCtrl",["$scope","dialogService","passedInTxt",function(a,b,c){a.passedInTxt=c,a.confirm=function(){b.close(!0)},a.cancel=function(){b.close(!1)}}]),angular.module("emulvcApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emulvcApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT"),f=new RegExp("EVENT"),g=[],h=0;h<c.length;h++)(e.test(c[h].type)||f.test(c[h].type))&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[h].name),-1!==d&&(g[d]=c[h]));return g}}}]),angular.module("emulvcApp").controller("ModalCtrl",["$scope","dialogService","passedInTxt","viewState","Levelservice","HistoryService",function(a,b,c,d,e,f){a.passedInTxt=c,a.passedOutTxt={"var":null},a.cancel=function(){b.close()},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.renameLevel=function(){e.renameLevel(a.passedInTxt,a.passedOutTxt.var),f.addObjToUndoStack({type:"ESPS",action:"renameLevel",levelName:a.passedOutTxt.var,oldName:a.passedInTxt}),b.close()},a.saveChanges=function(){b.close()},a.discardChanges=function(){b.close()},a.deleteLevel=function(){var a;a=e.deleteLevel(d.getcurClickLevelName()),f.addObjToUndoStack({type:"ESPS",action:"deleteLevel",levelName:a.name,itemIdx:a.id,level:a.level}),b.close()}}]),angular.module("emulvcApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?a.addClass(c,".slideInMenu"):a.removeClass(c,".slideInMenu")})}}}]),angular.module("emulvcApp").animation(".slideInMenu",function(){return{addClass:function(a){a.addClass("slideLeft")},removeClass:function(a){a.removeClass("slideLeft")}}}),angular.module("emulvcApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emulvcApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a){a.addClass("slide2dCanvases")},removeClass:function(a){a.removeClass("slide2dCanvases")}}});