"use strict";ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emulvcApp",["ui","ui.bootstrap","ngRoute"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),angular.module("emulvcApp").service("ConfigProviderService",["$rootScope","$http",function(a,b){var c={};return c.vals={},c.httpGetConfig=function(){b.get("configFiles/defaultConfig.json").success(function(b){c.setVals(b),a.$broadcast("configLoaded",b)}).error(function(a,b,c,d){console.log("################ERR"),console.log(b),console.log(c),console.log(d)})},c.setVals=function(a){$.isEmptyObject(c.vals)?c.vals=a:Object.keys(a).forEach(function(b){Object.keys(a[b]).forEach(function(d){void 0!==c.vals[b][d]?c.vals[b][d]=a[b][d]:console.error("BAD ENTRY IN CONFIG")})})},c}]),angular.module("emulvcApp").controller("MainCtrl",["$scope","$modal","$log","$compile","$timeout","$window","$document","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","Tierdataservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){a.cps=l,a.hists=i,a.fontImage=m,a.tds=o,a.vs=h,a.dials=p,a.connectBtnLabel="connect",a.tmp={},a.tmp.showSaveCommStaBtnDiv=!1,a.showDropZone=!1,a.dbLoaded=!1,a.lastkeycode="N/A",a.uttList=[],a.showDropZone=!0,a.curUserName="",a.curUtt={},a.modifiedCurTierItems=!1,a.modifiedCurSSFF=!1,a.modifiedMetaData=!1,a.lastclickedutt=null,a.shortcut=null,a.filterText="",a.windowWidth=f.outerWidth,angular.element(f).bind("resize",function(){a.refreshTimeline(),$("#HandletiersCtrl").scope().deleteEditArea(),a.windowWidth=f.outerWidth,a.$apply("windowWidth")}),angular.element(f).bind("keyup",function(a){(a.keyCode===l.vals.keyMappings.shift||a.keyCode===l.vals.keyMappings.alt)&&i.addCurChangeObjToUndoStack()}),l.httpGetConfig(),a.hists.init(),$(".TimelineCtrl").ownResize(".resizer"),a.$on("configLoaded",function(){a.handleConfigLoaded()}),a.$on("connectedToWSserver",function(){a.showDropZone=!1,l.vals.main.comMode="ws",a.showSaveCommStaBtnDiv=!0,j.getProtocol().then(function(b){"emuLVC-websocket-protocol"===b.protocol&&"0.0.1"===b.version&&(j.getConfigFile().then(function(a){l.setVals(a)}),l.vals.main.autoConnect?(a.connectBtnLabel="disconnect",a.$broadcast("newUserLoggedOn","")):j.getDoUserManagement().then(function(b){"YES"===b?p.open("views/login.html","LoginCtrl"):a.$broadcast("newUserLoggedOn","")}))})}),a.$on("newUserLoggedOn",function(b,c){a.curUserName=c,h.setState("loadingSaving"),j.getUsrUttList(c).then(function(b){j.getUtt(b[0]).then(function(c){console.log(c),h.setState("labeling"),a.curUtt=b[0],$("#FileCtrl").scope().hideDropZone(),h.getsubmenuOpen()||a.openSubmenu(),a.uttList=b,a.curUtt=b[0]})})}),a.$on("saveSSFFb4load",function(){console.log("saving utt"),j.wsH.saveSSFFfile(a.curUserName,n.data[0]),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),j.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.$on("discardSSFFb4load",function(){console.log("discarding ssff changes"),a.modifiedCurSSFF=!1,a.$broadcast("loadingNewUtt"),console.log(a.lastclickedutt),j.wsH.getUtt(a.curUserName,a.lastclickedutt),a.curUtt=a.lastclickedutt}),a.handleConfigLoaded=function(){h.getsubmenuOpen()||a.openSubmenu(),a.shortcut=Object.create(l.vals.keyMappings);for(var b in a.shortcut)8===a.shortcut[b]?a.shortcut[b]="BACKSPACE":9===a.shortcut[b]?a.shortcut[b]="TAB":13===a.shortcut[b]?a.shortcut[b]="ENTER":16===a.shortcut[b]?a.shortcut[b]="SHIFT":18===a.shortcut[b]?a.shortcut[b]="ALT":27===a.shortcut[b]?a.shortcut[b]="ESC":32===a.shortcut[b]?a.shortcut[b]="SPACE":-1===a.shortcut[b]?a.shortcut[b]="NONE":38===a.shortcut[b]?a.shortcut[b]="ARROW UP":40===a.shortcut[b]?a.shortcut[b]="ARROW DOWN":187===a.shortcut[b]?a.shortcut[b]="+":189===a.shortcut[b]?a.shortcut[b]="-":a.shortcut[b.toString()]=String.fromCharCode(a.shortcut[b]);l.vals.main.autoConnect&&j.wsH.initConnect(l.vals.main.wsServerUrl).then(function(a){"error"===a.type&&p.open("views/error.html","ErrormodalCtrl","Could not connect to websocket server...")}),h.setspectroSettings(l.vals.spectrogramSettings.N,l.vals.spectrogramSettings.rangeFrom,l.vals.spectrogramSettings.rangeTo,l.vals.spectrogramSettings.dynamicRange,l.vals.spectrogramSettings.window),$(".TimelineCtrl").css("height",l.vals.colors.timelineHeight),$(".HandletiersCtrl").css("padding-top",$(".TimelineCtrl").height()+2*$(".menu").height()+"px");var c=l.vals.colors.transitionTime/1e3,d={"-webkit-transition":"width "+c+"s ease-in-out, left "+c+"s ease-in-out","-moz-transition":"width "+c+"s ease-in-out, left "+c+"s ease-in-out","-ms-transition":"width "+c+"s ease-in-out, left "+c+"s ease-in-out","-o-transition":"width "+c+"s ease-in-out, left "+c+"s ease-in-out",transition:"width "+c+"s ease-in-out, left "+c+"s ease-in-out"};$(".menu").css(d),$(".HandletiersCtrl").css(d),$(".OsciDiv").css(d),$(".SpectroDiv").css(d),$(".menu-bottom").css(d),$(".cbp-spmenu").css(d),$(".cbp-spmenu-push").css(d),$(".cbp-spmenu-push-toleft").css(d),$(".cbp-spmenu-push-toright").css(d),l.vals.restrictions.sortLabels,$("#"+l.vals.signalsCanvasConfig.order[1]).insertBefore("#"+l.vals.signalsCanvasConfig.order[0]),$("#"+l.vals.signalsCanvasConfig.order[0]).insertBefore("#"+l.vals.signalsCanvasConfig.order[1])},a.downloadTextGrid=function(){console.log(j.toTextGrid())},a.refreshTimeline=function(){a.$broadcast("refreshTimeline")},a.refreshScope=function(){a.$digest()},a.getShortCut=function(b){return null!==a.shortcut?null!==a.shortcut[b]?""!==a.shortcut[b]?a.shortcut[b]:"NONE":"NONE":"NOT SET"},a.menuUttClick=function(b){a.modifiedCurSSFF||a.modifiedCurTierItems?(a.lastclickedutt=b,a.openModal("views/saveChanges.html","dialog","Changes not Saved Warning",!0,"Changes made to: "+b.name+". Do you wish to save them?")):b!==a.curUtt&&(a.$broadcast("loadingNewUtt"),j.getUtt(b).then(function(c){console.log(c),a.curUtt=b}))},a.menuUttSave=function(){j.saveUtt(a.curUtt).then(function(b){console.log(b),a.modifiedCurSSFF=!1,a.modifTierItems=!1})},a.dragStart=function(){h.setdragBarActive(!0)},a.dragEnd=function(){h.setdragBarActive(!1)},a.openModal=function(a,b,c){var d=!0;c&&(d="static"),h.setmodalOpen(!0),alert("should use new dialogService")},a.uttIsDisabled=function(b){return b.name===a.curUtt.name?!1:!0},a.getUttColor=function(b){var c;return c=i.getNrOfPosibleUndos()>0?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curUtt.name?c:void 0},a.getMetaBtnColor=function(){var b;return b=a.modifiedMetaData?{color:"red"}:{color:"rgb(128,230,25)"}},a.cursorInTextField=function(){h.focusInTextField=!0},a.cursorOutOfTextField=function(){h.focusInTextField=!1},a.openSubmenu=function(){h.getsubmenuOpen()?(h.setsubmenuOpen(!1),$("#FileCtrl").removeClass("cbp-spmenu-open"),$("#TimelineCtrl").removeClass("cbp-spmenu-push-toright").addClass("cbp-spmenu-push-toleft"),$("#HandletiersCtrl").removeClass("cbp-spmenu-push-toright").addClass("cbp-spmenu-push-toleft"),$("#menu").removeClass("cbp-spmenu-push-toright"),$("#menu-bottom").removeClass("cbp-spmenu-push-toright")):(h.setsubmenuOpen(!0),$("#FileCtrl").addClass("cbp-spmenu-open"),$("#TimelineCtrl").removeClass("cbp-spmenu-push-toleft").addClass("cbp-spmenu-push-toright"),$("#HandletiersCtrl").removeClass("cbp-spmenu-push-toleft").addClass("cbp-spmenu-push-toright"),$("#menu").addClass("cbp-spmenu-push-toright"),$("#menu-bottom").addClass("cbp-spmenu-push-toright")),e(a.refreshTimeline,l.vals.colors.transitionTime)},a.addTierSegBtnClick=function(){h.getPermission("addTierSegBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.addTierPointBtnClick=function(){h.getPermission("addTierPointBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.renameSelTierBtnClick=function(){h.getPermission("renameSelTierBtnClick")?void 0!==h.getcurClickTierName()?a.openModal("views/renameTier.html","dialog",!0):a.openModal("views/error.html","dialog","Rename Error",!1,"Please choose a Tier first !"):console.log("action currently not allowed")},a.downloadTextGridBtnClick=function(){h.getPermission("downloadTextGridBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.spectSettingsBtnClick=function(){h.getPermission("spectSettingsChange")?p.open("views/spectroSettings.html","SpectsettingsCtrl"):console.log("action currently not allowed")},a.connectBtnClick=function(){h.getPermission("connectBtnClick")?p.open("views/connectModal.html","WsconnectionCtrl"):console.log("action currently not allowed")},a.openDemoDBbtnClick=function(){h.getPermission("openDemoBtnDBclick")?(l.vals.main.comMode="http:GET",h.setState("loadingSaving"),j.getUttList("testData/demoUttList.json").then(function(b){console.log(b.data),$("#FileCtrl").scope().hideDropZone(),a.uttList=b.data,j.getUtt(b.data[0]),a.curUtt=b.data[0],h.setState("labeling")})):console.log("action currently not allowed")},a.aboutBtnClick=function(){p.open("views/about.html","AboutCtrl")},a.clearBtnClick=function(){console.log("trying to clear labeller"),p.open("views/confirmModal.html","ConfirmmodalCtrl","Do you wish to clear all loaded data? This will also delete any unsaved changes...").then(function(b){b&&(j.wsH.isConnected()&&j.wsH.closeConnect(),a.uttList=[],l.httpGetConfig(),k.wavJSO={},o.data={},n.data=[],$("#FileCtrl").scope().showDropZone(),a.$broadcast("refreshTimeline"),h.setState("noDBorFilesloaded"))})},a.cmdZoomAll=function(){h.getPermission("zoom")?($("#HandletiersCtrl").scope().deleteEditArea(),h.setViewPort(0,h.curViewPort.bufferLength)):console.log("action currently not allowed")},a.cmdZoomIn=function(){h.getPermission("zoom")?($("#HandletiersCtrl").scope().deleteEditArea(),h.zoomViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomOut=function(){h.getPermission("zoom")?($("#HandletiersCtrl").scope().deleteEditArea(),h.zoomViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomLeft=function(){h.getPermission("zoom")?($("#HandletiersCtrl").scope().deleteEditArea(),h.shiftViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomRight=function(){h.getPermission("zoom")?($("#HandletiersCtrl").scope().deleteEditArea(),h.shiftViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomSel=function(){h.getPermission("zoom")?($("#HandletiersCtrl").scope().deleteEditArea(),h.setViewPort(h.curViewPort.selectS,h.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayView=function(){h.getPermission("playaudio")?(k.playFromTo(h.curViewPort.sS,h.curViewPort.eS),h.animatePlayHead(h.curViewPort.sS,h.curViewPort.eS)):console.log("action currently not allowed")},a.cmdPlaySel=function(){h.getPermission("playaudio")?(k.playFromTo(h.curViewPort.selectS,h.curViewPort.selectE),h.animatePlayHead(h.curViewPort.selectS,h.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayAll=function(){h.getPermission("playaudio")?(k.playFromTo(0,k.wavJSO.Data.length),h.animatePlayHead(0,k.wavJSO.Data.length)):console.log("action currently not allowed")},a.saveMetaData=function(){j.wsH.saveUsrUttList(a.curUserName,a.uttList),a.modifiedMetaData=!1},a.openFile=function(){alert("code to open file")},a.setlastkeycode=function(b){a.lastkeycode=b}}]),angular.module("emulvcApp").controller("FileCtrl",["$scope","viewState","Iohandlerservice","Soundhandlerservice","ConfigProviderService",function(a){function b(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){a.dropText=e,a.dropClass=""})}function c(a,b){if(b=b||"",a.isFile)a.file(function(a){a.name.substr(a.name.lastIndexOf(".")+1).toUpperCase()});else if(a.isDirectory){var d=a.createReader();d.readEntries(function(d){for(var e=0;e<d.length;e++)c(d[e],b+a.name+"/")})}}var d=document.getElementById("dropzone"),e="Drop your files here or click here to open a file",f="File is not allowed",g="Parsing started";a.dropText=e,a.hideDropZone=function(){a.dropClass="hidden"},a.showDropZone=function(){a.dropClass=""},d.addEventListener("dragenter",b,!1),d.addEventListener("dragleave",b,!1),d.addEventListener("dragover",function(b){b.stopPropagation(),b.preventDefault();var c=b.dataTransfer&&b.dataTransfer.types&&b.dataTransfer.types.indexOf("Files")>=0;a.$apply(function(){a.dropText=c?e:f,a.dropClass=c?"over":"not-available"})},!1),d.addEventListener("drop",function(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){a.dropText=g,a.dropClass=""});for(var d=b.dataTransfer.items,e=0;e<d.length;e++){var f=d[e].webkitGetAsEntry();f&&c(f)}},!1)}]),angular.module("emulvcApp").directive("tier",function(){return{templateUrl:"views/tier.html",restrict:"E",link:function(a,b){function c(b,c,d){if(!$.isEmptyObject(b)&&!$.isEmptyObject(c)&&!$.isEmptyObject(d)){var f=e[0].getContext("2d");f.clearRect(0,0,e[0].width,e[0].height);var g,h,i,j;g=c.getSampleDist(e[0].width),j=a.fontImage.getTextImageTwoLines(f,b.TierName,"("+b.type+")",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor,!1),f.drawImage(j,0,0,j.width,j.height,5,0,j.width,j.height);var k=c.getcurMouseSegmentId(),l=(c.getcurClickSegments(),c.getcurClickTierName(),-1);if("seg"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var m=b.events;m.forEach(function(b){if(++l,b.startSample>=c.curViewPort.sS&&b.startSample<=c.curViewPort.eS||b.startSample+b.sampleDur>c.curViewPort.sS&&b.startSample+b.sampleDur<c.curViewPort.eS||b.startSample<c.curViewPort.sS&&b.startSample+b.sampleDur>c.curViewPort.eS){h=c.getPos(e[0].width,b.startSample),i=c.getPos(e[0].width,b.startSample+b.sampleDur),f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(h,0,2,e[0].height/2),f.fillStyle=d.vals.colors.endBoundaryColor,f.fillRect(i,e[0].height/2,2,e[0].height),j=a.fontImage.getTextImage(f,b.label,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor);var g=a.fontImage.getLastImageWidth(),k=h+(i-h)/2-g/2;i-h>g&&f.drawImage(j,0,0,j.width,j.height,k,e[0].height/2-d.vals.font.fontPxSize,j.width,j.height);var m=a.fontImage.getTextImage(f,b.startSample,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),n=a.fontImage.getLastImageWidth(),o=h+(i-h)/2-n/2,p=a.fontImage.getTextImage(f,"dur: "+b.sampleDur,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.endBoundaryColor),q=a.fontImage.getLastImageWidth();f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(h,e[0].height/4),f.lineTo(o+n/2,e[0].height/4),f.lineTo(o+n/2,e[0].height/4+10),f.stroke(),f.strokeStyle=d.vals.colors.endBoundaryColor,f.beginPath(),f.moveTo(i,e[0].height/4*3),f.lineTo(o+n/2,e[0].height/4*3),f.lineTo(o+n/2,e[0].height/4*3-10),f.stroke(),g>=i-h&&(f.strokeStyle=d.vals.colors.startBoundaryColor,f.beginPath(),f.moveTo(o+n/2,e[0].height/4+10),f.lineTo(o+n/2,e[0].height/4+30),f.stroke()),i-h>n&&f.drawImage(m,0,0,j.width,j.height,h+3,0,j.width,j.height),i-h>q&&f.drawImage(p,0,0,j.width,j.height,i-q,e[0].height/4*3-5,j.width,j.height)}})}else if("point"===b.type){f.fillStyle=d.vals.colors.startBoundaryColor;var n;b.events.forEach(function(h){h.startSample>c.curViewPort.sS&&h.startSample<c.curViewPort.eS&&(n=Math.round(c.getPos(e[0].width,h.startSample)+g/2),b.TierName===c.curMouseMoveTierName&&k===c.curMouseMoveSegmentName||(f.fillStyle=d.vals.colors.startBoundaryColor,f.fillRect(n,0,1,e[0].height/2-e[0].height/10),f.fillRect(n,e[0].height/2+e[0].height/10,1,e[0].height/2-e[0].height/10),j=a.fontImage.getTextImage(f,h.label,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.labelColor),f.drawImage(j,0,0,j.width,j.height,n-5,e[0].height/3,j.width,j.height)),j=a.fontImage.getTextImage(f,h.startSample,d.vals.font.fontPxSize-2,d.vals.font.fontType,d.vals.colors.startBoundaryColor),f.drawImage(j,0,0,j.width,j.height,n+5,0,j.width,j.height))})}}}function d(b,c,d){var f=e[1].getContext("2d");f.clearRect(0,0,e[1].width,e[1].height),b.TierName===c.curClickTierName&&(f.fillStyle=d.vals.colors.selectedTierColor,f.fillRect(0,0,e[0].width,e[0].height)),a.dhs.drawMovingBoundaryLine(f),a.dhs.drawCurViewPortSelected(f);var g,h,i,j,k;g=c.getPos(e[1].width,c.curViewPort.selectS),h=c.getPos(e[1].width,c.curViewPort.selectE),i=c.getSampleDist(e[1].width);var l=c.getcurMouseSegmentId(),m=c.getcurClickSegments(),n=c.getcurClickTierName();void 0!==m&&b.TierName===n&&m.length>0&&m.forEach(function(a){void 0!==a&&(g=Math.round(c.getPos(e[0].width,a.startSample)),h=Math.round(c.getPos(e[0].width,a.startSample+a.sampleDur)),f.fillStyle=d.vals.colors.selectedSegmentColor,f.fillRect(g,0,h-g,e[0].height),f.fillStyle=d.vals.colors.startBoundaryColor)}),k=b.events[l],void 0!==k&&void 0!==l&&b.TierName===c.getcurMouseTierName()&&(g=Math.round(c.getPos(e[1].width,k.startSample)),h=Math.round(c.getPos(e[1].width,k.startSample+k.sampleDur+1)),f.fillStyle=d.vals.colors.selectedBoundaryColor,"seg"===c.getcurMouseTierType()?f.fillRect(g,0,3,e[1].height):(j=i/2,f.fillRect(g+j,0,3,e[1].height)),f.fillStyle=d.vals.colors.startBoundaryColor)}var e=b.find("canvas");a.$watch("tierDetails.data",function(){c(a.tier,a.vs,a.config)},!0),a.$watch("vs",function(){c(a.tier,a.vs,a.config),d(a.tier,a.vs,a.config)},!0),b.bind("mouseleave",function(){a.vs.setcurMouseSegmentId(void 0),d(a.tier,a.vs,a.config)}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.tier)||$.isEmptyObject(a.vs)||c(a.tier,a.vs,a.config)}),a.updateView=function(){c(a.tier,a.vs,a.config)}}}}),angular.module("emulvcApp").directive("osci",function(){return{templateUrl:"views/osci.html",restrict:"E",link:function(a,b){function c(a,b){var c=a.vs,d=i.getContext("2d");d.clearRect(0,0,h.width,h.height);var e=c.getPos(i.width,c.playHeadAnimationInfos.sS),g=c.getPos(i.width,c.playHeadAnimationInfos.curS);d.fillStyle=a.config.vals.colors.selectedAreaColor,d.fillRect(e,0,g-e,h.height),f(a,b,!1)}function d(a,b,c){return a.measureText(b).width*c}function e(a,b,c,e){return b.toString().length>c.toString().length?d(a,b,e):d(a,c,e)}function f(a,b,c){var d=a.vs,f=i.getContext("2d");c&&f.clearRect(0,0,i.width,i.height);var g;g=d.getSampleDist(i.width),a.dhs.drawMovingBoundaryLine(f),a.dhs.drawCurViewPortSelected(f,!0),f.strokeStyle=b.vals.colors.labelColor,f.fillStyle=b.vals.colors.labelColor,f.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,f.beginPath(),f.moveTo(0,0),f.lineTo(5,5),f.moveTo(i.width,0),f.lineTo(i.width-5,5),f.closePath(),f.stroke();var h,j,k,l,m=f.canvas.width/f.canvas.offsetWidth;d.curViewPort&&(h=d.round(d.curViewPort.sS/a.shs.wavJSO.SampleRate,6),j=d.round(d.curViewPort.eS/a.shs.wavJSO.SampleRate,6),k=a.fontImage.getTextImageTwoLines(f,d.curViewPort.sS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),f.drawImage(k,0,0,k.width,k.height,5,0,k.width,k.height),l=e(f,d.curViewPort.eS,j,m),k=a.fontImage.getTextImageTwoLines(f,d.curViewPort.eS,j,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),f.drawImage(k,0,0,k.width,k.height,i.width-l-5,0,k.width,k.height))}var g=b.find("canvas").length,h=b.find("canvas")[0],i=b.find("canvas")[g-1];a.$watch("vs.playHeadAnimationInfos",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c(a,a.config)},!0),a.$watch("tds.data",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||f(a,a.config,!0)},!0),a.$on("refreshTimeline",function(){if(!$.isEmptyObject(a.shs))if($.isEmptyObject(a.shs.wavJSO)){var b=h.getContext("2d");b.clearRect(0,0,h.width,h.height),b=i.getContext("2d"),b.clearRect(0,0,i.width,i.height)}else f(a,a.config,!0)}),a.$watch("vs.curViewPort",function(b,c){if(!$.isEmptyObject(a.shs)&&!$.isEmptyObject(a.shs.wavJSO)){if(c.sS!==b.sS||c.sE!==b.sE||-1===b.selectS){var d=a.dhs.calculatePeaks(a.vs,h,a.shs.wavJSO.Data);a.dhs.osciPeaks=d,a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,h,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config)}f(a,a.config,!0)}},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0===a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1===a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2===a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"})),f(a,a.config,!0)}},!0)}}}),angular.module("emulvcApp").directive("preview",function(){return{templateUrl:"views/preview.html",restrict:"E",link:function(a,b){function c(){f?d(a.vs,e,a.config,g):(a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,e,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.config),g.src=e.toDataURL("image/png"),f=!0,d(a.vs,e,a.config,g))}function d(b,c,d,e){var f=c.getContext("2d"),g=new Image,h=c.width/a.shs.wavJSO.Data.length*b.curViewPort.sS,i=c.width/a.shs.wavJSO.Data.length*b.curViewPort.eS;g.onload=function(){f.clearRect(0,0,c.width,c.height),f.drawImage(g,0,0),f.fillStyle=d.vals.colors.selectedAreaColor,f.fillRect(h,0,i-h,c.height),f.strokeStyle=d.vals.colors.selectedBorderColor,f.beginPath(),f.moveTo(h,0),f.lineTo(h,c.height),f.moveTo(i,0),f.lineTo(i,c.height),f.closePath(),f.stroke()},g.src=e.src}var e=b.find("canvas")[0],f=!1,g=new Image;a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$on("cleanPreview",function(){f=!1})}}}),angular.module("emulvcApp").directive("spectro",["$q",function(){return{templateUrl:"views/spectro.html",restrict:"E",link:function(a,b){function c(){t=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width),u=f(a.vs.curViewPort.sS,a.vs.curViewPort.eS,t),null!==u?(s.clearRect(0,0,p.width,p.height),h(u),g()):k(a.vs,a.shs.wavJSO.Data)}function d(){y=null,z=0,y=[]}function e(a,b,c,d){y[z]=[],y[z][0]=a,y[z][1]=b,y[z][2]=c,y[z][3]=d,++z}function f(a,b,c){for(var d=0;d<y.length;++d)if(y[d][0]===a&&y[d][1]===b&&y[d][2]===c)return d;return null}function g(){a.dhs.drawMovingBoundaryLine(s),a.dhs.drawCurViewPortSelected(s,!1)}function h(a){var b=r.createImageData(o.width,o.height);b.data.set(y[a][3]),r.putImageData(b,0,0)}function i(){r.fillStyle="#222",r.fillRect(0,0,o.width,o.height),r.font=a.config.vals.font.fontPxSize+"px "+a.config.vals.font.fontType,r.fillStyle="#333",r.fillText("loading...",10,25),null!==x&&(x.terminate(),x=null)}function j(){t=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/o.width);var b=r.createImageData(o.width,o.height);x.addEventListener("message",function(c){t===c.data.myStep&&(b.data.set(c.data.img),r.putImageData(b,0,0),console.log(c.data),console.log(c.data.img.length/4/o.height),e(a.vs.curViewPort.sS,a.vs.curViewPort.eS,t,c.data.img),g())})}function k(a,b){i(),l(a,b)}function l(b,c){t=Math.round((b.curViewPort.eS-b.curViewPort.sS)/o.width),x=new Worker(w);var d=c.subarray(b.curViewPort.sS,b.curViewPort.eS+3*t*b.spectroSettings.windowLength),e=new Float32Array(d);j(),x.postMessage({cmd:"config",N:b.spectroSettings.windowLength}),x.postMessage({cmd:"config",alpha:q}),x.postMessage({cmd:"config",freq:b.spectroSettings.rangeTo}),x.postMessage({cmd:"config",freqLow:b.spectroSettings.rangeFrom}),x.postMessage({cmd:"config",start:Math.round(b.curViewPort.sS)}),x.postMessage({cmd:"config",end:Math.round(b.curViewPort.eS)}),x.postMessage({cmd:"config",myStep:t}),x.postMessage({cmd:"config",window:b.spectroSettings.window}),x.postMessage({cmd:"config",width:o.width}),x.postMessage({cmd:"config",height:o.height}),x.postMessage({cmd:"config",dynRangeInDB:b.spectroSettings.dynamicRange}),x.postMessage({cmd:"config",pixelRatio:v}),x.postMessage({cmd:"config",sampleRate:a.shs.wavJSO.SampleRate}),x.postMessage({cmd:"config",streamChannels:a.shs.wavJSO.NumChannels}),x.postMessage({cmd:"pcm",stream:e}),x.postMessage({cmd:"render"})}function m(b,c,d,e,f){if(d.vals.restrictions.drawCrossHairs){s.clearRect(0,0,c.width,c.height),s.strokeStyle=d.vals.colors.crossHairsColor,s.fillStyle=d.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&s.setLineDash([2]);var h=e.getX(f),i=e.getY(f);s.beginPath(),s.moveTo(0,i),s.lineTo(5,i+5),s.moveTo(0,i),s.lineTo(c.width,i),s.lineTo(c.width-5,i+5),s.moveTo(h,0),s.lineTo(h,c.height),s.stroke(),s.font=d.vals.font.fontPxSize+"px "+d.vals.font.fontType;var j=b.round(b.spectroSettings.rangeTo-i/c.height*b.spectroSettings.rangeTo,2),k=s.measureText(j+" Hz").width,l=Math.round(b.curViewPort.sS+h/c.width*(b.curViewPort.eS-b.curViewPort.sS)),m=b.round(b.getViewPortStartTime()+h/c.width*(b.getViewPortEndTime()-b.getViewPortStartTime()),6),n=a.fontImage.getTextImage(r,j+" Hz",d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!0),o=a.fontImage.getTextImageTwoLines(r,l,m,d.vals.font.fontPxSize,d.vals.font.fontType,d.vals.colors.crossHairsColor,!1);s.drawImage(n,0,0,n.width,n.height,5,i,n.width,n.height),s.drawImage(n,0,0,n.width,n.height,c.width-5-k*(r.canvas.width/r.canvas.offsetWidth),i,n.width,n.height),s.drawImage(o,0,0,o.width,o.height,h+5,0,o.width,o.height),"Google Inc."===navigator.vendor&&s.setLineDash([0]),g()}}var n=b.find("canvas").length,o=b.find("canvas")[0],p=b.find("canvas")[n-1],q=.16,r=o.getContext("2d"),s=p.getContext("2d"),t=0;window.URL=window.URL||window.webkitURL;var u,v=window.devicePixelRatio||1,w="scripts/workers/spectroWorker.js",x=new Worker(w),y=null,z=0;b.bind("mousemove",function(b){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(g(),m(a.vs,o,a.config,a.dhs,b))}),b.bind("mouseleave",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(s.clearRect(0,0,p.width,p.height),g())}),a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("tds.data",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$on("newlyLoadedAudioFile",function(){console.log("clearing spectro image cache..."),d()}),a.$on("refreshTimeline",function(){$.isEmptyObject(a.shs)||($.isEmptyObject(a.shs.wavJSO)?(r.clearRect(0,0,o.width,o.height),s.clearRect(0,0,p.width,p.height)):c())}),a.$watch("vs.spectroSettings",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(j(),d(),k(a.vs,a.shs.wavJSO.Data))},!0),a.$watch("vs.scrollOpen",function(){if(!$.isEmptyObject(a.config)&&!$.isEmptyObject(a.config.vals)){var b=10*a.config.vals.main.osciSpectroZoomFactor,c=100-10*a.config.vals.main.osciSpectroZoomFactor;0===a.vs.scrollOpen?($(".OsciDiv").css({height:"50%"}),$(".OsciDiv canvas").css({height:"48%"}),$(".SpectroDiv").css({height:"50%"}),$(".SpectroDiv canvas").css({height:"48%"})):1===a.vs.scrollOpen?($(".OsciDiv").css({height:b+"%"}),$(".OsciDiv canvas").css({height:b+"%"}),$(".SpectroDiv").css({height:c+"%"}),$(".SpectroDiv canvas").css({height:c+"%"})):2===a.vs.scrollOpen&&($(".OsciDiv").css({height:c+"%"}),$(".OsciDiv canvas").css({height:c+"%"}),$(".SpectroDiv").css({height:b+"%"}),$(".SpectroDiv canvas").css({height:b+"%"}))}},!0),d()}}}]),angular.module("emulvcApp").controller("HandletiersCtrl",["$scope","$http","$injector","viewState","HistoryService","ConfigProviderService","Soundhandlerservice","Tierdataservice","fontScaleService","Drawhelperservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k){a.vs=d,a.hists=e,a.fontImage=i,a.shs=g,a.config=f,a.dhs=j,a.testValue="",a.message="",a.tierDetails=h,a.sortableOptions={update:function(){!f.vals.restrictions.sortLabels},start:function(){a.deleteEditArea()},create:function(){},axis:"y",placeholder:"tierPlaceholder"},a.$on("newlyLoadedLabelJson",function(b,c){$.isEmptyObject(a.tierDetails.data)?a.tierDetails.data=c:(c.tiers.forEach(function(b){a.tierDetails.data.tiers.push(b)}),c.fileInfos.forEach(function(b){a.tierDetails.data.fileInfos.push(b)})),a.sortTiers()}),a.$on("loadingNewUtt",function(){a.tierDetails.data={}}),a.sortTiers=function(){var b,c=[],d=[];f.vals.labelCanvasConfig.order.forEach(function(e){b=e.split(".")[1],a.tierDetails.data.tiers.forEach(function(e,f){e.TierName.split("_")[1]===b&&(c.push(e),d.push(a.tierDetails.data.fileInfos[f]))})}),a.tierDetails.data.tiers=c,a.tierDetails.data.fileInfos=d},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.getTierLength=function(){return a.tierDetails.data.tiers.length},a.getTier=function(b){var c;return angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===b&&(c=a)}),c},a.renameLabel=function(){d.isEditing()?(console.log(d.getcurClickSegments()[0].label),console.log($("."+d.getlasteditArea()).val()),e.addObjToUndoStack({type:"ESPS",action:"renameLabel",tierName:d.getcurClickTierName(),itemIdx:d.getlastID(),oldValue:d.getcurClickSegments()[0].label,newValue:$("."+d.getlasteditArea()).val()}),a.rename(d.getcurClickTierName(),d.getlastID(),$("."+d.getlasteditArea()).val()),d.deleteEditArea(),d.focusInTextField=!1):0===d.countSelected()?alert("please select a segement first!"):(d.setEditing(!0),d.openEditArea())},a.deleteEditArea=function(){d.deleteEditArea()},a.selectTier=function(b){var c;d.isEditing()&&(a.renameLabel(),d.deleteEditArea());var e=d.getcurClickTierName();void 0===e?d.setcurClickTierName($("li").children()[0].id):b?(c=$("li."+e).next().children()[0],void 0===c?d.setcurClickTierName($("li").children()[0].id):d.setcurClickTierName(c.id)):(c=$("li."+e).prev().children()[0],void 0===c?d.setcurClickTierName($("li").children()[0].id):d.setcurClickTierName(c.id))},a.tabNext=function(b){d.isEditing()&&(a.renameLabel(),d.deleteEditArea());var c=parseInt(d.getselected()[0],10);b?c>1&&--c:c<d.getTierLength()-1&&++c,1>c&&(c=d.getTierLength()-1),angular.forEach(a.tierDetails.data.tiers,function(a){var b=0;a.TierName===d.getcurClickTierName()&&angular.forEach(a.events,function(a){b===c&&(d.setcurClickSegment(a,c),d.setlasteditArea("_"+c)),++b})})},a.snapBoundary=function(b){var c,e,f=d.getcurMouseSegment().startSample,g=d.getcurMouseTierDetails();a.tierDetails.data.tiers.forEach(function(d,f){d.TierName===g.TierName&&(f>=1&&b?(c=a.tierDetails.data.tiers[f-1],e=f-1):f<a.tierDetails.data.tiers.length-1&&!b&&(c=a.tierDetails.data.tiers[f+1],e=f+1))});var h,i,j=1/0;void 0!==c&&(c.events.forEach(function(a){h=Math.abs(f-a.startSample),j>h&&(j=h,i=a.startSample-f)}),this.moveBorder(i,g)),a.hists.addObjToUndoStack({type:"ESPS",action:"moveBoundary",tierName:g.TierName,itemIdx:d.getcurMouseSegmentId(),movedBy:i})},a.expandSegment=function(b,c,e,g){if(void 0===d.getcurClickTierName())k.open("views/error.html","ErrormodalCtrl","Expand Segments Error: Please select a Tier first");else if(0===d.getselected().length)k.open("views/error.html","ErrormodalCtrl","Expand Segments Error: Please select one or more Segments first");else{var h=0;"absolute"===f.vals.labelCanvasConfig.addTimeMode?h=parseInt(f.vals.labelCanvasConfig.addTimeValue,10):"relative"===f.vals.labelCanvasConfig.addTimeMode?h=f.vals.labelCanvasConfig.addTimeValue*(d.curViewPort.bufferLength/100):k.open("views/error.html","ErrormodalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)"),b||(h=0-h);var i;i=void 0===e?d.getselected().sort():e;var j;j=void 0===g?d.getcurClickTierName():g;var l,m=0;c?angular.forEach(a.tierDetails.data.tiers,function(a){if(a.TierName===j)if(a.events[i[i.length-1]+1].sampleDur>i.length*h)if(a.events[i[0]].sampleDur>-(i.length*h)){var b=!1;for(l=1;l<=i.length;l++)a.events[i[l-1]].sampleDur+h<=0&&(b=!0);if(b)k.open("views/error.html","ErrormodalCtrl","Expand Segements Error: Cannot Expand/Shrink. Segment would be too small");
else{for(l=1;l<=i.length;l++)a.events[i[l-1]].startSample+=m,a.events[i[l-1]].sampleDur+=h,m=l*h;a.events[i[i.length-1]+1].startSample+=m,a.events[i[i.length-1]+1].sampleDur-=m}}else k.open("views/error.html","ErrormodalCtrl","Expand Segements Error: No Space left to decrease");else k.open("views/error.html","ErrormodalCtrl","Expand Segements Error: No Space left to increase")}):angular.forEach(a.tierDetails.data.tiers,function(b){if(b.TierName===j)if(b.events[i[0]-1].sampleDur>i.length*h)if(b.events[i[i.length-1]].sampleDur>i.length*h){var c=!1;for(l=1;l<=i.length;l++)b.events[i[l-1]].sampleDur+h<=0&&(c=!0);if(c)a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","Cannot Expand/Shrink. Segment would be too small");else{for(l=0;l<i.length;l++)b.events[i[l]].startSample-=h*(i.length-l),b.events[i[l]].sampleDur+=h;b.events[i[0]-1].sampleDur-=h*i.length}}else a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","No Space left to increase");else a.openModal("views/error.html","dialogSmall",!1,"Expand Segements Error","No Space left to decrease")})}},a.selectSegmentsInSelection=function(){if(void 0===d.getcurClickTierName())a.openModal("views/error.html","dialogSmall",!1,"Selection Error","Please select a Tier first");else{var b=d.curViewPort.selectS,c=d.curViewPort.selectE;angular.forEach(a.tierDetails.data.tiers,function(a){var e=0;a.TierName===d.getcurClickTierName()&&angular.forEach(a.events,function(a){a.startSample>=b&&a.startSample+a.sampleDur<=c&&d.setcurClickSegmentMultiple(a,e),++e})})}},a.rename=function(b,c,d){angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===b&&angular.forEach(a.events,function(a,b){c==b&&(a.label=d)})})},a.deleteTier=function(){var b=0,c=d.getcurClickTierName();angular.forEach(a.tierDetails.data.tiers,function(d){d.TierName===c&&a.tierDetails.data.tiers.splice(b,1),++b}),e.history()},a.renameTier=function(b){var c=!1;angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===b&&(c=!0)}),c?a.openModal("views/error.html","dialog",!1,"Rename Error","This Tiername already exists ! Please choose another name !"):(angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===d.getcurClickTierName()&&(a.TierName=b)}),e.history())},a.deleteSegments=function(){var b=d.getselected(),c=d.getcurClickTierName();angular.forEach(a.tierDetails.data.tiers,function(a){if(a.TierName===c){if("seg"===a.type)for(var e in b){var f=b[e];if(f>0){var g=a.events[f].sampleDur;a.events[f-1].sampleDur+=g/2,a.events[f+1].sampleDur+=g/2,a.events[f+1].startSample-=g/2,a.events.splice(f,1)}}b[0]-1>0?d.setcurClickSegment(a.events[b[0]-1],b[0]-1):d.setcurClickSegment(a.events[0],0)}})},a.deleteBoundary=function(){{var b=d.getcurMouseSegment(),c=d.getcurMouseTierName();d.getcurMouseTierType()}angular.forEach(a.tierDetails.data.tiers,function(a){a.TierName===c&&angular.forEach(a.events,function(c,d){c.startSample==b.startSample&&("point"===a.type?a.events.splice(d,1):(a.events[d-1].label+=a.events[d].label,a.events[d-1].sampleDur+=a.events[d].sampleDur,a.events.splice(d,1)),console.log(c))})})},a.getNearest=function(b,c){var d=parseFloat(a.vs.curViewPort.sS)+b,e=0,f=0;if("seg"===c.type)angular.forEach(c.events,function(a){d>=a.startSample&&d<=a.startSample+a.sampleDur&&(f=d-a.startSample>=a.sampleDur/2?e+1:e),++e});else{var g=0,h=0;angular.forEach(c.events,function(b,i){h=i<c.events.length-1?b.startSample+(c.events[i+1].startSample-c.events[i].startSample)/2:a.vs.curViewPort.bufferLength,i>0&&(g=b.startSample-(c.events[i].startSample-c.events[i-1].startSample)/2),h>=d&&d>=g&&(f=e),++e})}return f},a.getEventId=function(b,c,d){var e=parseFloat(a.vs.curViewPort.sS)+b,f=0,g=0;if("seg"===c.type)angular.forEach(c.events,function(a,b){d?e>=a.startSample&&e<=a.startSample+a.sampleDur&&(g=e-a.startSample>=a.sampleDur/2?b+1:b):e>=a.startSample&&e<=a.startSample+a.sampleDur&&(g=b)});else{var h=0,i=0;angular.forEach(c.events,function(b,d){i=d<c.events.length-1?b.startSample+(c.events[d+1].startSample-c.events[d].startSample)/2:a.vs.curViewPort.bufferLength,d>0&&(h=b.startSample-(c.events[d].startSample-c.events[d-1].startSample)/2),i>=e&&e>=h&&(g=f),++f})}return g},a.getEvent=function(b,c,d){var e=parseFloat(a.vs.curViewPort.sS)+b,f=null;if("seg"===c.type)angular.forEach(c.events,function(a,b){d?e>=a.startSample&&e<=a.startSample+a.sampleDur&&(f=e-a.startSample>=a.sampleDur/2?c.events[b+1]:c.events[b]):e>=a.startSample&&e<=a.startSample+a.sampleDur&&(f=c.events[b])});else{var g=0,h=0;angular.forEach(c.events,function(b,d){h=d<c.events.length-1?b.startSample+(c.events[d+1].startSample-c.events[d].startSample)/2:a.vs.curViewPort.bufferLength,d>0&&(g=b.startSample-(c.events[d].startSample-c.events[d-1].startSample)/2),h>=e&&e>=g&&(f=b)})}return f},a.moveBorder=function(b,c,e){if(null!==c){var f;f=void 0===e?d.getcurMouseSegmentId():e,"seg"===c.type?f>1&&c.events[f-1].sampleDur+b>=1&&c.events[f].sampleDur-b>=1&&(c.events[f-1].sampleDur+=b,c.events[f].startSample+=b,c.events[f].sampleDur-=b):f>0&&f<c.events.length-1?c.events[f].startSample+b>=c.events[f-1].startSample&&c.events[f].startSample+b<=c.events[f+1].startSample&&(c.events[f].startSample+=b):0==f?c.events[f].startSample+b>=0&&c.events[f].startSample+b<=c.events[f+1].startSample&&(c.events[f].startSample+=b):f==c.events.length-1&&c.events[f].startSample+b>=c.events[f-1].startSample&&c.events[f].startSample+b<=a.vs.curViewPort.bufferLength&&(c.events[f].startSample+=b)}},a.moveSegment=function(a,b,c){if(null!==b){var e;if(e=void 0===c?d.getselected().sort():c,b.events[e[0]-1].sampleDur+a>=1&&b.events[e[e.length-1]+1].sampleDur-a>=1){b.events[e[0]-1].sampleDur+=a;for(var f=0;f<e.length;f++)b.events[e[f]].startSample+=a;b.events[e[e.length-1]+1].startSample+=a,b.events[e[e.length-1]+1].sampleDur-=a}}}}]),angular.module("emulvcApp").controller("TimelineCtrl",["$scope","$http","$compile","viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService","Ssffdataservice","HistoryService",function(a,b,c,d,e,f,g,h,i){a.vs=d,a.shs=e,a.cps=g.vals.colors,a.config=g,a.dhs=f,a.ssffds=h,a.hists=i,a.showSSFFOsci=!1,a.showSSFFSpectro=!1,a.$on("newlyLoadedSSFFfile",function(b,c){a.ssffds.data=[],a.ssffds.data.push(c);for(var d in g.vals.signalsCanvasConfig.assign)"fms:fm"===g.vals.signalsCanvasConfig.assign[d]&&("osci"===d&&(a.showSSFFOsci=!0),"spec"===d&&(a.showSSFFSpectro=!0))}),a.$on("loadingNewUtt",function(){a.ssffds.data=[]}),a.resizeSpectro=function(){0===d.getscrollOpen()?d.setscrollOpen(1):d.setscrollOpen(0)},a.resizeOsci=function(){0===d.getscrollOpen()?d.setscrollOpen(2):d.setscrollOpen(0)}}]),angular.module("emulvcApp").controller("ModalInstanceCtrl",["$rootScope","$scope","$modalInstance","ConfigProviderService","modalTitle","modalContent","windowLength","rangeFrom","rangeTo","dynamicRange","window","currentTier","viewState","snapBoundary","keyZoomIn","keyZoomOut","keyZoomAll","keyZoomSel","shiftViewPortLeft","shiftViewPortRight","keyTab","keyShift","keyEnter","playAllInView","playSelected","playEntireFile","keyBackspace","tierUp","tierDown","snapBelow","snapAbove","snapZero","plus","minus","selectFirstContourCorrectionTool","selectSecondContourCorrectionTool","keyopenSubmenu","history","selectSegmentsInSelection","selectThirdContourCorrectionTool","selectFourthContourCorrectionTool","selectNoContourCorrectionTool","keyAlt",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q){b.cps=d,b.modalContent=f,b.modalTitle=e,b.windowLength=g,b.rangeFrom=h,b.rangeTo=i,b.dynamicRange=j,b.window=k,b.currentTier=l,b.keyZoomIn=o,b.keyZoomOut=p,b.keyZoomAll=q,b.keyZoomSel=r,b.keyTab=u,b.keyShift=v,b.keyEnter=w,b.snapBoundary=n,b.playAllInView=x,b.playEntireFile=z,b.keyBackspace=A,b.playSelected=y,b.tierUp=B,b.plus=G,b.keyAlt=Q,b.minus=H,b.history=L,b.snapBelow=D,b.snapAbove=E,b.snapZero=F,b.tierDown=C,b.selectSegmentsInSelection=M,b.openSubmenu=K,b.selectFirstContourCorrectionTool=I,b.selectSecondContourCorrectionTool=J,b.selectThirdContourCorrectionTool=N,b.selectFourthContourCorrectionTool=O,b.selectNoContourCorrectionTool=P,b.shiftViewPortLeft=s,b.shiftViewPortRight=t,b.ok=function(){m.setmodalOpen(!1),c.dismiss("cancel")},b.cancel=function(){m.setmodalOpen(!1),c.dismiss("cancel")},b.deleteSegment=function(){$("#HandletiersCtrl").scope().deleteSegments(),c.dismiss("ok")},b.cursorInTextField=function(){m.focusInTextField=!0},b.cursorOutOfTextField=function(){m.focusInTextField=!1},b.selected=function(a){return a===m.spectroSettings.window?!0:!1},b.test=function(){alert("hier")},b.deleteTier=function(a){$("#HandletiersCtrl").scope().deleteTier(a),c.dismiss("ok")},b.renameTier=function(){$("#HandletiersCtrl").scope().renameTier($("#newName").val()),c.dismiss("ok")},b.deleteBoundary=function(){$("#HandletiersCtrl").scope().deleteBoundary(),c.dismiss("ok")},b.saveSpectroSettings=function(){var a=$("#windowLength").val(),b=$("#rangeFrom").val(),d=$("#rangeTo").val(),e=$("#dynamicRange").val(),f=$("#windowFunction").val();m.setspectroSettings(a,b,d,e,f),m.setmodalOpen(!1),c.dismiss("ok")},b.saveSSFF=function(){a.$broadcast("saveSSFFb4load"),m.setmodalOpen(!1),c.dismiss("ok")},b.discardSSFF=function(){a.$broadcast("discardSSFFb4load"),m.setmodalOpen(!1),c.dismiss("ok")}}]),angular.module("emulvcApp").factory("viewState",["$rootScope","Soundhandlerservice","$window","Tierdataservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,bufferLength:-1},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null},e.selected=[],e.lasteditArea=null,e.editing=!1,e.submenuOpen=!1,e.modalOpen=!1,e.scrollOpen=0,e.curMouseTierName=void 0,e.curMouseTierType=void 0,e.curClickTierName=void 0,e.curClickTierType=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=void 0,e.start=null,e.loadingUtt=!1,e.curMouseSegmentId=void 0,e.dragBarActive=!1,e.movingBoundary=!1,e.focusInTextField=!1,e.curTaskPercCompl=0,e.states=[],e.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},e.states.loadingSaving={permittedActions:[]},e.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addTierSegBtnClick","addTierPointBtnClick","renameSelTierBtnClick","downloadTextGridBtnClick","spectSettingsChange","clearBtnClick"]},e.states.modalShowing={permittedActions:[]},e.prevState=e.states.noDBorFilesloaded,e.curState=e.states.noDBorFilesloaded,e.getPermission=function(a){return e.curState.permittedActions.indexOf(a)>-1},e.setState=function(a){e.prevState=e.curState,e.curState="string"==typeof a?e.states[a]:a},e.updatePlayHead=function(d){b.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=d);var f=Math.ceil(d-e.start)/1e3*b.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.round(e.playHeadAnimationInfos.sS+f),b.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?a.$apply():(e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.setspectroSettings=function(a,b,c,d,f){e.spectroSettings.windowLength=parseInt(a,10),e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f)},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.selectE&&(this.curViewPort.selectE=b)},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getWindowFunctions=function(){return f},e.getdragBarActive=function(){return this.dragBarActive},e.setdragBarActive=function(a){this.dragBarActive=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.getmodalOpen=function(){return this.modalOpen},e.setmodalOpen=function(a){this.modalOpen=a},e.getscrollOpen=function(){return this.scrollOpen},e.setscrollOpen=function(a){this.scrollOpen=a},e.setcurClickTierType=function(a){this.curClickTierType=a},e.getcurClickTierType=function(){return this.curClickTierType},e.setcurClickTierName=function(a){this.curClickTierName=a},e.getcurClickTierName=function(){return this.curClickTierName},e.setcurMouseTierName=function(a){this.curMouseTierName=a},e.getcurMouseTierName=function(){return this.curMouseTierName},e.setcurMouseTierType=function(a){this.curMouseTierType=a},e.getcurMouseTierType=function(){return this.curMouseTierType},e.getcurMouseTierDetails=function(){var a,b=this.getcurMouseTierName();return d.data.tiers.forEach(function(c){c.TierName===b&&(a=c)}),a},e.getTierDetails=function(a){var b;return d.data.tiers.forEach(function(c){c.TierName===a&&(b=c)}),b},e.setcurMouseSegment=function(a){this.curMouseSegment=a},e.getcurMouseSegment=function(){return this.curMouseSegment},e.setcurMouseSegmentId=function(a){this.curMouseSegmentId=a},e.getcurMouseSegmentId=function(){return this.curMouseSegmentId},e.setcurClickSegment=function(a,b){null!==a&&(this.select(a.startSample,a.startSample+a.sampleDur),this.curClickSegments=[],this.curClickSegments.push(a),this.selected=[],this.selected.push(b))},e.selectBoundry=function(){if(void 0!==this.curClickSegments){var a=this.curClickSegments[0].startSample,b=this.curClickSegments[0].startSample+this.curClickSegments[0].sampleDur;this.curClickSegments.forEach(function(c){c.startSample<=a&&(a=c.startSample),c.startSample+c.sampleDur>=b&&(b=c.startSample+c.sampleDur)}),this.select(a,b)}},e.setcurClickSegmentMultiple=function(a,b){var c=!0,d=this;this.selected.forEach(function(e){-1===d.selected.indexOf(b)&&e-1===b&&(d.selected.push(b),d.curClickSegments.push(a),c=!1),-1===d.selected.indexOf(b)&&e+1===b&&(d.selected.push(b),d.curClickSegments.push(a),c=!1)}),c&&(this.curClickSegments=[],this.curClickSegments.push(a),this.selected=[],this.selected.push(b)),this.selectBoundry()},e.getselected=function(){return this.selected},e.getcurClickSegments=function(){return this.curClickSegments},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.setlasteditArea=function(a){this.lasteditArea=a},e.getlastID=function(){return this.lasteditArea.substr(1)},e.getlasteditArea=function(){return this.lasteditArea},e.deleteEditArea=function(){null!==this.getlasteditArea()&&$("."+this.getlasteditArea()).remove(),this.editing=!1},e.countSelected=function(){return this.selected.length},e.setTierLength=function(a){this.tierLength=a},e.getTierLength=function(){return this.tierLength},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getPCMpp=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.srcElement.width},e.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},e.openEditArea=function(a,b,c){console.log(a,b);var d=$("#"+this.getcurClickTierName()).find("canvas")[0];if("seg"===c)var e=this.getPos(d.clientWidth,a.startSample)+d.offsetLeft,f=this.getPos(d.clientWidth,a.startSample+a.sampleDur)+d.offsetLeft;else var e=this.getPos(d.clientWidth,a.startSample)+d.offsetLeft-d.clientWidth/50,f=this.getPos(d.clientWidth,a.startSample)+d.offsetLeft+d.clientWidth/50;var g=d.offsetTop+1,h=d.clientHeight+1,i=this.createEditArea(this.getcurClickTierName(),e,g,f-e,h,a.label,b);return this.createSelection($("#"+i)[0],0,$("#"+i).val().length),i},e.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},e.createEditArea=function(a,b,c,d,e,f,g){var h="_"+g;return $("#"+a).prepend($("<textarea>").attr({id:h,"class":h+" Label_Edit","ng-model":"message",autofocus:"true"}).css({position:"absolute","z-index":"5",left:b+2+"px",width:d-1+"px",height:e/3*2+"px","padding-top":e/3+"px"}).text(f)),h},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.setViewPort=function(a,c){var d=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==c&&(this.curViewPort.eS=Math.round(c)),d>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),d<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.sS=d,this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=d,this.curViewPort.eS=e)},e.zoomViewPort=function(a){var b,c,d=this.getcurMouseSegmentId(),e=this.getcurMouseTierDetails(),f=this.curViewPort.eS-this.curViewPort.sS;if(e&&d){var g=e.events[d].startSample,h=g-this.curViewPort.sS,i=this.curViewPort.eS-g;a?(b=this.curViewPort.sS+.5*h,c=this.curViewPort.eS-.5*i):(b=this.curViewPort.sS-.5*h,c=this.curViewPort.eS+.5*i)}else a?(b=this.curViewPort.sS+~~(f/4),c=this.curViewPort.eS-~~(f/4)):(b=this.curViewPort.sS-~~(f/4),c=this.curViewPort.eS+~~(f/4));this.setViewPort(b,c)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e}]),angular.module("emulvcApp").directive("trackmouseintier",["ConfigProviderService","viewState",function(a,b){return{restrict:"A",link:function(c,d){function e(a){var e=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),b.deleteEditArea(),j=c.getEvent(q,c.this.tier,!1),k=c.getEventId(q,c.this.tier,!1),l=c.getEvent(q,c.this.tier,!1),m=c.getEventId(q,c.this.tier,!1),b.setlasteditArea("_"+k),b.setcurClickTierName(e),b.setcurClickTierType(c.this.tier.type),b.setcurClickSegment(j,k),b.setTierLength(c.this.tier.events.length),p=q,c.$apply()}function f(a){var f=d.parent().parent().parent()[0].id;b.getcurClickTierName()!==f&&e(a),q=i(a)*b.getPCMpp(a),b.deleteEditArea(),j=c.getEvent(q,c.this.tier,!1),k=c.getEventId(q,c.this.tier,!1),l=c.getEvent(q,c.this.tier,!1),m=c.getEventId(q,c.this.tier,!1),b.setcurClickTierName(f),b.setcurClickTierType(c.this.tier.type),b.setcurClickSegmentMultiple(j,k),b.setTierLength(c.this.tier.events.length),p=q,c.$apply()}function g(a){var e=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),j=c.getEvent(q,c.this.tier,!1),k=c.getEventId(q,c.this.tier,!1),b.setcurClickTierName(e),b.setcurClickTierType(c.this.tier.type),b.setlasteditArea("_"+k),b.setcurClickSegment(j,k),b.setEditing(!0),b.setTierLength(c.this.tier.events.length),b.openEditArea(j,k,c.this.tier.type),c.cursorInTextField(),p=q,c.$apply()}function h(a,e){var f=d.parent().parent().parent()[0].id;q=i(a)*b.getPCMpp(a),n=c.getEvent(q,c.this.tier,!0),o=c.getNearest(q,c.this.tier,!0),b.setcurMouseTierName(f),e&&(b.setcurMouseSegment(n),b.setcurMouseSegmentId(o)),b.setcurMouseTierName(f),b.setcurMouseTierType(c.this.tier.type),p=q,c.$apply()}function i(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var j,k,l,m,n,o,p,q;d.bind("click",function(a){h(a,!0),e(a)}),d.bind("contextmenu",function(a){a.preventDefault(),h(a,!0),f(a)}),d.bind("dblclick",function(b){h(b,!0),a.vals.restrictions.editItemName&&g(b)}),d.bind("mousemove",function(d){var e=!0;q=i(d)*b.getPCMpp(d);var f=0;switch(b.getPCMpp(d)<=1?f=Math.round((q-p)*b.getPCMpp(d)):b.getPCMpp(d)<=.5&&(f=Math.round(2*(q-p)*b.getPCMpp(d))),f=b.getPCMpp(d)<=.1?Math.round(10*(q-p)*b.getPCMpp(d)):Math.round(q-p),d.which){case 1:break;case 2:break;case 3:break;default:b.getdragBarActive()===!1&&(a.vals.restrictions.editItemSize&&d.shiftKey?(b.deleteEditArea(),c.moveBorder(f,c.this.tier),b.selectBoundry(),b.movingBoundary=!0,c.hists.updateCurChangeObj({type:"ESPS",action:"moveBoundary",tierName:c.this.tier.TierName,itemIdx:b.getcurMouseSegmentId(),movedBy:f}),p=q,c.$apply(),e=!1):a.vals.restrictions.editItemSize&&d.altKey?(b.deleteEditArea(),c.moveSegment(f,c.this.tier),p=q,b.selectBoundry(),c.hists.updateCurChangeObj({type:"ESPS",action:"moveSegment",tierName:c.this.tier.TierName,itemIdx:b.getselected().sort(),movedBy:f}),c.$apply()):b.movingBoundary=!1)}h(d,e)}),d.bind("mousedown",function(a){h(a,!0)}),d.bind("mouseup",function(a){h(a,!0)}),d.bind("mouseout",function(a){b.movingBoundary=!1,h(a,!0)})}}}]),angular.module("emulvcApp").directive("trackmouse",function(){return{restrict:"A",link:function(a,b){function c(b){d=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),d>e?(f=d,a.vs.select(e,f)):(e=d,a.vs.select(e,f)),a.$apply()}var d,e,f;b.bind("mousedown",function(b){e=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),f=e,a.vs.select(e,e),a.$apply()}),b.bind("mousemove",function(b){switch(b.which){case 1:a.vs.getdragBarActive()||c(b)}}),b.bind("mouseup",function(b){a.vs.getdragBarActive()||c(b)})}}}),angular.module("emulvcApp").directive("handleglobalkeystrokes",["viewState","Soundhandlerservice","ConfigProviderService","HistoryService",function(a,b,c,d){return{restrict:"A",link:function(e){$(document).bind("keydown",function(f){var g=f.keyCode?f.keyCode:f.which;e.$apply(function(){if(e.setlastkeycode(g,f.shiftKey),a.focusInTextField)g===c.vals.keyMappings.enter&&(a.focusInTextField=!1,$("#HandletiersCtrl").scope().renameLabel()),g===c.vals.keyMappings.esc&&(a.focusInTextField=!1,$("#HandletiersCtrl").scope().deleteEditArea()),13===g&&(f.preventDefault(),f.stopPropagation());else{if($("#HandletiersCtrl").scope().deleteEditArea(),g===c.vals.keyMappings.zoomAll&&(a.getPermission("zoom")?a.setViewPort(0,a.curViewPort.bufferLength):console.log("action currently not allowed")),g===c.vals.keyMappings.zoomIn&&(a.getPermission("zoom")?a.zoomViewPort(!0):console.log("action currently not allowed")),g===c.vals.keyMappings.zoomOut&&(a.getPermission("zoom")?a.zoomViewPort(!1):console.log("action currently not allowed")),g===c.vals.keyMappings.shiftViewPortLeft&&(a.getPermission("zoom")?a.shiftViewPort(!1):console.log("action currently not allowed")),g===c.vals.keyMappings.shiftViewPortRight&&(a.getPermission("zoom")?a.shiftViewPort(!0):console.log("action currently not allowed")),g===c.vals.keyMappings.zoomSel&&(a.getPermission("zoom")?a.setViewPort(a.curViewPort.selectS,a.curViewPort.selectE):console.log("action currently not allowed")),g===c.vals.keyMappings.playEntireFile&&(a.getPermission("zoom")?c.vals.restrictions.playback&&(b.playFromTo(0,b.wavJSO.Data.length),a.animatePlayHead(0,b.wavJSO.Data.length)):console.log("action currently not allowed")),g===c.vals.keyMappings.playAllInView&&(a.getPermission("zoom")?c.vals.restrictions.playback&&(b.playFromTo(a.curViewPort.sS,a.curViewPort.eS),a.animatePlayHead(a.curViewPort.sS,a.curViewPort.eS)):console.log("action currently not allowed")),g===c.vals.keyMappings.playSelected&&(a.getPermission("zoom")?c.vals.restrictions.playback&&(b.playFromTo(a.curViewPort.selectS,a.curViewPort.selectE),a.animatePlayHead(a.curViewPort.selectS,a.curViewPort.selectE)):console.log("action currently not allowed")),g===c.vals.keyMappings.selectFirstContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=1),g===c.vals.keyMappings.selectSecondContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=2),g===c.vals.keyMappings.selectThirdContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=3),g===c.vals.keyMappings.selectFourthContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=4),g===c.vals.keyMappings.selectNoContourCorrectionTool&&c.vals.restrictions.correctionTool&&(a.curCorrectionToolNr=void 0),g===c.vals.keyMappings.tierUp&&$("#HandletiersCtrl").scope().selectTier(!1),g===c.vals.keyMappings.tierDown&&$("#HandletiersCtrl").scope().selectTier(!0),g===c.vals.keyMappings.snapBoundaryToTop&&c.vals.restrictions.editItemSize&&$("#HandletiersCtrl").scope().snapBoundary(!0),g===c.vals.keyMappings.snapBoundaryToBottom&&c.vals.restrictions.editItemSize&&$("#HandletiersCtrl").scope().snapBoundary(!1),g===c.vals.keyMappings.plus&&c.vals.restrictions.editItemSize&&($("#HandletiersCtrl").scope().expandSegment(!0,!0),e.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",tierName:a.getcurClickTierName(),itemIdx:a.getselected().sort(),expand:!0,rightSide:!0})),g===c.vals.keyMappings.plusShift&&c.vals.restrictions.editItemSize&&($("#HandletiersCtrl").scope().expandSegment(!0,!1),e.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",tierName:a.getcurClickTierName(),itemIdx:a.getselected().sort(),expand:!0,rightSide:!1})),g===c.vals.keyMappings.minus&&c.vals.restrictions.editItemSize&&(f.shiftKey?($("#HandletiersCtrl").scope().expandSegment(!1,!1),e.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",tierName:a.getcurClickTierName(),itemIdx:a.getselected().sort(),expand:!1,rightSide:!1})):($("#HandletiersCtrl").scope().expandSegment(!1,!0),e.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",tierName:a.getcurClickTierName(),itemIdx:a.getselected().sort(),expand:!1,rightSide:!0}))),g===c.vals.keyMappings.openSubmenu&&e.openSubmenu(),g===c.vals.keyMappings.spectroSettings&&e.openModal("views/spectroSettings.html","dialog"),g===c.vals.keyMappings.selectSegmentsInSelection&&$("#HandletiersCtrl").scope().selectSegmentsInSelection(),g===c.vals.keyMappings.tab&&(f.shiftKey?$("#HandletiersCtrl").scope().tabNext(!0):$("#HandletiersCtrl").scope().tabNext(!1)),g===c.vals.keyMappings.history&&(f.shiftKey?d.redo():d.undo()),g===c.vals.keyMappings.backspace)if(f.shiftKey){if(c.vals.restrictions.deleteItem){var h=a.getcurClickSegments();if(void 0!==h){for(var i="",j=0;j<h.length;j++)i+=h[j].label+",";i=i.substring(0,i.length-1),console.log(i),"seg"===a.getcurClickTierType()?$("#HandletiersCtrl").scope().deleteSegments():e.dials.open("views/error.html","ErrormodalCtrl","Delete Error: You can not delete Segments on Point Tiers.")}}}else if(c.vals.restrictions.deleteItem){var h=a.getcurMouseSegment();console.log(h);var k=a.getcurMouseTierName();void 0!==h?(e.hists.addObjToUndoStack({type:"ESPS",action:"deleteBoundary",tierName:k,seg:h}),$("#HandletiersCtrl").scope().deleteBoundary()):e.dials.open("views/error.html","ErrormodalCtrl","Delete Error: Please select a Boundary first.")}f.metaKey||(f.preventDefault(),f.stopPropagation())}})}),e.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emulvcApp").directive("delete",function(){return{restrict:"A",link:function(a,b){var c=a.this.tier.TierName;b.bind("click",function(){a.vs.setcurClickTierName(c),a.openModal("views/deleteTier.html","dialogSmall",!0,c,c)})}}}),angular.module("emulvcApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=c.find("canvas"),e=b.parent().children()[0],f=b.parent().children()[2],g=c.find(e),h=c.find(f),i=!0,j="Tier",k="smallTier",l="TierCanvas",m="TierMarkupCanvas",n="smallCanvas";b.bind("click",function(){i?(i=!1,c.parent().parent()[0].className=k+" ng-scope",d[0].className=l+" "+n,d[1].className=m+" "+n,a.config.vals.activeButtons.deleteSingleTier&&g.hide(),a.config.vals.activeButtons.saveSingleTier&&h.hide()):(i=!0,c.parent().parent()[0].className=j+" ng-scope",d[0].className=l,d[1].className=m,a.config.vals.activeButtons.deleteSingleTier&&g.show(),a.config.vals.activeButtons.saveSingleTier&&h.show()),a.updateView()})}}}),angular.module("emulvcApp").directive("previewtrack",function(){return{restrict:"A",link:function(a,b){function c(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var d=-1;b.bind("click",function(b){if(!$.isEmptyObject(a.shs.wavJSO)){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}),b.bind("mousedown",function(b){$.isEmptyObject(a.shs.wavJSO)||(d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width))}),b.bind("mousemove",function(b){switch(event.which){case 1:if(-1!==d){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}}),b.bind("mouseup",function(){d=-1}),b.bind("mouseout",function(){d=-1})}}}),angular.module("emulvcApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","Httphandler","Appcachehandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q={};return q.wsH=n,p.checkForNewVersion(),q.getUttList=function(a){var b;return"http:GET"===k.vals.main.comMode?b=o.getUttList(a):"ws"===k.vals.main.comMode&&alert("handle ws case for get utt list"),b},q.getUsrUttList=function(a){var b;return"http:GET"===k.vals.main.comMode?alert("handle ws case for get utt list"):"ws"===k.vals.main.comMode&&(b=n.getUsrUttList(a)),b},q.getUtt=function(a){var b;return"http:GET"===k.vals.main.comMode?b=o.getUtt(a):"ws"===k.vals.main.comMode&&(b=n.getUtt(a)),b},q.getProtocol=function(){var a;return"http:GET"===k.vals.main.comMode?alert("http:GET version of getProtocol not implemented"):"ws"===k.vals.main.comMode&&(a=n.getProtocol()),a},q.getConfigFile=function(){var a;return"http:GET"===k.vals.main.comMode?alert("http:GET version of getProtocol not implemented"):"ws"===k.vals.main.comMode&&(a=n.getConfigFile()),a},q.getDoUserManagement=function(){var a;return"http:GET"===k.vals.main.comMode?alert("http:GET version of getProtocol not implemented"):"ws"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},q.saveUtt=function(a){var b;return"http:GET"===k.vals.main.comMode?alert("http:GET version of saveUtt not implemented"):"ws"===k.vals.main.comMode&&(b=n.saveUtt(a)),b
},q.toTextGrid=function(a){return j.toTextGrid(a)},q}]),angular.module("emulvcApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,c){var d=this.wavJSO.BitsPerSample/8,e=this.wavJSO.origArrBuf.subarray(0,44),f=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*d),g=new DataView(e);g.setUint32(40,(c-a)*d,!0);var h=f.subarray(a*d,(c-a)*d),i=new Uint8Array(e.byteLength+h.byteLength);i.set(new Uint8Array(e),0),i.set(new Uint8Array(h),e.byteLength);var j=b.arrayBufferToBase64(i.buffer);this.player.src="data:audio/wav;base64,"+j},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emulvcApp").directive("drawssff",function(){return{restrict:"A",link:function(a,b){function c(){if($.isEmptyObject(a.ssffds.data)){var b=f.getContext("2d");b.clearRect(0,0,f.width,f.height)}else if(0!==a.ssffds.data.length){var c=a.config.vals.signalsCanvasConfig.assign.spec.split(":"),g=c[1],h=d(a.ssffds.data,g);e(a.vs,f,a.config,h)}}function d(a,b){var c;return a.forEach(function(a){a.Columns.forEach(function(d){d.name===b&&(c=d,c.sampleRate=a.sampleRate,c.startTime=a.startTime)})}),c}function e(b,c,d,e){var f=c.getContext("2d");f.clearRect(0,0,c.width,c.height);var g=b.spectroSettings.rangeFrom,h=b.spectroSettings.rangeTo,i=b.getViewPortStartTime(),j=b.getViewPortEndTime(),k=Math.round(i*e.sampleRate+e.startTime),l=Math.round(j*e.sampleRate+e.startTime),m=l-k,n=e.values.slice(k,k+m);if(m<c.width&&m>=2){var o,p,q,r,s,t;n.forEach(function(d,m){d.forEach(function(u,v){if(v>=a.config.vals.signalsCanvasConfig.contourLims.fm.min&&v<=a.config.vals.signalsCanvasConfig.contourLims.fm.max)if(s=k+m,t=1/e.sampleRate*s+e.startTime,o=(t-i)/(j-i)*c.width,p=c.height-(u-g)/(h-g)*c.height,m===b.curPreselColumnSample&&b.curCorrectionToolNr-1===v?(f.strokeStyle="white",f.fillStyle="white"):(f.strokeStyle="hsl("+v*(360/d.length)+",80%, 50%)",f.fillStyle="hsl("+v*(360/d.length)+",80%, 50%)"),f.beginPath(),f.arc(o,p-1,2,0,2*Math.PI,!1),f.closePath(),f.stroke(),f.fill(),0!==m){if(s=k+m-1,t=1/e.sampleRate*s+e.startTime,q=(t-i)/(j-i)*c.width,r=c.height-(n[m-1][v]-g)/(h-g)*c.height,b.curCorrectionToolNr-1===v&&(f.strokeStyle="white",f.fillStyle="white"),f.beginPath(),f.moveTo(q,r),f.lineTo(o,p),f.stroke(),f.fill(),m===n.length-1&&l!==e.values.length-1){var w=e.values[l+1];u=w[v],s=l+1,t=1/e.sampleRate*s+e.startTime;var x=(t-i)/(j-i)*c.width,y=c.height-(u-g)/(h-g)*c.height;f.beginPath(),f.moveTo(o,p),f.lineTo(x,y),f.stroke(),f.fill()}}else if(0!==k){var z=e.values[k-1];u=z[v],s=k-1,t=1/e.sampleRate*s+e.startTime,q=(t-i)/(j-i)*c.width,r=c.height-(u-g)/(h-g)*c.height,b.curCorrectionToolNr-1===v&&(f.strokeStyle="white",f.fillStyle="white"),f.beginPath(),f.moveTo(q,r),f.lineTo(o,p),f.stroke(),f.fill()}})})}else{f.strokeStyle="red";var u,v;2>=m?(u="Zoom out to see contour(s)",v=f.measureText(u).width,f.strokeText(u,c.width/2-v/2,c.height/2)):(u="Zoom in to see contour(s)",v=f.measureText(u).width,f.strokeText(u,c.width/2-v/2,c.height/2))}}var f=b[0];a.$watch("vs.curViewPort",function(a,b){c(a,b)},!0),a.$watch("vs.curPreselColumnSample",function(a,b){c(a,b)},!0),a.$watch("vs.curCorrectionToolNr",function(a,b){c(a,b)},!0),a.$watch("ssffds.data",function(a,b){c(a,b)},!0),a.$watch("viewState.spectroSettings",function(a,b){c(a,b)},!0)}}}),angular.module("emulvcApp").service("Ssffparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.ssff2jso=function(a){var c=this;b.ssffData.Columns=[];var d=new Uint8Array(a),e=String.fromCharCode.apply(null,d),f=e.split(/^/m);(f[0]!==c.headID||f[1]!==c.machineID)&&alert("no ssff file... or missing fields"),"Record_Freq "!==f[2].split(/[ ,]+/)[0]||"Start_Time "!==f[3].split(/[ ,]+/)[0]?(this.ssffData.sampleRate=parseFloat(f[2].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,"")),this.ssffData.startTime=parseFloat(f[3].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))):alert("no ssff file... or missing fields ");for(var g=4;g<f.length&&("Original_Freq"===f[g].split(/[ ,]+/)[0]&&(this.ssffData.origFreq=parseFloat(f[g].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),f[g]!==this.sepString);g++){var h=f[g].split(/[ ]+/);"Column"===h[0]&&this.ssffData.Columns.push({name:h[1],ssffdatatype:h[2],length:parseInt(h[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[]})}for(var i,j,k,l=f.slice(0,g+1).join("").length;l<=d.length;)for(g=0;g<this.ssffData.Columns.length;g++)"DOUBLE"===this.ssffData.Columns[g].ssffdatatype?(k=8*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Float64Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):"FLOAT"===this.ssffData.Columns[g].ssffdatatype?(k=4*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Float32Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):"SHORT"===this.ssffData.Columns[g].ssffdatatype?(k=2*this.ssffData.Columns[g].length,j=a.subarray(l,k),i=new Uint16Array(j),this.ssffData.Columns[g].values.push(Array.prototype.slice.call(i)),l+=k):alert("not supported... only doubles, floats, short  column types and for now");return this.ssffData},b.jso2ssff=function(a){var b=this,c=this.headID+this.machineID;c+="Record_Freq "+this.vs.round(a.sampleRate,1)+"\n",c+="Start_Time "+a.startTime+"\n",a.Columns.forEach(function(a){c+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),c+="Original_Freq DOUBLE "+this.vs.round(a.origFreq,1)+"\n",c+=this.sepString;var d,e,f=new Uint8Array(this.stringToUint(c));return d=new Uint16Array(a.Columns[0].length),e=a.Columns[0].values[0],a.Columns[0].values.forEach(function(c,e){a.Columns.forEach(function(a){if("SHORT"!==a.ssffdatatype)return alert("Only SHORT columns supported for now!!!"),void 0;d=new Uint16Array(a.length),a.values[e].forEach(function(a,b){d[b]=a});var c=new Uint8Array(d.buffer);f=b.Uint8Concat(f,c)})}),f.buffer},b.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},b.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},b}]),angular.module("emulvcApp").directive("correctiontool",function(){return{restrict:"A",link:function(a,b){b.bind("mousemove",function(b){if(void 0!==a.vs.curCorrectionToolNr){var c=a.ssffds.data[0].Columns[0],d=a.vs.getViewPortStartTime(),e=a.vs.getViewPortEndTime(),f=Math.round(d*c.sampleRate+c.startTime),g=Math.round(e*c.sampleRate+c.startTime),h=g-f,i=c.values.slice(f,f+h),j=d+a.dhs.getX(b)/b.originalEvent.srcElement.width*(e-d),k=Math.round((j+c.startTime)*c.sampleRate);if(a.vs.curPreselColumnSample=k-f-1,b.shiftKey){var l=angular.copy(i[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]),m=a.vs.spectroSettings.rangeTo-a.dhs.getY(b)/b.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo;i[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]=a.vs.spectroSettings.rangeTo-a.dhs.getY(b)/b.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo,a.hists.updateCurChangeObj({type:"SSFF",ssffIdx:0,colIdx:0,sampleBlockIdx:f+a.vs.curPreselColumnSample,sampleIdx:a.vs.curCorrectionToolNr-1,oldValue:l,newValue:m})}a.$apply()}})}}}),angular.module("emulvcApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService",function(a,b,c,d){function e(a,b,c){return a.measureText(b).width*c}function f(a,b,c,d){return b.toString().length>c.toString().length?e(a,b,d):e(a,c,d)}function g(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=a.curViewPort.eS-a.curViewPort.sS,j=a.curCursorPosInPercent*a.bufferLength-a.curViewPort.sS,k=j/i,l=f.width*k,m=1,n=Math.round(c*(f.height/d)),o=b*m,p=Math.round((f.height-n)/2),q=Math.round(e*(f.height/d)),r=(b-1)*m,s=Math.round((f.height-q)/2);l>=o?(h.fillStyle=g.vals.colors.playProgressColor,h.strokeStyle=g.vals.colors.playProgressColor):(h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor),h.beginPath(),h.moveTo(r,s),h.lineTo(o,p),h.stroke()}var h={};return h.osciPeaks=[],h.getX=function(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)},h.getY=function(a){return a.offsetY*(a.originalEvent.srcElement.height/a.originalEvent.srcElement.clientHeight)},h.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=-1/0,o=0,p=0,q=m.length;q>p;p++)m[p]>n&&(n=m[p]),o+=m[p];k+=o/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},h.freshRedrawDrawOsciOnCanvas=function(a,b,c,d,e){var f=b.getContext("2d");if(f.clearRect(0,0,b.width,b.height),c.peaks&&c.samplePerPx>=1)c.peaks.forEach(function(d,f){0!==f&&g(a,f,d,c.maxPeak,c.peaks[f-1],b,e)});else if(c.samplePerPx<1){var h=1/c.samplePerPx/2,i=a.curViewPort.sS;f.strokeStyle=e.vals.colors.osciColor,f.fillStyle=e.vals.colors.osciColor;var j;if(0===a.curViewPort.sS){for(f.moveTo(h,(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=0;j<c.peaks.length;j++)f.lineTo(j/c.samplePerPx+h,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height);for(f.stroke(),j=0;j<c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx+h,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.strokeText(i,j/c.samplePerPx+h,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}else{for(f.beginPath(),f.moveTo(-h,b.height-(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=1;j<=c.peaks.length;j++)f.lineTo(j/c.samplePerPx-h,b.height-((c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height+3));for(f.stroke(),j=1;j<=c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx-h,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.fillText(i,j/c.samplePerPx-h,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}}if(e.vals.restrictions.drawZeroLine){if(f.strokeStyle=e.vals.colors.zeroLineColor,f.fillStyle=e.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&f.setLineDash([2]),c.samplePerPx>=1)f.beginPath(),f.moveTo(0,b.height/2),f.lineTo(b.width,b.height/2),f.stroke(),f.fillText("0",5,b.height/2-5,b.width);else{var k=b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height;f.beginPath(),f.moveTo(0,k),f.lineTo(b.width,k),f.stroke(),f.fill(),f.fillText("0",5,b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-5,b.width)}"Google Inc."===navigator.vendor&&f.setLineDash([0])}},h.drawMovingBoundaryLine=function(c){var d,e;if(e=a.getSampleDist(c.canvas.width),d="seg"===a.getcurMouseTierType()?0:e/2,a.movingBoundary){c.fillStyle=b.vals.colors.selectedBoundaryColor;var f=a.getcurMouseTierDetails(),g=Math.round(a.getPos(c.canvas.width,f.events[a.getcurMouseSegmentId()].startSample));c.fillRect(g+d,0,1,c.canvas.height)}},h.drawCurViewPortSelected=function(g,h){var i,j;j=a.getSampleDist(g.canvas.width),i="seg"===a.getcurMouseTierType()?0:j/2;var k=a.getPos(g.canvas.width,a.curViewPort.selectS),l=a.getPos(g.canvas.width,a.curViewPort.selectE);if(k===l)g.fillStyle=b.vals.colors.selectedBorderColor,g.fillRect(k+i,0,1,g.canvas.height);else if(g.fillStyle=b.vals.colors.selectedAreaColor,g.fillRect(k,0,l-k,g.canvas.height),g.strokeStyle=b.vals.colors.selectedBorderColor,g.beginPath(),g.moveTo(k,0),g.lineTo(k,g.canvas.height),g.moveTo(l,0),g.lineTo(l,g.canvas.height),g.closePath(),g.stroke(),h){var m=g.canvas.width/g.canvas.offsetWidth,n=f(g,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),o=d.getTextImageTwoLines(g,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1);if(g.drawImage(o,0,0,o.width,o.height,k-n-5,0,o.width,o.height),o=d.getTextImageTwoLines(g,a.curViewPort.selectE,a.round(a.curViewPort.selectE/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),g.drawImage(o,0,0,o.width,o.height,l+5,0,o.width,o.height),n=e(g,a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),l-k>n){var p=a.curViewPort.selectE-a.curViewPort.selectS,q=a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);n=f(g,p,q,m),o=d.getTextImageTwoLines(g,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),g.drawImage(o,0,0,o.width,o.height,k+(l-k)/2-n/2,0,o.width,o.height)}}},h}]),angular.module("emulvcApp").service("HistoryService",["viewState","Ssffdataservice","Tierdataservice",function(a,b,c){function d(c,d){Object.keys(c).forEach(function(e){console.log(e);var f=c[e];if("SSFF"===f.type)b.data[f.ssffIdx].Columns[f.colIdx].values[f.sampleBlockIdx][f.sampleIdx]=d?f.oldValue:f.newValue;else if("ESPS"===f.type)switch(console.log("###UNDOING esps change"),f.action){case"moveBoundary":case"moveSegment":d?"moveBoundary"===f.action?$("#HandletiersCtrl").scope().moveBorder(-f.movedBy,a.getTierDetails(f.tierName),f.itemIdx):$("#HandletiersCtrl").scope().moveSegment(-f.movedBy,a.getTierDetails(f.tierName),f.itemIdx):"moveBoundary"===f.action?$("#HandletiersCtrl").scope().moveBorder(f.movedBy,a.getTierDetails(f.tierName),f.itemIdx):$("#HandletiersCtrl").scope().moveSegment(f.movedBy,a.getTierDetails(f.tierName),f.itemIdx);break;case"renameLabel":d?$("#HandletiersCtrl").scope().rename(f.tierName,f.itemIdx,f.oldValue):$("#HandletiersCtrl").scope().rename(f.tierName,f.itemIdx,f.newValue);break;case"deleteBoundary":d?alert(f):alert("todo...");break;case"expandSegments":d?$("#HandletiersCtrl").scope().expandSegment(!f.expand,f.rightSide,f.itemIdx,f.tierName):$("#HandletiersCtrl").scope().expandSegment(f.expand,f.rightSide,f.itemIdx,f.tierName)}})}var e={};e.myHistory=[],e.myHistoryCounter=0,e.session=void 0,e.init=function(){e.history()},e.history=function(){var a=angular.copy({ssff:b.getData(),tier:c.getData()});if(e.myHistoryCounter>0){var d=angular.copy(e.myHistory[e.myHistoryCounter-1]);angular.equals(a,d)===!1&&(e.myHistory[e.myHistoryCounter]=a,++e.myHistoryCounter)}else e.myHistory[e.myHistoryCounter]=a,++e.myHistoryCounter},e.goBackHistory=function(){return e.myHistoryCounter>1?(b.setData(e.myHistory[e.myHistoryCounter-2].ssff),c.setData(e.myHistory[e.myHistoryCounter-2].tier),--e.myHistoryCounter,!0):!1};var f=[],g=[],h={};return e.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.ssffIdx)+"#"+String(a.colIdx)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),h[b]?(console.log("here"+h[b].oldValue),a.oldValue=h[b].oldValue,h[b]=a):h[b]=a;else if("ESPS"===a.type)switch(a.action){case"moveBoundary":case"moveSegment":b=String(a.type+"#"+a.action+"#"+a.tierName+"#"+a.itemIdx),console.log(b),h[b]?(a.movedBy+=h[b].movedBy,h[b]=a):h[b]=a}},e.addCurChangeObjToUndoStack=function(){g=[],$.isEmptyObject(h)||f.push(h),h={}},e.addObjToUndoStack=function(a){g=[];var b={};b[String(a.type)+"#"+String(a.ssffIdx)+"#"+String(a.itemIdx)]=a,$.isEmptyObject(b)||f.push(b),h={},console.log(f)},e.undo=function(){if(f.length>0){var a=angular.copy(f[f.length-1]);g.push(a),d(a,!0),f.pop()}},e.redo=function(){if(g.length>0){var a=angular.copy(g[g.length-1]);f.push(a),d(a,!1),g.pop()}},e.getNrOfPosibleUndos=function(){return f.length},e}]),angular.module("emulvcApp").service("Wavparserservice",["viewState",function(a){var b={};return b.vs=a,b.ssffData={},b.headID="SSFF -- (c) SHLRC\n",b.machineID="Machine IBM-PC\n",b.sepString="-----------------\n",b.ssffData.fileURL="",b.ssffData.sampleRate=-1,b.ssffData.startTime=-1,b.ssffData.origFreq=-1,b.ssffData.Columns=[],b.wav2jso=function(a){var b,c,d,e={};return b=0,c=a.subarray(b,4),d=new Uint8Array(c),e.ChunkID=String.fromCharCode.apply(null,d),"RIFF"!==e.ChunkID&&console.error("Wav read error: ChunkID not RIFF. Got "+e.ChunkID),b=4,c=a.subarray(b,4),d=new Uint32Array(c),e.ChunkSize=d[0],b=8,c=a.subarray(b,4),d=new Uint8Array(c),e.Format=String.fromCharCode.apply(null,d),"WAVE"!==e.Format&&console.error("Wav read error: Format not WAVE. Got "+e.Format),b=12,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk1ID=String.fromCharCode.apply(null,d),"fmt "!==e.Subchunk1ID&&console.error("Wav read error: Subchunk1ID not fmt. Got "+e.Subchunk1ID),b=16,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk1Size=d[0],16!==e.Subchunk1Size&&console.error("Wav read error: Subchunk1Size not 16"),b=20,c=a.subarray(b,2),d=new Uint16Array(c),e.AudioFormat=d[0],1!==e.AudioFormat&&console.error("Wav read error: AudioFormat not 1"),b=22,c=a.subarray(b,2),d=new Uint16Array(c),e.NumChannels=d[0],1!==e.NumChannels&&console.error("Wav read error: NumChannels not 1"),b=24,c=a.subarray(b,4),d=new Uint32Array(c),e.SampleRate=d[0],b=28,c=a.subarray(b,4),d=new Uint32Array(c),e.ByteRate=d[0],b=32,c=a.subarray(b,2),d=new Uint16Array(c),e.BlockAlign=d[0],b=34,c=a.subarray(b,2),d=new Uint16Array(c),e.BitsPerSample=d[0],16!==e.BitsPerSample&&console.error("Wav read error: NumChannels not 1"),b=36,c=a.subarray(b,4),d=new Uint8Array(c),e.Subchunk2ID=String.fromCharCode.apply(null,d),"data"!==e.Subchunk2ID&&console.error("Wav read error: BitsPerSample not 16"),b=40,c=a.subarray(b,4),d=new Uint32Array(c),e.Subchunk2Size=d[0],b=44,c=a.subarray(b,e.Subchunk2Size),d=new Int16Array(c),e.Data=d,e.origArrBuf=a,e},b}]),$(function(){function a(a){var b=a.pageY,c=a.pageX,d=a.originalEvent.targetTouches;return d&&(c=d[0].pageX,b=d[0].pageY),{x:c,y:b}}function b(a,b,d){return a.each(function(){var a=$(this),e=b?$(b,this).css("cursor",d):a;e.bind(g,{e:a,k:d},c)})}function c(b){var c=a(b),g=function(a){return parseInt(f.css(a),10)||!1};return f=b.data.e,j={X:g("left")||0,Y:g("top")||0,H:g("height")||f[0].scrollHeight||0,pX:c.x,pY:c.y,k:b.data.k},$(".MainCtrl").scope().dragStart(),$(document).bind(h,d).bind(i,e),k=$(document).height()-2*$(".menu-bottom").height(),!1}function d(b){var c=a(b),d=Math.max(c.y-j.pY+j.H,0);return k>d&&(f.css({height:d}),$(".MainCtrl").scope().refreshTimeline(),$(".HandletiersCtrl").css("padding-top",$(".TimelineCtrl").height()+2*$(".menu").height()+"px")),!1}function e(){$(".MainCtrl").scope().dragEnd(),$(document).unbind(h,d).unbind(i,e)}var f,g="mousedown touchstart",h="mousemove touchmove",i="mouseup touchend",j={},k=0;$.fn.ownResize=function(a){return b(this,a,"ns-resize")}}),angular.module("emulvcApp").service("Textgridparserservice",["Soundhandlerservice","viewState",function(a,b){var c={};return c.shs=a,c.l1='File type = "ooTextFile"',c.l2='Object class = "TextGrid"',c.toJSO=function(a){a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g,"");var b,c,d,e,f=a.split("\n"),g=!0,h={origSamplerate:this.shs.wavJSO.SampleRate,fileURI:"",tiers:[]};if(f[0].replace(/\s+/g,"")===this.l1.replace(/\s+/g,"")&&f[1].replace(/\s+/g,"")===this.l2.replace(/\s+/g,"")){for(var i=2;i<f.length;i++){var j=f[i];if("item[]:"!==j){if(!g)if(0===j.indexOf("item[")&&(b='"IntervalTier"'===f[i+1].split(/=/)[1]?"seg":"point",c=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers.push({TierName:c,type:b,events:[]})),h.tiers.length>0&&"seg"===h.tiers[h.tiers.length-1].type&&0===j.indexOf("intervals")&&0!==j.indexOf("intervals:")){var k=Math.ceil(f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate),l=Math.floor(f[i+2].split(/=/)[1]*this.shs.wavJSO.SampleRate);e=f[i+3].split(/=/)[1].replace(/"/g,""),0===k&&(k+=1),h.tiers[h.tiers.length-1].events.push({label:e,startSample:k-1,sampleDur:l-k})}else h.tiers.length>0&&"point"===h.tiers[h.tiers.length-1].type&&0===j.indexOf("points")&&0!==j.indexOf("points:")&&(d=f[i+1].split(/=/)[1]*this.shs.wavJSO.SampleRate,e=f[i+2].split(/=/)[1].replace(/"/g,""),h.tiers[h.tiers.length-1].events.push({label:e,startSample:Math.round(d)}))}else g=!1}return this.testForGapsInLabelJSO(h),h}alert("bad header in TextGrid file!!! The header has to be: ",this.l1,"\n",this.l2)},c.toTextGrid=function(){var b='File type = "ooTextFile"',d='Object class = "TextGrid"',e="",f="\n",g="	";e=e+b+f+d+f+f,e=e+"xmin = "+c.findTimeOfMinSample()+f,e=e+"xmax = "+c.findTimeOfMaxSample()+f,e=e+"tiers? <exists>"+f,e=e+"size = "+$("#HandletiersCtrl").scope().getTierLength()+f,e=e+"item []:"+f;var h=0;return $("#HandletiersCtrl tier").each(function(){var b=$("#HandletiersCtrl").scope().getTier($(this).attr("id"));h+=1,e=e+g+"item ["+h+"]:"+f,"seg"===b.type?e=e+g+g+'class = "IntervalTier"'+f:"point"===b.type&&(e=e+g+g+'class = "TextTier"'+f),e=e+g+g+'name = "'+b.TierName+'"'+f,e=e+g+g+"xmin = "+c.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+c.findTimeOfMaxSample()+f,"seg"===b.type?e=e+g+g+"intervals: size = "+b.events.length+f:"point"===b.type&&(e=e+g+g+"points: size = "+b.events.length+f);for(var d=0;d<b.events.length;d++){var i=d+1;"seg"===b.type?(e=e+g+g+g+"intervals ["+i+"]:"+f,e=0!==b.events[d].startSample?e+g+g+g+g+"xmin = "+(b.events[d].startSample/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmin = 0"+f,e=d<b.events.length-1?e+g+g+g+g+"xmax = "+((b.events[d].startSample+b.events[d].sampleDur+1)/a.wavJSO.SampleRate+1/a.wavJSO.SampleRate/2)+f:e+g+g+g+g+"xmax = "+c.findTimeOfMaxSample()+f,e=e+g+g+g+g+'text = "'+b.events[d].label+'"'+f):"point"===b.type&&(e=e+g+g+g+"points["+i+"]:"+f,e=e+g+g+g+g+"time = "+b.events[d].startSample/a.wavJSO.SampleRate+f,e=e+g+g+g+g+'mark = "'+b.events[d].label+'"'+f)}}),e},c.findTimeOfMinSample=function(){return 0},c.findTimeOfMaxSample=function(){return b.curViewPort.bufferLength/a.wavJSO.SampleRate},c.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.tiers.length;c++)if("seg"===a.tiers[c].type)for(var d=0;d<a.tiers[c].events.length-1;d++)a.tiers[c].events[d].startSample+a.tiers[c].events[d].sampleDur+1!==a.tiers[c].events[d+1].startSample&&(b+=1)},c}]),angular.module("emulvcApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emulvcApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=5,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth,i=document.createElement("canvas"),j=i.getContext("2d");return j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth,k=document.createElement("canvas"),l=k.getContext("2d");if(l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return k},a}),angular.module("emulvcApp").directive("draggable",["$rootScope","uuid",function(a,b){return{restrict:"A",link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragstart",function(b){b.originalEvent.dataTransfer.setData("text",e),angular.element(d).addClass("dragDragging"),a.$emit("dragStart")}),d.bind("dragend",function(){angular.element(d).removeClass("dragDragging"),a.$emit("dragEnd")})}}}]),angular.module("emulvcApp").directive("dropable",["$rootScope","uuid",function(a,b){return{restrict:"A",scope:{onDrop:"&"},link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move",!1}),d.bind("dragenter",function(a){angular.element(a.target).addClass("dragOver")}),d.bind("dragleave",function(a){angular.element(a.target).removeClass("dragOver")}),d.bind("drop",function(a){a.preventDefault&&a.preventDefault(),a.stopPropogation&&a.stopPropogation();var b=a.originalEvent.dataTransfer.getData("text"),d=document.getElementById(e),f=document.getElementById(b);angular.element(a.target).removeClass("dragTarget"),angular.element(a.target).removeClass("dragOver"),c.drop(f,d)}),a.$on("dragStart",function(){var a=document.getElementById(e);angular.element(a).addClass("dragTarget")}),a.$on("dragEnd",function(){var a=document.getElementById(e);angular.element(a).removeClass("dragTarget"),angular.element(a).removeClass("dragOver")})}}}]),angular.module("emulvcApp").service("Espsparserservice",["Soundhandlerservice",function(a){var b={};return b.toJSO=function(b,c){var d="_"+c.split(".")[c.split(".").length-1];b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/[ \t]+/g," ");for(var e,f=b.split("\n"),g=0;g<f.length;g++)if("#"===f[g]){e=g;break}var h={fileInfos:[{fileURI:c,fileType:"esps",associatedTierNames:[d]}],tiers:[]};h.tiers.push({TierName:d,type:"",events:[]});var i,j=f[e+1].split(/\s+/);if(h.tiers[0].type="H#"!==j[j.length-1]?"point":"seg","point"===h.tiers[0].type)for(g=e+1;g<f.length-1;g++)j=f[g].split(/\s+/),h.tiers[0].events.push({label:j[j.length-1],startSample:Math.round(j[1]*a.wavJSO.SampleRate)});else for(j=f[e+1].split(/\s+/),h.tiers[0].events.push({label:"",startSample:0,sampleDur:Math.round(j[1]*a.wavJSO.SampleRate)}),g=e+2;g<f.length-1;g++)j=f[g].split(/\s+/),i=f[g-1].split(/\s+/),h.tiers[0].events.push({label:j[j.length-1],startSample:Math.round(i[1]*a.wavJSO.SampleRate),sampleDur:Math.round((j[1]-i[1])*a.wavJSO.SampleRate)});return h},b.toESPS=function(b){var c=b.TierName.substring(1),d="";d+="signal "+c+"\n",d+="nfields 1\n",d+="#\n";var e;return b.events.forEach(function(b,c){e=""===b.label&&0===c?"H#":b.label,d+="	"+String((b.startSample+b.sampleDur)/a.wavJSO.SampleRate)+"	125	"+e+"\n"}),d},b}]),angular.module("emulvcApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e,f,g){a.loginData={username:"",accesscode:"",errorMsg:""},a.tryLogin=function(){e.wsH.checkAccessCode(a.loginData.accesscode).then(function(c){"CORRECT"===c?(console.log("u are the champion"),e.wsH.getUsrUttList(a.loginData.username).then(function(c){"USER NOT FOUND"===c?a.loginData.errorMsg=c:(a.loginData.errorMsg="USER FOUND",b.$broadcast("newUserLoggedOn",a.loginData.username),a.cancel())})):a.loginData.errorMsg="Error wrong access code!!"})},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1},a.cancel=function(){g.close()}}]),angular.module("emulvcApp").service("Ssffdataservice",function(){var a={};return a.data=[],a.getData=function(){return a.data},a.setData=function(b){angular.copy(b,a.data)},a.getDataOfFile=function(b){var c,d,e,f;return c=b.split("/"),e=c[c.length-1],a.data.forEach(function(a,b){c=a.fileURL.split("/"),d=c[c.length-1],d===e&&(f=b)}),a.data[f]},a}),angular.module("emulvcApp").service("Tierdataservice",function(){var a={};return a.data={},a.getData=function(){return a.data},a.setData=function(b){angular.copy(b,a.data)},a}),angular.module("emulvcApp").service("Websockethandler",["$q","$rootScope","$location","HistoryService","Ssffparserservice","Tierdataservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a,c){var d=k.toJSO(c,a);b.$broadcast("newlyLoadedLabelJson",d)}function q(a,c){var d=m.base64ToArrayBuffer(c),f=e.ssff2jso(d);f.fileURL=document.URL+a,b.$broadcast("newlyLoadedSSFFfile",f,a.replace(/^.*[\\\/]/,""))}function r(a){C=!0,b.$broadcast("connectedToWSserver"),b.$apply(B.resolve(a))}function s(a){w(JSON.parse(a.data))}function t(a){console.log("WEBSOCKET ERROR!!!!!"),b.$apply(B.resolve(a))}function u(){C=!1,console.log("WEBSOCKET closed!!!!!")}function v(b){var c=a.defer(),d=x();return z[d]={time:new Date,cb:c},b.callbackID=d,A.send(JSON.stringify(b)),c.promise}function w(a){var c=a;if(z.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":p(c.fileName,c.data);break;case"getSSFFfile":q(c.fileName,c.data)}b.$apply(z[c.callbackID].cb.resolve(c.data)),delete z[c.callbackID],h.curTaskPercCompl>=100?(h.curTaskPercCompl=0,o.close()):h.curTaskPercCompl+=1}}function x(){var a=l.new();return a}var y={},z={},A={},B={},C=!1;return y.initConnect=function(b){var c=a.defer();return A=new WebSocket(b),A.onopen=r,A.onmessage=s,A.onerror=t,A.onclose=u,B=c,c.promise},y.isConnected=function(){return C},y.closeConnect=function(){A.onclose=function(){},A.close()},y.getProtocol=function(){var a={type:"getProtocol"},b=v(a);return b},y.getDoUserManagement=function(){var a={type:"getDoUserManagement"},b=v(a);return b},y.getConfigFile=function(){var a={type:"getConfigFile"},b=v(a);return b},y.getUsrUttList=function(a){var b={type:"getUttList",usrName:a},c=v(b);return c},y.getSSFFfile=function(a){var b={type:"getSSFFfile",fileName:a},c=v(b);return c},y.getESPSfile=function(a){var b={type:"getESPSfile",fileName:a},c=v(b);return c},y.getAudioFile=function(a){var b={type:"getAudioFile",fileName:a},c=v(b);return c},y.checkAccessCode=function(a){var b={type:"checkAccessCode",data:a},c=v(b);return c},y.saveUsrUttList=function(a,b){var c=angular.toJson(b),d={type:"saveUttList",usrName:a,data:c},e=v(d);return e},y.saveSSFFfile=function(a){var b=n.getDataOfFile(a),d=e.jso2ssff(b),f=m.arrayBufferToBase64(d),g={type:"saveSSFFfile",fileURL:b.fileURL.split(c.absUrl())[1],data:f},h=v(g);return h},y.saveESPSfile=function(a){var b,c=f.getData();if(console.log(a),c.fileInfos.forEach(function(c){c.fileURI===a&&(b=c.associatedTierNames)}),1===b.length){var d;c.tiers.forEach(function(a){a.TierName===b[0]&&(d=a)});var e=k.toESPS(d);console.log(e);var g={type:"saveESPSfile",fileURL:a,data:e},h=v(g);return h}alert("more than one tier associated!!!! Not an ESPS file!!!")},y.getUtt=function(c){var d,e,f=[],k=a.defer();return e=y.findFileInUtt(c,g.vals.signalsCanvasConfig.extensions.audio),y.getAudioFile(e).then(function(a){var b=m.base64ToArrayBuffer(a);console.log(typeof b);var c=i.wav2jso(b);return c}).then(function(a){h.curViewPort.sS=0,h.curViewPort.eS=a.Data.length,h.curViewPort.bufferLength=a.Data.length,h.setscrollOpen(0),h.resetSelect(),j.wavJSO=a,b.$broadcast("cleanPreview")}).then(function(){g.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){e=y.findFileInUtt(c,a),d=y.getSSFFfile(e),f.push(d)}),g.vals.labelCanvasConfig.order.forEach(function(a){e=y.findFileInUtt(c,a),d=y.getESPSfile(e),f.push(d)})}),a.all(f).then(function(){k.resolve("finishedLoadingUtt")}),k.promise},y.saveUtt=function(b){var c,d,e=[],f=a.defer();return d=y.findFileInUtt(b,g.vals.signalsCanvasConfig.extensions.audio),g.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){d=y.findFileInUtt(b,a),c=y.saveSSFFfile(d),e.push(c)}),g.vals.labelCanvasConfig.order.forEach(function(a){d=y.findFileInUtt(b,a),c=y.saveESPSfile(d),e.push(c)}),a.all(e).then(function(){f.resolve("finishedSavingUtt")}),f.promise},y.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)
}),c},y}]),angular.module("emulvcApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e){a.wsServerUrl=b.vals.main.wsServerUrl,a.connectionError="",d.focusInTextField=!0,a.tryConnection=function(){console.log(a.wsServerUrl);var b=c.wsH.initConnect(a.wsServerUrl);b.then(function(b){"error"===b.type?a.connectionError="ERROR trying to connect to ws-server":"open"===b.type&&(d.focusInTextField=!1,a.cancel())})},a.cancel=function(){e.close()}}]),angular.module("emulvcApp").service("Httphandler",["$rootScope","$http","$q","HistoryService","viewState","ConfigProviderService","Soundhandlerservice","Ssffparserservice","Wavparserservice","Espsparserservice",function(a,b,c,d,e,f,g,h,i,j){var k={};return k.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},k.getUttList=function(a){var c=b.get(a);return c},k.getSSFFfile=function(c){b.get(c,{responseType:"arraybuffer"}).success(function(b){var d=h.ssff2jso(b);d.fileURL=document.URL+c,a.$broadcast("newlyLoadedSSFFfile",d,c.replace(/^.*[\\\/]/,""))})},k.getESPS=function(c){b.get(c).success(function(b){var d=j.toJSO(b,c);a.$broadcast("newlyLoadedLabelJson",d)}).error(function(a,b){console.log("Request failed with status: "+b)})},k.getUtt=function(h){var j,l,m=[],n=c.defer();return l=k.findFileInUtt(h,f.vals.signalsCanvasConfig.extensions.audio),b.get(l,{responseType:"arraybuffer"}).then(function(a){var b=i.wav2jso(a.data);return b}).then(function(b){e.curViewPort.sS=0,e.curViewPort.eS=b.Data.length,e.curViewPort.bufferLength=b.Data.length,e.setscrollOpen(0),e.resetSelect(),g.wavJSO=b,a.$broadcast("cleanPreview")}).then(function(){f.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){l=k.findFileInUtt(h,a),j=k.getSSFFfile(l),m.push(j)})}).then(function(){f.vals.labelCanvasConfig.order.forEach(function(a){l=k.findFileInUtt(h,a),console.log(l),j=k.getESPS(l),m.push(j)})}),c.all(m).then(function(){console.log("history"),d.history(),n.resolve("finishedLoadingUtt")}),n.promise},k}]),angular.module("emulvcApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a.stringToArrayBuffer=function(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d<a.length;++d)c[d]=a.charCodeAt(d);return b},a}),angular.module("emulvcApp").service("dialogService",["$modal","viewState",function(a,b){var c={},d={};return c.open=function(c,e,f){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{passedInTxt:function(){return f}}}),d.result},c.close=function(a){b.focusInTextField=!1,b.setState(b.prevState),d.close(a)},c}]),angular.module("emulvcApp").controller("WaitCtrl",["$scope","viewState",function(a,b){a.vs=b}]),angular.module("emulvcApp").service("Appcachehandler",["$http","dialogService",function(a,b){function c(){n.filesDownloaded=0,n.totalFiles=0,a.get("manifest.appcache").success(function(a){a=a.replace(new RegExp("(NETWORK|FALLBACK):((?!(NETWORK|FALLBACK|CACHE):)[\\w\\W]*)","gi"),""),a=a.replace(new RegExp("#[^\\r\\n]*(\\r\\n?|\\n)","g"),""),a=a.replace(new RegExp("CACHE MANIFEST\\s*|\\s*$","g"),""),a=a.replace(new RegExp("[\\r\\n]+","g"),"#");var b=a.split("#").length;n.totalFiles=b+1})}function d(a){console.log("###### handleCheckingEvent ##########"),console.log(a)}function e(a){console.log("###### handleNoupdateEvent ##########"),console.log(a)}function f(a){console.log("######## handleDownloadingEvent ##########"),console.log(a),c()}function g(a){console.log("###### handleProgressEvent ##########"),console.log(a)}function h(a){console.log("###### handleCachedEvent ##########"),console.log(a),b.open("views/confirmModal.html","ConfirmmodalCtrl","A new version of the EMU-WebApp is available and has already been downloaded! Would you like to use it (CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-WebApp you will automatically use the updated version)?").then(function(a){a&&window.location.reload()})}function i(a){console.log("###### handleUpdatereadyEvent ##########"),console.log(a)}function j(a){console.log("###### handleObsoleteEvent ##########"),console.log(a)}function k(a){console.log("###### handleErrorEvent ##########"),console.log(a)}var l={},m=window.applicationCache,n={filesDownloaded:0,totalFiles:0};return m.addEventListener("checking",d,!1),m.addEventListener("noupdate",e,!1),m.addEventListener("downloading",f,!1),m.addEventListener("progress",g,!1),m.addEventListener("cached",h,!1),m.addEventListener("updateready",i,!1),m.addEventListener("obsolete",j,!1),m.addEventListener("error",k,!1),l.checkForNewVersion=function(){console.log("check for new version")},l}]);var counter=0;window.addEventListener("load",function(){window.applicationCache.addEventListener("updateready",function(){console.log("counter:"+counter),$(".modal").css("display","none")},!1),window.applicationCache.addEventListener("progress",function(){counter+=1},!1),window.applicationCache.addEventListener("checking",function(){},!1)},!1),document.addEventListener("DOMContentLoaded",function(){console.log("DOM fully loaded and parsed"),console.log(document.getElementById("appcachemodal"))}),angular.module("emulvcApp").controller("AboutCtrl",["$scope","ConfigProviderService","dialogService",function(a,b,c){a.cps=b,a.getStrRep=function(a){return String.fromCharCode(a)},a.cancel=function(){c.close()}}]),angular.module("emulvcApp").controller("SpectsettingsCtrl",["$scope","dialogService","viewState",function(a,b,c){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],console.log(Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1]),a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowLength:a.vs.spectroSettings.windowLength,window:a.vs.spectroSettings.window},a.cursorInTextField=function(){c.focusInTextField=!0},a.cursorOutOfTextField=function(){c.focusInTextField=!1},a.saveSpectroSettings=function(){console.log(a.modalVals),console.log(a.selWindowInfo.name),c.setspectroSettings(a.modalVals.windowLength,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name),a.cancel()},a.cancel=function(){b.close()}}]),angular.module("emulvcApp").controller("ConfirmmodalCtrl",["$scope","dialogService","passedInTxt",function(a,b,c){a.passedInTxt=c,a.confirm=function(){b.close(!0)},a.cancel=function(){b.close(!1)}}]),angular.module("emulvcApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emulvcApp").controller("ErrormodalCtrl",["$scope","dialogService","passedInTxt",function(a,b,c){a.passedInTxt=c,a.cancel=function(){b.close()}}]);